<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>加固 | grand</title><meta name="author" content="grand"><meta name="copyright" content="grand"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="加固"><meta name="application-name" content="加固"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="加固"><meta property="og:url" content="http://bygeee.github.io/2025/09/20/%E5%8A%A0%E5%9B%BA/index.html"><meta property="og:site_name" content="grand"><meta property="og:description" content="加固加壳app的运行流程参考[原创]FART：ART环境下基于主动调用的自动化脱壳方案-Android安全-看雪-安全社区|安全招聘|kanxue.com BaseDexClassLoader.java - Android Code Search unpacker&amp;#x2F;android-7.1."><meta property="og:locale" content="zh-CN"><meta property="og:image" content="http://bygeee.github.io/pic/12.jpg"><meta property="article:author" content="grand"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://bygeee.github.io/pic/12.jpg"><meta name="description" content="加固加壳app的运行流程参考[原创]FART：ART环境下基于主动调用的自动化脱壳方案-Android安全-看雪-安全社区|安全招聘|kanxue.com BaseDexClassLoader.java - Android Code Search unpacker&amp;#x2F;android-7.1."><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://bygeee.github.io/2025/09/20/%E5%8A%A0%E5%9B%BA/"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["计算机萌新"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: grand","link":"链接: ","source":"来源: grand","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'grand',
  title: '加固',
  postAI: '',
  pageFillDescription: '加固, 加壳app的运行流程, 参考, 源码分析, 加壳app运行流程, 整体加固, 落地加载, 内存加载, 解决方案, fart, blackdex, fdex2, frida-dexdump, 抽取加固, 类加载器, 类加载的时机, 类加载器, 加固对hook的影响, 普通app运行流程, 加固app运行流程, 加固对ClassLoader的常见修正方式, 插入ClassLoader, 替换ClassLoader, art下的常见脱壳点, dex的加载流程, dex2oat的编译流程, 类的加载和初始化流程, 函数执行过程中的脱壳点, inmemorydexclassloader, dexclassloader源码, youpk整体脱壳原理, fdex2脱壳原理, 思考, frida脚本实现, 加固加壳的运行流程参考原创环境下基于主动调用的自动化脱壳方案安全看雪安全社区安全招聘加壳与脱壳源码解析和版本实现安全后厨团队先执行的内容再进行的内容在中的中先是设置了进程名再去创建了的实例重新写一个的代码观察一下代码的执行流程源码分析先来到函数的地方这个类的静态变量用于全局保存创建的实例先是起了一个进程再是创建了一个的实例在后一条命令中调用完成一系列初始化准备工作并完成全局静态变量的初始化当收到系统发送来的的进程间调用时调用函数来处理该请求再来查看一下参数类的信息可以看到有的包名信息等接下来寻找低版本交这个高版本使用的是也就是其中的就是类查看其中的就是当然由于我们肯定就是空的所以还会走下面的流程在这里的中使用了的内容创建了一个正常的是走上面的在执行到也就是的时候其实我们写的类还是没有被初始化只是触发了类的加载我们编写的实际上是没有输出的但是执行以后类就会初始化并且使用构造方法进行实例化所以静态代码块先运行在无参数的构造方法前当然了由于没参数所以有参数的构造方法是不会执行的接下来查看的函数可以看到其中含有一个的方法这也就是我们中的输出位置回到中再次往下就是了查看就是使用了方法以上即是从源码的角度上进行的运行流程的分析从而可以分析出来壳的会替换掉的入口去解密交换控制权执行主函数加壳运行流程加载系统核心库加载自身进入自身组件开始执行调用声明的调用声明的未加固加固后整体加固加固爱加密代码抽取整体加固落地加载这个需要文件的路径所以文件需要出现在文件系统中现在较为少见内存加载直接加载内存中解密完成的内容不释放文件较为常见解决方案在加载解析过程中找一个合适的时机得到内存地址和大小将解密状态的保存下来还可以通过来得到脱壳原是模块低版本中存在通过获取到对象使用方法获取到文件内存搜索文件抽取加固运行时回填函数回填以后不再抽取可以延时运行时回填函数回填以后再抽取主动调用类加载器类加载的时机隐式加载访问类的静态变量为静态变量赋值调用类的静态方法创建类的实例某个类的子类父类也会被加载显式加载使用加载使用加载类加载器单例模式用来加载系统类是的父类类加载的主要逻辑都是在完成的是默认使用的类加载器用于加载自身的用于实现插件化热修复加固等安卓以后引入用于内存加载加固对的影响普通运行流程加载统核心库加载自身加固运行流程加载系统核心库加载壳的壳的加载原先自身加固的加载的是壳的存放在中此时去由于是壳使用的是去获取的原先的类所以是获取不到的但是安卓系统也可能找不到所以要去对进行一个修正加固对的常见修正方式插入替换下的常见脱壳点安卓以后进行加入的加载流程通过脱壳的通过函数脱壳的通过构造函数脱壳的通过来得到的编译流程通过修改脱壳的类的加载和初始化流程在进行类解析函数执行过程中的脱壳点整体脱壳函数中进行直接到了解释执行的函数中进行双亲委派的体现使用父类尝试加载进入到中再次使用父类进行加载这里是为了查看在安卓中存在方法可以直接得到对应的字节码对应的也就是对应的脱壳手段跟进中发现也是一个脱壳点继续跟进这时候就是的函数了进入进行查看这里是进行了函数的注册这里就是进行了类目和方法名的拼接也就是我们常看见的中的导出函数的形式那么他正确的函数名为在这里进行返回含有信息的创建的就含有的信息可以进行脱壳接下来查看解析对应着构造函数脱壳继续分析也是一个脱壳点含有的内容也是脱壳点含有和源码父类四个参数的构造方法继承在这里使用构造方法判断的格式加载跟进走的上面的构造函数走的下面的之后的流程就和差不多了跟进参数和有点区别第一个参数是在其中的在以前是会进行使用也可以选择性禁用但是在现在的安卓系统中的系统还有所以并没有进行删除接下来的内容和差不多也是早期脱壳点整体脱壳原理核心代码获取到当前的现成获取到搞到对象内容进行整体脱壳脱壳原理早期针对一代壳的脱壳方案也就是整体加固但现在随着安卓的版本提高也就淡出视野一步一步分析一下的代码对后面学习安卓很有帮助目标包名获取函数返回类当前类名数据为空返回开始写数据明确了要的类和对应的方法使用了两次反射第一次返回的是一个对象再去使用获取到在内存中的信息这里就可以直接进行的内容写入了整理一下流程先去了再去使用反射获取到对应的对象再次反射搞到在内存中的信息很直白的方法思考这里之所以可以快速简洁的搞到内存中的内容主要还是方法的好处正常的脱壳往往是要查看内容的长度大小的从源码来看可以避免的方式很多比如显式加载我们使用的方法就可以直接防掉这个当然目前只考虑一代壳也就是整体加固其他的壳应该很轻松就可以薄纱当然从的源码来看核心并不是了什么而是和这两个通过这两个快速的搞到内容坏消息以上没了写一个简单的代码进行查看一下脚本实现这个代码实现了主动的调用需要所在的文件',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-20 18:29:44',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/./pic/1.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">grand</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2026/01/"><span class="card-archive-list-date">一月 2026</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/12/"><span class="card-archive-list-date">十二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">九月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">八月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/05/"><span class="card-archive-list-date">五月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"></span></div></div><h1 class="post-title" itemprop="name headline">加固</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-09-19T16:00:00.000Z" title="发表于 2025-09-20 00:00:00">2025-09-20</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-09-20T10:29:44.106Z" title="更新于 2025-09-20 18:29:44">2025-09-20</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="加固"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="/./pic/12.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://bygeee.github.io/2025/09/20/%E5%8A%A0%E5%9B%BA/"><header><h1 id="CrawlerTitle" itemprop="name headline">加固</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">grand</span><time itemprop="dateCreated datePublished" datetime="2025-09-19T16:00:00.000Z" title="发表于 2025-09-20 00:00:00">2025-09-20</time><time itemprop="dateCreated datePublished" datetime="2025-09-20T10:29:44.106Z" title="更新于 2025-09-20 18:29:44">2025-09-20</time></header><h1 id="加固"><a href="#加固" class="headerlink" title="加固"></a>加固</h1><h1 id="加壳app的运行流程"><a href="#加壳app的运行流程" class="headerlink" title="加壳app的运行流程"></a>加壳app的运行流程</h1><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-252630.htm">[原创]FART：ART环境下基于主动调用的自动化脱壳方案-Android安全-看雪-安全社区|安全招聘|kanxue.com</a></p>
<p><a target="_blank" rel="noopener" href="https://cs.android.com/android/platform/superproject/+/android-latest-release:libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java;l=43;bpv=1">BaseDexClassLoader.java - Android Code Search</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Youlor/unpacker/blob/master/android-7.1.2_r33/art/runtime/unpacker/unpacker.cc">unpacker&#x2F;android-7.1.2_r33&#x2F;art&#x2F;runtime&#x2F;unpacker&#x2F;unpacker.cc at master · Youlor&#x2F;unpacker</a></p>
<p><a target="_blank" rel="noopener" href="https://security-kitchen.com/android/Android%E9%80%86%E5%90%91%E6%8A%80%E6%9C%AF/07%20Android%E5%8A%A0%E5%A3%B3%E4%B8%8E%E8%84%B1%E5%A3%B3/0007%20Fdex2%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E5%92%8Cfrida%E7%89%88%E6%9C%AC%E5%AE%9E%E7%8E%B0.html#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80">Android加壳与脱壳（7）——Fdex2源码解析和frida版本实现 | 安全后厨团队</a></p>
<p>‍</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package com.grand.packer;</span><br><span class="line"></span><br><span class="line">import androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line">import android.app.Application;</span><br><span class="line">import android.content.Context;</span><br><span class="line">import android.os.Bundle;</span><br><span class="line">import android.util.Log;</span><br><span class="line">import android.widget.TextView;</span><br><span class="line"></span><br><span class="line">import com.grand.packer.databinding.ActivityMainBinding;</span><br><span class="line"></span><br><span class="line">public class myapplication extends Application&#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate() &#123;</span><br><span class="line">        super.onCreate();</span><br><span class="line">        Log.e(&quot;myapplication.onCreate&quot;,&quot;now is in the onCreate&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void attachBaseContext(Context base) &#123;</span><br><span class="line">        super.attachBaseContext(base);</span><br><span class="line">        Log.e(&quot;myapplication.attachBaseContext&quot;,&quot;now is in the attachBaseContext&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>‍</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">package com.grand.packer;</span><br><span class="line"></span><br><span class="line">import androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line">import android.os.Bundle;</span><br><span class="line">import android.util.Log;</span><br><span class="line">import android.widget.TextView;</span><br><span class="line"></span><br><span class="line">import com.grand.packer.databinding.ActivityMainBinding;</span><br><span class="line"></span><br><span class="line">public class MainActivity extends AppCompatActivity &#123;</span><br><span class="line"></span><br><span class="line">    // Used to load the &#x27;packer&#x27; library on application startup.</span><br><span class="line">    static &#123;</span><br><span class="line">        System.loadLibrary(&quot;packer&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private ActivityMainBinding binding;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        binding = ActivityMainBinding.inflate(getLayoutInflater());</span><br><span class="line">        setContentView(binding.getRoot());</span><br><span class="line"></span><br><span class="line">        // Example of a call to a native method</span><br><span class="line">        TextView tv = binding.sampleText;</span><br><span class="line">        tv.setText(stringFromJNI());</span><br><span class="line"></span><br><span class="line">        Log.e(&quot;MainActivity.attachBaseContext&quot;,&quot;now is in the MainActivity.attachBaseContext&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * A native method that is implemented by the &#x27;packer&#x27; native library,</span><br><span class="line">     * which is packaged with this application.</span><br><span class="line">     */</span><br><span class="line">    public native String stringFromJNI();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先执行myapplication的内容再进行main的内容</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250628235318-bwlhd60.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250628233105-a4i5zz9.png" alt="image"></p>
<p>在activitythread中的main中 先是设置了进程名 再去创建了activitythread的实例</p>
<p>‍</p>
<p>重新写一个myapplication的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">package com.grand.packer;</span><br><span class="line"></span><br><span class="line">import androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line">import android.app.Application;</span><br><span class="line">import android.content.Context;</span><br><span class="line">import android.os.Bundle;</span><br><span class="line">import android.util.Log;</span><br><span class="line">import android.widget.TextView;</span><br><span class="line"></span><br><span class="line">import com.grand.packer.databinding.ActivityMainBinding;</span><br><span class="line"></span><br><span class="line">public class myapplication extends Application&#123;</span><br><span class="line"></span><br><span class="line">    public myapplication()&#123;</span><br><span class="line">        Log.e(&quot;myapplication&quot;,&quot;now is myapplication.instence&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public myapplication(int a)&#123;</span><br><span class="line">        Log.e(&quot;myapplication&quot;,&quot;now is myapplication.instence(a)&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        Log.e(&quot;static&quot;,&quot;now is static&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate() &#123;</span><br><span class="line">        super.onCreate();</span><br><span class="line">        Log.e(&quot;myapplication.onCreate&quot;,&quot;now is in the onCreate&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void attachBaseContext(Context base) &#123;</span><br><span class="line">        super.attachBaseContext(base);</span><br><span class="line">        Log.e(&quot;myapplication.attachBaseContext&quot;,&quot;now is in the attachBaseContext&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250628235115-xf4qsd4.png" alt="image"></p>
<p>观察一下代码的执行流程</p>
<p>‍</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250628235536-t3ujdos.png" alt="image"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">public static void main(String[] args) &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;ActivityThreadMain&quot;);</span><br><span class="line"></span><br><span class="line">        // Install selective syscall interception</span><br><span class="line">        AndroidOs.install();</span><br><span class="line"></span><br><span class="line">        // CloseGuard defaults to true and can be quite spammy.  We</span><br><span class="line">        // disable it here, but selectively enable it later (via</span><br><span class="line">        // StrictMode) on debug builds, but using DropBox, not logs.</span><br><span class="line">        CloseGuard.setEnabled(false);</span><br><span class="line"></span><br><span class="line">        Environment.initForCurrentUser();</span><br><span class="line"></span><br><span class="line">        // Make sure TrustedCertificateStore looks in the right place for CA certificates</span><br><span class="line">        final File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</span><br><span class="line">        TrustedCertificateStore.setDefaultUserDirectory(configDir);</span><br><span class="line"></span><br><span class="line">        // Call per-process mainline module initialization.</span><br><span class="line">        initializeMainlineModules();</span><br><span class="line"></span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">        Process.setArgV0(&quot;&lt;pre-initialized&gt;&quot;);</span><br><span class="line"></span><br><span class="line">        // Find the value for &#123;@link #PROC_START_SEQ_IDENT&#125; if provided on the command line.</span><br><span class="line">        // It will be in the format &quot;seq=114&quot;</span><br><span class="line">        long startSeq = 0;</span><br><span class="line">        if (args != null) &#123;</span><br><span class="line">            for (int i = args.length - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">                if (args[i] != null &amp;&amp; args[i].startsWith(PROC_START_SEQ_IDENT)) &#123;</span><br><span class="line">                    startSeq = Long.parseLong(</span><br><span class="line">                            args[i].substring(PROC_START_SEQ_IDENT.length()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ActivityThread thread = new ActivityThread();</span><br><span class="line">        thread.attach(false, startSeq);</span><br><span class="line"></span><br><span class="line">        if (sMainThreadHandler == null) &#123;</span><br><span class="line">            sMainThreadHandler = thread.getHandler();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (false) &#123;</span><br><span class="line">            Looper.myLooper().setMessageLogging(new</span><br><span class="line">                    LogPrinter(Log.DEBUG, &quot;ActivityThread&quot;));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // End of event ActivityThreadMain.</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        Looper.loop();</span><br><span class="line"></span><br><span class="line">        throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>先来到main函数的地方 ActivityThread这个类的sCurrentActivityThread静态变量用于全局保存创建的ActivityThread实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process.setArgV0(&quot;&lt;pre-initialized&gt;&quot;);</span><br></pre></td></tr></table></figure>

<p>先是setargv0起了一个进程 再是创建了一个activity的实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ActivityThread thread = new ActivityThread();</span><br></pre></td></tr></table></figure>

<p>在后一条命令中 调用thread.attach(false)完成一系列初始化准备工作 并完成全局静态变量sCurrentActivityThread的初始化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread.attach(false, startSeq);</span><br></pre></td></tr></table></figure>

<p>‍</p>
<p>当收到系统发送来的bindapplication的进程间调用时，调用函数handlebindapplication来处理该请求</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br></pre></td><td class="code"><pre><span class="line">private void handleBindApplication(AppBindData data) &#123;</span><br><span class="line">    mDdmSyncStageUpdater.next(Stage.Bind);</span><br><span class="line"></span><br><span class="line">    // Register the UI Thread as a sensitive thread to the runtime.</span><br><span class="line">    VMRuntime.registerSensitiveThread();</span><br><span class="line">    // In the case the stack depth property exists, pass it down to the runtime.</span><br><span class="line">    String property = SystemProperties.get(&quot;debug.allocTracker.stackDepth&quot;);</span><br><span class="line">    if (property.length() != 0) &#123;</span><br><span class="line">        VMDebug.setAllocTrackerStackDepth(Integer.parseInt(property));</span><br><span class="line">    &#125;</span><br><span class="line">    if (data.trackAllocation) &#123;</span><br><span class="line">        DdmVmInternal.setRecentAllocationsTrackingEnabled(true);</span><br><span class="line">    &#125;</span><br><span class="line">    // Note when this process has started.</span><br><span class="line">    Process.setStartTimes(SystemClock.elapsedRealtime(), SystemClock.uptimeMillis(),</span><br><span class="line">            data.startRequestedElapsedTime, data.startRequestedUptime);</span><br><span class="line"></span><br><span class="line">    AppCompatCallbacks.install(data.disabledCompatChanges, data.mLoggableCompatChanges);</span><br><span class="line">    // Let libcore handle any compat changes after installing the list of compat changes.</span><br><span class="line">    AppSpecializationHooks.handleCompatChangesBeforeBindingApplication();</span><br><span class="line"></span><br><span class="line">    // Initialize the zip path validator callback depending on the targetSdk.</span><br><span class="line">    // This has to be after AppCompatCallbacks#install() so that the Compat</span><br><span class="line">    // checks work accordingly.</span><br><span class="line">    initZipPathValidatorCallback();</span><br><span class="line"></span><br><span class="line">    mBoundApplication = data;</span><br><span class="line">    mConfigurationController.setConfiguration(data.config);</span><br><span class="line">    mConfigurationController.setCompatConfiguration(data.config);</span><br><span class="line">    mConfiguration = mConfigurationController.getConfiguration();</span><br><span class="line">    mCompatibilityInfo = data.compatInfo;</span><br><span class="line"></span><br><span class="line">    mProfiler = new Profiler();</span><br><span class="line">    String agent = null;</span><br><span class="line">    if (data.initProfilerInfo != null) &#123;</span><br><span class="line">        mProfiler.profileFile = data.initProfilerInfo.profileFile;</span><br><span class="line">        mProfiler.profileFd = data.initProfilerInfo.profileFd;</span><br><span class="line">        mProfiler.samplingInterval = data.initProfilerInfo.samplingInterval;</span><br><span class="line">        mProfiler.autoStopProfiler = data.initProfilerInfo.autoStopProfiler;</span><br><span class="line">        mProfiler.streamingOutput = data.initProfilerInfo.streamingOutput;</span><br><span class="line">        mProfiler.mClockType = data.initProfilerInfo.clockType;</span><br><span class="line">        mProfiler.mProfilerOutputVersion = data.initProfilerInfo.profilerOutputVersion;</span><br><span class="line">        if (data.initProfilerInfo.attachAgentDuringBind) &#123;</span><br><span class="line">            agent = data.initProfilerInfo.agent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    VMDebug.setUserId(UserHandle.myUserId());</span><br><span class="line">    VMDebug.addApplication(data.appInfo.packageName);</span><br><span class="line">    // send up app name; do this *before* waiting for debugger</span><br><span class="line">    Process.setArgV0(data.processName);</span><br><span class="line">    android.ddm.DdmHandleAppName.setAppName(data.processName,</span><br><span class="line">                                            data.appInfo.packageName,</span><br><span class="line">                                            UserHandle.myUserId());</span><br><span class="line">    VMRuntime.setProcessPackageName(data.appInfo.packageName);</span><br><span class="line">    mDdmSyncStageUpdater.next(Stage.Named);</span><br><span class="line"></span><br><span class="line">    // Pass data directory path to ART. This is used for caching information and</span><br><span class="line">    // should be set before any application code is loaded.</span><br><span class="line">    VMRuntime.setProcessDataDirectory(data.appInfo.dataDir);</span><br><span class="line"></span><br><span class="line">    if (mProfiler.profileFd != null) &#123;</span><br><span class="line">        mProfiler.startProfiling();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // If the app is Honeycomb MR1 or earlier, switch its AsyncTask</span><br><span class="line">    // implementation to use the pool executor.  Normally, we use the</span><br><span class="line">    // serialized executor as the default. This has to happen in the</span><br><span class="line">    // main thread so the main looper is set right.</span><br><span class="line">    if (data.appInfo.targetSdkVersion &lt;= android.os.Build.VERSION_CODES.HONEYCOMB_MR1) &#123;</span><br><span class="line">        AsyncTask.setDefaultExecutor(AsyncTask.THREAD_POOL_EXECUTOR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Let the util.*Array classes maintain &quot;undefined&quot; for apps targeting Pie or earlier.</span><br><span class="line">    UtilConfig.setThrowExceptionForUpperArrayOutOfBounds(</span><br><span class="line">            data.appInfo.targetSdkVersion &gt;= Build.VERSION_CODES.Q);</span><br><span class="line"></span><br><span class="line">    Message.updateCheckRecycle(data.appInfo.targetSdkVersion);</span><br><span class="line"></span><br><span class="line">    // Supply the targetSdkVersion to the UI rendering module, which may</span><br><span class="line">    // need it in cases where it does not have access to the appInfo.</span><br><span class="line">    android.graphics.Compatibility.setTargetSdkVersion(data.appInfo.targetSdkVersion);</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Before spawning a new process, reset the time zone to be the system time zone.</span><br><span class="line">     * This needs to be done because the system time zone could have changed after the</span><br><span class="line">     * the spawning of this process. Without doing this this process would have the incorrect</span><br><span class="line">     * system time zone.</span><br><span class="line">     */</span><br><span class="line">    TimeZone.setDefault(null);</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * Set the LocaleList. This may change once we create the App Context.</span><br><span class="line">     */</span><br><span class="line">    LocaleList.setDefault(data.config.getLocales());</span><br><span class="line"></span><br><span class="line">    if (Typeface.ENABLE_LAZY_TYPEFACE_INITIALIZATION) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Typeface.setSystemFontMap(data.mSerializedSystemFontMap);</span><br><span class="line">        &#125; catch (IOException | ErrnoException e) &#123;</span><br><span class="line">            Slog.e(TAG, &quot;Failed to parse serialized system font map&quot;);</span><br><span class="line">            Typeface.loadPreinstalledSystemFontMap();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    synchronized (mResourcesManager) &#123;</span><br><span class="line">        /*</span><br><span class="line">         * Update the system configuration since its preloaded and might not</span><br><span class="line">         * reflect configuration changes. The configuration object passed</span><br><span class="line">         * in AppBindData can be safely assumed to be up to date</span><br><span class="line">         */</span><br><span class="line">        mResourcesManager.applyConfigurationToResources(data.config, data.compatInfo);</span><br><span class="line">        mCurDefaultDisplayDpi = data.config.densityDpi;</span><br><span class="line"></span><br><span class="line">        // This calls mResourcesManager so keep it within the synchronized block.</span><br><span class="line">        mConfigurationController.applyCompatConfiguration();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final boolean isSdkSandbox = data.sdkSandboxClientAppPackage != null;</span><br><span class="line">    data.info = getPackageInfo(data.appInfo, mCompatibilityInfo, null /* baseLoader */,</span><br><span class="line">            false /* securityViolation */, true /* includeCode */,</span><br><span class="line">            false /* registerPackage */, isSdkSandbox);</span><br><span class="line">    if (isSdkSandbox) &#123;</span><br><span class="line">        data.info.setSdkSandboxStorage(data.sdkSandboxClientAppVolumeUuid,</span><br><span class="line">                data.sdkSandboxClientAppPackage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (agent != null) &#123;</span><br><span class="line">        handleAttachAgent(agent, data.info);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Switch this process to density compatibility mode if needed.</span><br><span class="line">     */</span><br><span class="line">    if ((data.appInfo.flags&amp;ApplicationInfo.FLAG_SUPPORTS_SCREEN_DENSITIES)</span><br><span class="line">            == 0) &#123;</span><br><span class="line">        mDensityCompatMode = true;</span><br><span class="line">        Bitmap.setDefaultDensity(DisplayMetrics.DENSITY_DEFAULT);</span><br><span class="line">    &#125;</span><br><span class="line">    mConfigurationController.updateDefaultDensity(data.config.densityDpi);</span><br><span class="line"></span><br><span class="line">    // mCoreSettings is only updated from the main thread, while this function is only called</span><br><span class="line">    // from main thread as well, so no need to lock here.</span><br><span class="line">    final String use24HourSetting = mCoreSettings.getString(Settings.System.TIME_12_24);</span><br><span class="line">    Boolean is24Hr = null;</span><br><span class="line">    if (use24HourSetting != null) &#123;</span><br><span class="line">        is24Hr = &quot;24&quot;.equals(use24HourSetting) ? Boolean.TRUE : Boolean.FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    // null : use locale default for 12/24 hour formatting,</span><br><span class="line">    // false : use 12 hour format,</span><br><span class="line">    // true : use 24 hour format.</span><br><span class="line">    DateFormat.set24HourTimePref(is24Hr);</span><br><span class="line"></span><br><span class="line">    updateDebugViewAttributeState();</span><br><span class="line"></span><br><span class="line">    StrictMode.initThreadDefaults(data.appInfo);</span><br><span class="line">    StrictMode.initVmDefaults(data.appInfo);</span><br><span class="line"></span><br><span class="line">    // Allow binder tracing, and application-generated systrace messages if we&#x27;re profileable.</span><br><span class="line">    boolean isAppDebuggable = (data.appInfo.flags &amp; ApplicationInfo.FLAG_DEBUGGABLE) != 0;</span><br><span class="line">    boolean isAppProfileable = isAppDebuggable || data.appInfo.isProfileable();</span><br><span class="line">    Trace.setAppTracingAllowed(isAppProfileable);</span><br><span class="line">    if ((isAppProfileable || Build.IS_DEBUGGABLE) &amp;&amp; data.enableBinderTracking) &#123;</span><br><span class="line">        Binder.enableStackTracking();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Initialize heap profiling.</span><br><span class="line">    if (isAppProfileable || Build.IS_DEBUGGABLE) &#123;</span><br><span class="line">        nInitZygoteChildHeapProfiling();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Allow renderer debugging features if we&#x27;re debuggable.</span><br><span class="line">    HardwareRenderer.setDebuggingEnabled(isAppDebuggable || Build.IS_DEBUGGABLE);</span><br><span class="line">    HardwareRenderer.setPackageName(data.appInfo.packageName);</span><br><span class="line"></span><br><span class="line">    // Pass the current context to HardwareRenderer</span><br><span class="line">    HardwareRenderer.setContextForInit(getSystemContext());</span><br><span class="line">    if (data.persistent) &#123;</span><br><span class="line">        HardwareRenderer.setIsSystemOrPersistent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Instrumentation info affects the class loader, so load it before</span><br><span class="line">    // setting up the app context.</span><br><span class="line">    final InstrumentationInfo ii;</span><br><span class="line">    if (data.instrumentationName != null) &#123;</span><br><span class="line">        ii = prepareInstrumentation(data);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ii = null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">    final ContextImpl appContext = ContextImpl.createAppContext(this, data.info);</span><br><span class="line">    mConfigurationController.updateLocaleListFromAppContext(appContext);</span><br><span class="line"></span><br><span class="line">    // Initialize the default http proxy in this process.</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;Setup proxies&quot;);</span><br><span class="line">    try &#123;</span><br><span class="line">        // In pre-boot mode (doing initial launch to collect password), not all system is up.</span><br><span class="line">        // This includes the connectivity service, so trying to obtain ConnectivityManager at</span><br><span class="line">        // that point would return null. Check whether the ConnectivityService is available, and</span><br><span class="line">        // avoid crashing with a NullPointerException if it is not.</span><br><span class="line">        final IBinder b = ServiceManager.getService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">        if (b != null) &#123;</span><br><span class="line">            final ConnectivityManager cm =</span><br><span class="line">                    appContext.getSystemService(ConnectivityManager.class);</span><br><span class="line">            Proxy.setHttpProxyConfiguration(cm.getDefaultProxy());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!Process.isIsolated()) &#123;</span><br><span class="line">        final int oldMask = StrictMode.allowThreadDiskWritesMask();</span><br><span class="line">        try &#123;</span><br><span class="line">            setupGraphicsSupport(appContext);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            StrictMode.setThreadPolicyMask(oldMask);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        HardwareRenderer.setIsolatedProcess(true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Install the Network Security Config Provider. This must happen before the application</span><br><span class="line">    // code is loaded to prevent issues with instances of TLS objects being created before</span><br><span class="line">    // the provider is installed.</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;NetworkSecurityConfigProvider.install&quot;);</span><br><span class="line">    NetworkSecurityConfigProvider.install(appContext);</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">    // For backward compatibility, TrafficStats needs static access to the application context.</span><br><span class="line">    // But for isolated apps which cannot access network related services, service discovery</span><br><span class="line">    // is restricted. Hence, calling this would result in NPE.</span><br><span class="line">    if (!Process.isIsolated()) &#123;</span><br><span class="line">        TrafficStats.init(appContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Continue loading instrumentation.</span><br><span class="line">    if (ii != null) &#123;</span><br><span class="line">        initInstrumentation(ii, data, appContext);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mInstrumentation = new Instrumentation();</span><br><span class="line">        mInstrumentation.basicInit(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ((data.appInfo.flags&amp;ApplicationInfo.FLAG_LARGE_HEAP) != 0) &#123;</span><br><span class="line">        dalvik.system.VMRuntime.getRuntime().clearGrowthLimit();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Small heap, clamp to the current growth limit and let the heap release</span><br><span class="line">        // pages after the growth limit to the non growth limit capacity. b/18387825</span><br><span class="line">        dalvik.system.VMRuntime.getRuntime().clampGrowthLimit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Allow disk access during application and provider setup. This could</span><br><span class="line">    // block processing ordered broadcasts, but later processing would</span><br><span class="line">    // probably end up doing the same disk access.</span><br><span class="line">    Application app;</span><br><span class="line">    final StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();</span><br><span class="line">    final StrictMode.ThreadPolicy writesAllowedPolicy = StrictMode.getThreadPolicy();</span><br><span class="line"></span><br><span class="line">    if (data.debugMode != ApplicationThreadConstants.DEBUG_OFF) &#123;</span><br><span class="line">        mDdmSyncStageUpdater.next(Stage.Debugger);</span><br><span class="line">        if (data.debugMode == ApplicationThreadConstants.DEBUG_WAIT) &#123;</span><br><span class="line">            waitForDebugger(data);</span><br><span class="line">        &#125; else if (data.debugMode == ApplicationThreadConstants.DEBUG_SUSPEND) &#123;</span><br><span class="line">            suspendAllAndSendVmStart(data);</span><br><span class="line">        &#125;</span><br><span class="line">        // Nothing special to do in case of DEBUG_ON.</span><br><span class="line">    &#125;</span><br><span class="line">    mDdmSyncStageUpdater.next(Stage.Running);</span><br><span class="line"></span><br><span class="line">    long timestampApplicationOnCreateNs = 0;</span><br><span class="line">    try &#123;</span><br><span class="line">        // If the app is being launched for full backup or restore, bring it up in</span><br><span class="line">        // a restricted environment with the base application class.</span><br><span class="line">        app = data.info.makeApplicationInner(data.restrictedBackupMode, null);</span><br><span class="line"></span><br><span class="line">        // Propagate autofill compat state</span><br><span class="line">        app.setAutofillOptions(data.autofillOptions);</span><br><span class="line"></span><br><span class="line">        // Propagate Content Capture options</span><br><span class="line">        app.setContentCaptureOptions(data.contentCaptureOptions);</span><br><span class="line">        sendMessage(H.SET_CONTENT_CAPTURE_OPTIONS_CALLBACK, data.appInfo.packageName);</span><br><span class="line"></span><br><span class="line">        mInitialApplication = app;</span><br><span class="line">        final boolean updateHttpProxy;</span><br><span class="line">        synchronized (this) &#123;</span><br><span class="line">            updateHttpProxy = mUpdateHttpProxyOnBind;</span><br><span class="line">            // This synchronized block ensures that any subsequent call to updateHttpProxy()</span><br><span class="line">            // will see a non-null mInitialApplication.</span><br><span class="line">        &#125;</span><br><span class="line">        if (updateHttpProxy) &#123;</span><br><span class="line">            ActivityThread.updateHttpProxy(app);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // don&#x27;t bring up providers in restricted mode; they may depend on the</span><br><span class="line">        // app&#x27;s custom Application class</span><br><span class="line">        if (!data.restrictedBackupMode) &#123;</span><br><span class="line">            if (!ArrayUtils.isEmpty(data.providers)) &#123;</span><br><span class="line">                installContentProviders(app, data.providers);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Do this after providers, since instrumentation tests generally start their</span><br><span class="line">        // test thread at this point, and we don&#x27;t want that racing.</span><br><span class="line">        try &#123;</span><br><span class="line">            mInstrumentation.onCreate(data.instrumentationArgs);</span><br><span class="line">        &#125;</span><br><span class="line">        catch (Exception e) &#123;</span><br><span class="line">            throw new RuntimeException(</span><br><span class="line">                &quot;Exception thrown in onCreate() of &quot;</span><br><span class="line">                + data.instrumentationName + &quot;: &quot; + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            timestampApplicationOnCreateNs = SystemClock.uptimeNanos();</span><br><span class="line">            mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            timestampApplicationOnCreateNs = 0;</span><br><span class="line">            if (!mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">                throw new RuntimeException(</span><br><span class="line">                  &quot;Unable to create application &quot; + app.getClass().getName()</span><br><span class="line">                  + &quot;: &quot; + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        // If the app targets &lt; O-MR1, or doesn&#x27;t change the thread policy</span><br><span class="line">        // during startup, clobber the policy to maintain behavior of b/36951662</span><br><span class="line">        if (data.appInfo.targetSdkVersion &lt; Build.VERSION_CODES.O_MR1</span><br><span class="line">                || StrictMode.getThreadPolicy().equals(writesAllowedPolicy)) &#123;</span><br><span class="line">            StrictMode.setThreadPolicy(savedPolicy);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Preload fonts resources</span><br><span class="line">    FontsContract.setApplicationContextForResources(appContext);</span><br><span class="line">    if (!Process.isIsolated()) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            final ApplicationInfo info =</span><br><span class="line">                    getPackageManager().getApplicationInfo(</span><br><span class="line">                            data.appInfo.packageName,</span><br><span class="line">                            PackageManager.GET_META_DATA /*flags*/,</span><br><span class="line">                            UserHandle.myUserId());</span><br><span class="line">            if (info.metaData != null) &#123;</span><br><span class="line">                final int preloadedFontsResource = info.metaData.getInt(</span><br><span class="line">                        ApplicationInfo.METADATA_PRELOADED_FONTS, 0);</span><br><span class="line">                if (preloadedFontsResource != 0) &#123;</span><br><span class="line">                    data.info.getResources().preloadFonts(preloadedFontsResource);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (RemoteException e) &#123;</span><br><span class="line">            throw e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        mgr.finishAttachApplication(mStartSeq, timestampApplicationOnCreateNs);</span><br><span class="line">    &#125; catch (RemoteException ex) &#123;</span><br><span class="line">        throw ex.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Set binder transaction callback after finishing bindApplication</span><br><span class="line">    Binder.setTransactionCallback(new IBinderCallback() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onTransactionError(int pid, int code, int flags, int err) &#123;</span><br><span class="line">            final long now = SystemClock.uptimeMillis();</span><br><span class="line">            if (now &lt; mBinderCallbackLast + BINDER_CALLBACK_THROTTLE) &#123;</span><br><span class="line">                Slog.d(TAG, &quot;Too many transaction errors, throttling freezer binder callback.&quot;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            mBinderCallbackLast = now;</span><br><span class="line">            try &#123;</span><br><span class="line">                mgr.frozenBinderTransactionDetected(pid, code, flags, err);</span><br><span class="line">            &#125; catch (RemoteException ex) &#123;</span><br><span class="line">                throw ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // Register callback to report native memory metrics post GC cleanup</span><br><span class="line">    // Note: we do not report memory metrics of isolated processes unless</span><br><span class="line">    // their native allocations become more significant</span><br><span class="line">    if (!Process.isIsolated() &amp;&amp; Flags.reportPostgcMemoryMetrics() &amp;&amp;</span><br><span class="line">        com.android.libcore.readonly.Flags.postCleanupApis()) &#123;</span><br><span class="line">        VMRuntime.addPostCleanupCallback(new Runnable() &#123;</span><br><span class="line">            @Override public void run() &#123;</span><br><span class="line">                MetricsLoggerWrapper.logPostGcMemorySnapshot();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再来查看一下参数类的信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">static final class AppBindData &#123;</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        AppBindData() &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        LoadedApk info;</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        String processName;</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        ApplicationInfo appInfo;</span><br><span class="line">        String sdkSandboxClientAppVolumeUuid;</span><br><span class="line">        String sdkSandboxClientAppPackage;</span><br><span class="line">        boolean isSdkInSandbox;</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        List&lt;ProviderInfo&gt; providers;</span><br><span class="line">        ComponentName instrumentationName;</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        Bundle instrumentationArgs;</span><br><span class="line">        IInstrumentationWatcher instrumentationWatcher;</span><br><span class="line">        IUiAutomationConnection instrumentationUiAutomationConnection;</span><br><span class="line">        int debugMode;</span><br><span class="line">        boolean enableBinderTracking;</span><br><span class="line">        boolean trackAllocation;</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        boolean restrictedBackupMode;</span><br><span class="line">        @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.R, trackingBug = 170729553)</span><br><span class="line">        boolean persistent;</span><br><span class="line">        Configuration config;</span><br><span class="line">        @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P, trackingBug = 115609023)</span><br><span class="line">        CompatibilityInfo compatInfo;</span><br><span class="line">        String buildSerial;</span><br><span class="line"></span><br><span class="line">        /** Initial values for &#123;@link Profiler&#125;. */</span><br><span class="line">        ProfilerInfo initProfilerInfo;</span><br><span class="line"></span><br><span class="line">        AutofillOptions autofillOptions;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * Content capture options for the application - when null, it means ContentCapture is not</span><br><span class="line">         * enabled for the package.</span><br><span class="line">         */</span><br><span class="line">        @Nullable</span><br><span class="line">        ContentCaptureOptions contentCaptureOptions;</span><br><span class="line"></span><br><span class="line">        long[] disabledCompatChanges;</span><br><span class="line">        long[] mLoggableCompatChanges;</span><br><span class="line"></span><br><span class="line">        SharedMemory mSerializedSystemFontMap;</span><br><span class="line"></span><br><span class="line">        long startRequestedElapsedTime;</span><br><span class="line">        long startRequestedUptime;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public String toString() &#123;</span><br><span class="line">            return &quot;AppBindData&#123;appInfo=&quot; + appInfo + &quot;&#125;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到有app的包名信息等 接下来寻找makeapplication 低版本交这个 高版本使用的是makeApplicationInner 也就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app = data.info.makeApplicationInner(data.restrictedBackupMode, null);</span><br></pre></td></tr></table></figure>

<p>其中的info就是loaddapk类 查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public Application makeApplication(boolean forceDefaultAppClass,</span><br><span class="line">           Instrumentation instrumentation) &#123;</span><br><span class="line">       return makeApplicationInner(forceDefaultAppClass, instrumentation,</span><br><span class="line">               /* allowDuplicateInstances= */ true);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * This is for all the (internal) callers, for which we do return the cached instance.</span><br><span class="line">    */</span><br><span class="line">   public Application makeApplicationInner(boolean forceDefaultAppClass,</span><br><span class="line">           Instrumentation instrumentation) &#123;</span><br><span class="line">       return makeApplicationInner(forceDefaultAppClass, instrumentation,</span><br><span class="line">               /* allowDuplicateInstances= */ false);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   private Application makeApplicationInner(boolean forceDefaultAppClass,</span><br><span class="line">           Instrumentation instrumentation, boolean allowDuplicateInstances) &#123;</span><br><span class="line">       if (mApplication != null) &#123;</span><br><span class="line">           return mApplication;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>其中的mapplication就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private Application mApplication;</span><br></pre></td></tr></table></figure>

<p>当然由于我们mapplication肯定就是空的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">private Application makeApplicationInner(boolean forceDefaultAppClass,</span><br><span class="line">            Instrumentation instrumentation, boolean allowDuplicateInstances) &#123;</span><br><span class="line">        if (mApplication != null) &#123;</span><br><span class="line">            return mApplication;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        if (Trace.isTagEnabled(Trace.TRACE_TAG_ACTIVITY_MANAGER)) &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;makeApplication&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            synchronized (sApplications) &#123;</span><br><span class="line">                final Application cached = sApplications.get(mPackageName);</span><br><span class="line">                if (cached != null) &#123;</span><br><span class="line">                    // Looks like this is always happening for the system server, because</span><br><span class="line">                    // the LoadedApk created in systemMain() -&gt; attach() isn&#x27;t cached properly?</span><br><span class="line">                    if (!&quot;android&quot;.equals(mPackageName)) &#123;</span><br><span class="line">                        Slog.wtfStack(TAG, &quot;App instance already created for package=&quot;</span><br><span class="line">                                + mPackageName + &quot; instance=&quot; + cached);</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (!allowDuplicateInstances) &#123;</span><br><span class="line">                        mApplication = cached;</span><br><span class="line">                        return cached;</span><br><span class="line">                    &#125;</span><br><span class="line">                    // Some apps intentionally call makeApplication() to create a new Application</span><br><span class="line">                    // instance... Sigh...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Application app = null;</span><br><span class="line"></span><br><span class="line">            final String myProcessName = Process.myProcessName();</span><br><span class="line">            String appClass = mApplicationInfo.getCustomApplicationClassNameForProcess(</span><br><span class="line">                    myProcessName);</span><br><span class="line">            if (forceDefaultAppClass || (appClass == null)) &#123;</span><br><span class="line">                appClass = &quot;android.app.Application&quot;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                final java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">                if (!mPackageName.equals(&quot;android&quot;)) &#123;</span><br><span class="line">                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,</span><br><span class="line">                            &quot;initializeJavaContextClassLoader&quot;);</span><br><span class="line">                    initializeJavaContextClassLoader();</span><br><span class="line">                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                // Rewrite the R &#x27;constants&#x27; for all library apks.</span><br><span class="line">                SparseArray&lt;String&gt; packageIdentifiers = getAssets().getAssignedPackageIdentifiers(</span><br><span class="line">                        false, false);</span><br><span class="line">                for (int i = 0, n = packageIdentifiers.size(); i &lt; n; i++) &#123;</span><br><span class="line">                    final int id = packageIdentifiers.keyAt(i);</span><br><span class="line">                    if (id == 0x01 || id == 0x7f) &#123;</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    rewriteRValues(cl, packageIdentifiers.valueAt(i), id);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, this);</span><br><span class="line">                // The network security config needs to be aware of multiple</span><br><span class="line">                // applications in the same process to handle discrepancies</span><br><span class="line">                NetworkSecurityConfigProvider.handleNewApplication(appContext);</span><br><span class="line">                app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                        cl, appClass, appContext);</span><br><span class="line">                appContext.setOuterContext(app);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                if (!mActivityThread.mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">                    throw new RuntimeException(</span><br><span class="line">                        &quot;Unable to instantiate application &quot; + appClass</span><br><span class="line">                        + &quot; package &quot; + mPackageName + &quot;: &quot; + e.toString(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            mActivityThread.addApplication(app);</span><br><span class="line">            mApplication = app;</span><br><span class="line">            if (!allowDuplicateInstances) &#123;</span><br><span class="line">                synchronized (sApplications) &#123;</span><br><span class="line">                    sApplications.put(mPackageName, app);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (instrumentation != null) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    instrumentation.callApplicationOnCreate(app);</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    if (!instrumentation.onException(app, e)) &#123;</span><br><span class="line">                        throw new RuntimeException(</span><br><span class="line">                            &quot;Unable to create application &quot; + app.getClass().getName()</span><br><span class="line">                            + &quot;: &quot; + e.toString(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return app;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所以还会走下面的流程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250629004024-52f9xkg.png" alt="image"></p>
<p>‍</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                        cl, appClass, appContext);</span><br></pre></td></tr></table></figure>

<p>在这里的newApplication中使用了appclass的内容创建了一个application</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public Application newApplication(ClassLoader cl, String className, Context context)</span><br><span class="line">           throws InstantiationException, IllegalAccessException, </span><br><span class="line">           ClassNotFoundException &#123;</span><br><span class="line">       Application app = getFactory(context.getPackageName())</span><br><span class="line">               .instantiateApplication(cl, className);</span><br><span class="line">       app.attach(context);</span><br><span class="line">       return app;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   /**</span><br><span class="line">    * Perform instantiation of the process&#x27;s &#123;@link Application&#125; object.  The</span><br><span class="line">    * default implementation provides the normal system behavior.</span><br><span class="line">    * </span><br><span class="line">    * @param clazz The class used to create an Application object from.</span><br><span class="line">    * @param context The context to initialize the application with</span><br><span class="line">    * </span><br><span class="line">    * @return The newly instantiated Application object.</span><br><span class="line">    */</span><br><span class="line">   static public Application newApplication(Class&lt;?&gt; clazz, Context context)</span><br><span class="line">           throws InstantiationException, IllegalAccessException, </span><br><span class="line">           ClassNotFoundException &#123;</span><br><span class="line">       Application app = (Application)clazz.newInstance();</span><br><span class="line">       app.attach(context);</span><br><span class="line">       return app;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public @NonNull Application instantiateApplication(@NonNull ClassLoader cl,</span><br><span class="line">            @NonNull String className)</span><br><span class="line">            throws InstantiationException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        return (Application) cl.loadClass(className).newInstance();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>正常的是走上面的 在执行到instantiateApplication也就是classloader的时候其实我们写的类还是没有被初始化 只是触发了类的加载 我们编写的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static &#123;</span><br><span class="line">        Log.e(&quot;static&quot;,&quot;now is static&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>实际上是没有输出的 但是执行newInstance()以后类就会初始化 并且使用构造方法进行实例化 所以静态代码块先运行在无参数的构造方法前 当然了由于newInstance()没参数所以有参数的构造方法是不会执行的</p>
<p> <img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250629010216-uh63rzb.png" alt="image"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2025-06-24 22:35:59.127 20940-20940 static                  com.grand.packer                     E  now is static</span><br><span class="line">2025-06-24 22:35:59.127 20940-20940 myapplication           com.grand.packer                     E  now is myapplication.instence</span><br></pre></td></tr></table></figure>

<p>接下来查看application的attch函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/* package */ final void attach(Context context) &#123;</span><br><span class="line">      attachBaseContext(context);</span><br><span class="line">      mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到其中含有一个attachBaseContext(context)的方法 这也就是我们log中attachBaseContext的输出位置 回到handleBindApplication中 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250629011240-xi57vbr.png" alt="image"></p>
<p>再次往下就是oncreate了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250629011833-7xqyem4.png" alt="image"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mInstrumentation.callApplicationOnCreate(app);</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void callApplicationOnCreate(Application app) &#123;</span><br><span class="line">        app.onCreate();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>就是使用了oncreate方法 以上即是从源码的角度上进行的app运行流程的分析 从而可以分析出来壳的app会替换掉androidmanifest的入口 去解密dex 交换控制权执行主函数 </p>
<h2 id="加壳app运行流程"><a href="#加壳app运行流程" class="headerlink" title="加壳app运行流程"></a>加壳app运行流程</h2><p>BootClassLoader加载系统核心库</p>
<p>PathClassLoader加载APP自身dex</p>
<p>进入APP自身组件开始执行<br>调用声明Application的attachBaseContext</p>
<p>调用声明Application的onCreate</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250629144740-mwwhlu4.png" alt="image"></p>
<p>‍</p>
<p>‍</p>
<p>未加固</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250913184137-xpurj4n.png" alt="image"></p>
<p>加固后 360整体加固</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250913184107-wp1lps8.png" alt="image"></p>
<p>加固 爱加密 代码抽取</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250913184306-gl0c9fz.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250913184315-34mb4r7.png" alt="image"></p>
<p>‍</p>
<h1 id="整体加固"><a href="#整体加固" class="headerlink" title="整体加固"></a>整体加固</h1><h2 id="落地加载"><a href="#落地加载" class="headerlink" title="落地加载"></a>落地加载</h2><p>dexclassloader</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250913190526-54j4gug.png" alt="image"></p>
<p>这个需要dex文件的路径 所以dex文件需要出现在文件系统中 现在较为少见</p>
<p>‍</p>
<h2 id="内存加载"><a href="#内存加载" class="headerlink" title="内存加载"></a>内存加载</h2><p>直接加载内存中解密完成的dex内容 不释放文件 较为常见</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="fart"><a href="#fart" class="headerlink" title="fart"></a>fart</h3><p>在dex加载、解析过程中，找一个合适的时机，得到DexFile内存地址和大小，将解密状态的dex保存下来、还可以通过artMethod来得到DexFile</p>
<h3 id="blackdex"><a href="#blackdex" class="headerlink" title="blackdex"></a>blackdex</h3><p>mcookie脱壳</p>
<h3 id="fdex2"><a href="#fdex2" class="headerlink" title="fdex2"></a>fdex2</h3><p>原是xposed模块，低版本中存在通过class获取到dexfile对象使用getbytes方法获取到dex文件</p>
<h3 id="frida-dexdump"><a href="#frida-dexdump" class="headerlink" title="frida-dexdump"></a>frida-dexdump</h3><p>内存搜索dex文件</p>
<h1 id="抽取加固"><a href="#抽取加固" class="headerlink" title="抽取加固"></a>抽取加固</h1><p>运行时回填函数，回填以后不再抽取，可以延时dump</p>
<p>运行时回填函数，回填以后再抽取，主动调用dump</p>
<p>‍</p>
<h1 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h1><h2 id="类加载的时机"><a href="#类加载的时机" class="headerlink" title="类加载的时机"></a>类加载的时机</h2><p>隐式加载：访问类的静态变量、为静态变量赋值、调用类的静态方法创建类的实例、某个类的子类，父类也会被加载</p>
<p>显式加载：使用Class.forName加载使用loadClass加载</p>
<h2 id="类加载器-1"><a href="#类加载器-1" class="headerlink" title="类加载器"></a>类加载器</h2><p>BootClassLoader:单例模式，用来加载系统类<br>BaseDexClassLoader:是PathClassLoader、DexClassLoader、<br>InMemor yDexClassLoader的父类，类加载的主要逻辑都是在BaseDexClassLoader完成的<br>PathClassLoader:是默认使用的类加载器，用于加载app自身的dex<br>DexClassLoader:用于实现插件化、热修复、dex加固等<br>nMemoryDexClassLoader:安卓8.0以后引入，用于内存加载dex</p>
<p>‍</p>
<h2 id="加固对hook的影响"><a href="#加固对hook的影响" class="headerlink" title="加固对hook的影响"></a>加固对hook的影响</h2><h3 id="普通app运行流程"><a href="#普通app运行流程" class="headerlink" title="普通app运行流程"></a>普通app运行流程</h3><p>BootClassLoader加载统核心库</p>
<p>PathClassLoader加载app自身dex mClassLoader</p>
<p>‍</p>
<h3 id="加固app运行流程"><a href="#加固app运行流程" class="headerlink" title="加固app运行流程"></a>加固app运行流程</h3><p>BootClassLoader加载系统核心库<br>PathClassLoader加载壳的dex mClassLoader<br>壳的dex&#x2F;so加载原先app自身dex</p>
<p>‍</p>
<p>加固app的pathclassloader加载的是壳的dex 存放在mclassloader中 此时去hook由于是壳dex使用的是dexclassloader去获取的原先的类 所以是获取不到的 但是安卓系统也可能找不到 所以要去对classloader进行一个修正</p>
<p>‍</p>
<h3 id="加固对ClassLoader的常见修正方式"><a href="#加固对ClassLoader的常见修正方式" class="headerlink" title="加固对ClassLoader的常见修正方式"></a>加固对ClassLoader的常见修正方式</h3><h4 id="插入ClassLoader"><a href="#插入ClassLoader" class="headerlink" title="插入ClassLoader"></a>插入ClassLoader</h4><p>BootClassLoader<br>DexClassLoader<br>PathClassLoader mClassLoader</p>
<h4 id="替换ClassLoader"><a href="#替换ClassLoader" class="headerlink" title="替换ClassLoader"></a>替换ClassLoader</h4><p>BootClassLoader<br>PathClassLoader<br>DexClassLoader mClassLoader</p>
<p>‍</p>
<p>‍</p>
<h1 id="art下的常见脱壳点"><a href="#art下的常见脱壳点" class="headerlink" title="art下的常见脱壳点"></a>art下的常见脱壳点</h1><p>安卓5以后进行加入</p>
<h2 id="dex的加载流程"><a href="#dex的加载流程" class="headerlink" title="dex的加载流程"></a>dex的加载流程</h2><p>通过mCook ie脱壳的<br>通过openCommen函数脱壳的<br>通过DexFile构造函数脱壳的<br>youpk:通过ClassLinker来得到DexFile</p>
<h2 id="dex2oat的编译流程"><a href="#dex2oat的编译流程" class="headerlink" title="dex2oat的编译流程"></a>dex2oat的编译流程</h2><p>通过修改dex2oat脱壳的</p>
<h2 id="类的加载和初始化流程"><a href="#类的加载和初始化流程" class="headerlink" title="类的加载和初始化流程"></a>类的加载和初始化流程</h2><p>DexHunter在defineClass进行类解析</p>
<h2 id="函数执行过程中的脱壳点"><a href="#函数执行过程中的脱壳点" class="headerlink" title="函数执行过程中的脱壳点"></a>函数执行过程中的脱壳点</h2><p>FART:Execute整体脱壳<br>FART:ArtMethod::invoke函数中进行dump Codeltem<br>youpk:直接到了解释执行的函数中进行dump Codeltem</p>
<p>‍</p>
<h1 id="inmemorydexclassloader"><a href="#inmemorydexclassloader" class="headerlink" title="inmemorydexclassloader"></a>inmemorydexclassloader</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Copyright (C) 2016 The Android Open Source Project</span><br><span class="line"> *</span><br><span class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> * you may not use this file except in compliance with the License.</span><br><span class="line"> * You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">package dalvik.system;</span><br><span class="line"></span><br><span class="line">import libcore.util.NonNull;</span><br><span class="line">import libcore.util.Nullable;</span><br><span class="line">import java.nio.ByteBuffer;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * A &#123;@link ClassLoader&#125; implementation that loads classes from a</span><br><span class="line"> * buffer containing a DEX file. This can be used to execute code that</span><br><span class="line"> * has not been written to the local file system.</span><br><span class="line"> */</span><br><span class="line">public final class InMemoryDexClassLoader extends BaseDexClassLoader &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Create an in-memory DEX class loader with the given dex buffers.</span><br><span class="line">     *</span><br><span class="line">     * @param dexBuffers array of buffers containing DEX files between</span><br><span class="line">     *                       &lt;tt&gt;buffer.position()&lt;/tt&gt; and &lt;tt&gt;buffer.limit()&lt;/tt&gt;.</span><br><span class="line">     * @param librarySearchPath the list of directories containing native</span><br><span class="line">     *   libraries, delimited by &#123;@code File.pathSeparator&#125;; may be &#123;@code null&#125;</span><br><span class="line">     * @param parent the parent class loader for delegation.</span><br><span class="line">     */</span><br><span class="line">    public InMemoryDexClassLoader(@NonNull ByteBuffer @NonNull [] dexBuffers,</span><br><span class="line">            @Nullable String librarySearchPath, @Nullable ClassLoader parent) &#123;</span><br><span class="line">        super(dexBuffers, librarySearchPath, parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Create an in-memory DEX class loader with the given dex buffers.</span><br><span class="line">     *</span><br><span class="line">     * @param dexBuffers array of buffers containing DEX files between</span><br><span class="line">     *                       &lt;tt&gt;buffer.position()&lt;/tt&gt; and &lt;tt&gt;buffer.limit()&lt;/tt&gt;.</span><br><span class="line">     * @param parent the parent class loader for delegation.</span><br><span class="line">     */</span><br><span class="line">    public InMemoryDexClassLoader(@NonNull ByteBuffer @NonNull [] dexBuffers,</span><br><span class="line">            @Nullable ClassLoader parent) &#123;</span><br><span class="line">        this(dexBuffers, null, parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Creates a new in-memory DEX class loader.</span><br><span class="line">     *</span><br><span class="line">     * @param dexBuffer buffer containing DEX file contents between</span><br><span class="line">     *                       &lt;tt&gt;buffer.position()&lt;/tt&gt; and &lt;tt&gt;buffer.limit()&lt;/tt&gt;.</span><br><span class="line">     * @param parent the parent class loader for delegation.</span><br><span class="line">     */</span><br><span class="line">    public InMemoryDexClassLoader(@NonNull ByteBuffer dexBuffer, @Nullable ClassLoader parent) &#123;</span><br><span class="line">        this(new ByteBuffer[] &#123; dexBuffer &#125;, parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>双亲委派的体现 使用父类尝试加载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Copyright (C) 2011 The Android Open Source Project</span><br><span class="line"> *</span><br><span class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> * you may not use this file except in compliance with the License.</span><br><span class="line"> * You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">package dalvik.system;</span><br><span class="line"></span><br><span class="line">import static android.annotation.SystemApi.Client.MODULE_LIBRARIES;</span><br><span class="line"></span><br><span class="line">import android.annotation.SystemApi;</span><br><span class="line">import android.compat.annotation.UnsupportedAppUsage;</span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.nio.ByteBuffer;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.Collection;</span><br><span class="line">import java.util.Collections;</span><br><span class="line">import java.util.Enumeration;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Map;</span><br><span class="line">import libcore.util.NonNull;</span><br><span class="line">import libcore.util.Nullable;</span><br><span class="line">import sun.misc.CompoundEnumeration;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Base class for common functionality between various dex-based</span><br><span class="line"> * &#123;@link ClassLoader&#125; implementations.</span><br><span class="line"> */</span><br><span class="line">public class BaseDexClassLoader extends ClassLoader &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Hook for customizing how dex files loads are reported.</span><br><span class="line">     *</span><br><span class="line">     * This enables the framework to monitor the use of dex files. The</span><br><span class="line">     * goal is to simplify the mechanism for optimizing foreign dex files and</span><br><span class="line">     * enable further optimizations of secondary dex files.</span><br><span class="line">     *</span><br><span class="line">     * The reporting happens only when new instances of BaseDexClassLoader</span><br><span class="line">     * are constructed and will be active only after this field is set with</span><br><span class="line">     * &#123;@link BaseDexClassLoader#setReporter&#125;.</span><br><span class="line">     */</span><br><span class="line">    /* @NonNull */ private static volatile Reporter reporter = null;</span><br><span class="line"></span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private final DexPathList pathList;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Array of ClassLoaders that can be used to load classes and resources that the code in</span><br><span class="line">     * &#123;@code pathList&#125; may depend on. This is used to implement Android&#x27;s</span><br><span class="line">     * &lt;a href=https://developer.android.com/guide/topics/manifest/uses-library-element&gt;</span><br><span class="line">     * shared libraries&lt;/a&gt; feature.</span><br><span class="line">     * &lt;p&gt;The shared library loaders are always checked before the &#123;@code pathList&#125; when looking</span><br><span class="line">     * up classes and resources.</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;&#123;@code null&#125; if the class loader has no shared library.</span><br><span class="line">     *</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    protected final ClassLoader[] sharedLibraryLoaders;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Array of ClassLoaders identical to &#123;@code sharedLibraryLoaders&#125; except that these library</span><br><span class="line">     * loaders are always checked after the &#123;@code pathList&#125; when looking up classes and resources.</span><br><span class="line">     *</span><br><span class="line">     * The placement of a library into this group is done by the OEM and cannot be configured by</span><br><span class="line">     * an App.</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;&#123;@code null&#125; if the class loader has no shared library.</span><br><span class="line">     *</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    protected final ClassLoader[] sharedLibraryLoadersAfter;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Constructs an instance.</span><br><span class="line">     * Note that all the *.jar and *.apk files from &#123;@code dexPath&#125; might be</span><br><span class="line">     * first extracted in-memory before the code is loaded. This can be avoided</span><br><span class="line">     * by passing raw dex files (*.dex) in the &#123;@code dexPath&#125;.</span><br><span class="line">     *</span><br><span class="line">     * @param dexPath the list of jar/apk files containing classes and</span><br><span class="line">     * resources, delimited by &#123;@code File.pathSeparator&#125;, which</span><br><span class="line">     * defaults to &#123;@code &quot;:&quot;&#125; on Android.</span><br><span class="line">     * @param optimizedDirectory this parameter is deprecated and has no effect since API level 26.</span><br><span class="line">     * @param librarySearchPath the list of directories containing native</span><br><span class="line">     * libraries, delimited by &#123;@code File.pathSeparator&#125;; may be</span><br><span class="line">     * &#123;@code null&#125;</span><br><span class="line">     * @param parent the parent class loader</span><br><span class="line">     */</span><br><span class="line">    public BaseDexClassLoader(String dexPath, File optimizedDirectory,</span><br><span class="line">            String librarySearchPath, ClassLoader parent) &#123;</span><br><span class="line">        this(dexPath, librarySearchPath, parent, null, null, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    public BaseDexClassLoader(String dexPath, File optimizedDirectory,</span><br><span class="line">            String librarySearchPath, ClassLoader parent, boolean isTrusted) &#123;</span><br><span class="line">        this(dexPath, librarySearchPath, parent, null, null, isTrusted);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    public BaseDexClassLoader(String dexPath,</span><br><span class="line">            String librarySearchPath, ClassLoader parent, ClassLoader[] libraries) &#123;</span><br><span class="line">        this(dexPath, librarySearchPath, parent, libraries, null, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    public BaseDexClassLoader(String dexPath, String librarySearchPath,</span><br><span class="line">            ClassLoader parent, ClassLoader[] libraries, ClassLoader[] librariesAfter) &#123;</span><br><span class="line">        this(dexPath, librarySearchPath, parent, libraries, librariesAfter, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * BaseDexClassLoader implements the Android</span><br><span class="line">     * &lt;a href=https://developer.android.com/guide/topics/manifest/uses-library-element&gt;</span><br><span class="line">     * shared libraries&lt;/a&gt; feature by changing the typical parent delegation mechanism</span><br><span class="line">     * of class loaders.</span><br><span class="line">     * &lt;p&gt; Each shared library is associated with its own class loader, which is added to a list of</span><br><span class="line">     * class loaders this BaseDexClassLoader tries to load from in order, immediately checking</span><br><span class="line">     * after the parent.</span><br><span class="line">     * The shared library loaders are always checked before the &#123;@code pathList&#125; when looking</span><br><span class="line">     * up classes and resources.</span><br><span class="line">     * &lt;p&gt;</span><br><span class="line">     * The shared library loaders defined in sharedLibraryLoadersAfter are always checked</span><br><span class="line">     * &lt;b&gt;after&lt;/b&gt; the &#123;@code pathList&#125;</span><br><span class="line">     *</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    public BaseDexClassLoader(String dexPath,</span><br><span class="line">            String librarySearchPath, ClassLoader parent, ClassLoader[] sharedLibraryLoaders,</span><br><span class="line">            ClassLoader[] sharedLibraryLoadersAfter,</span><br><span class="line">            boolean isTrusted) &#123;</span><br><span class="line">        super(parent);</span><br><span class="line">        // Setup shared libraries before creating the path list. ART relies on the class loader</span><br><span class="line">        // hierarchy being finalized before loading dex files.</span><br><span class="line">        this.sharedLibraryLoaders = sharedLibraryLoaders == null</span><br><span class="line">                ? null</span><br><span class="line">                : Arrays.copyOf(sharedLibraryLoaders, sharedLibraryLoaders.length);</span><br><span class="line">        this.pathList = new DexPathList(this, dexPath, librarySearchPath, null, isTrusted);</span><br><span class="line"></span><br><span class="line">        this.sharedLibraryLoadersAfter = sharedLibraryLoadersAfter == null</span><br><span class="line">                ? null</span><br><span class="line">                : Arrays.copyOf(sharedLibraryLoadersAfter, sharedLibraryLoadersAfter.length);</span><br><span class="line">        // Run background verification after having set &#x27;pathList&#x27;.</span><br><span class="line">        this.pathList.maybeRunBackgroundVerification(this);</span><br><span class="line"></span><br><span class="line">        reportClassLoaderChain();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Reports the current class loader chain to the registered &#123;@code reporter&#125;.</span><br><span class="line">     *</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    @SystemApi(client = MODULE_LIBRARIES)</span><br><span class="line">    public void reportClassLoaderChain() &#123;</span><br><span class="line">        if (reporter == null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String[] classPathAndClassLoaderContexts = computeClassLoaderContextsNative();</span><br><span class="line">        if (classPathAndClassLoaderContexts.length == 0) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, String&gt; dexFileMapping =</span><br><span class="line">                new HashMap&lt;&gt;(classPathAndClassLoaderContexts.length / 2);</span><br><span class="line">        for (int i = 0; i &lt; classPathAndClassLoaderContexts.length; i += 2) &#123;</span><br><span class="line">            dexFileMapping.put(classPathAndClassLoaderContexts[i],</span><br><span class="line">                    classPathAndClassLoaderContexts[i + 1]);</span><br><span class="line">        &#125;</span><br><span class="line">        reporter.report(Collections.unmodifiableMap(dexFileMapping));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Computes the classloader contexts for each classpath entry in &#123;@code pathList.getDexPaths()&#125;.</span><br><span class="line">     *</span><br><span class="line">     * Note that this method is not thread safe, i.e. it is the responsibility of the caller to</span><br><span class="line">     * ensure that &#123;@code pathList.getDexPaths()&#125; is not modified concurrently with this method</span><br><span class="line">     * being called.</span><br><span class="line">     *</span><br><span class="line">     * @return A non-null array of non-null strings of length</span><br><span class="line">     *   &#123;@code 2 * pathList.getDexPaths().size()&#125;. Every even index (0 is even here) is a dex file</span><br><span class="line">     *   path and every odd entry is the class loader context used to load the previously listed dex</span><br><span class="line">     *   file. E.g. a result might be &#123;@code &#123; &quot;foo.dex&quot;, &quot;PCL[]&quot;, &quot;bar.dex&quot;, &quot;PCL[foo.dex]&quot; &#125; &#125;.</span><br><span class="line">     */</span><br><span class="line">    private native String[] computeClassLoaderContextsNative();</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Constructs an instance.</span><br><span class="line">     *</span><br><span class="line">     * dexFile must be an in-memory representation of a full dexFile.</span><br><span class="line">     *</span><br><span class="line">     * @param dexFiles the array of in-memory dex files containing classes.</span><br><span class="line">     * @param librarySearchPath the list of directories containing native</span><br><span class="line">     *   libraries, delimited by &#123;@code File.pathSeparator&#125;; may be &#123;@code null&#125;</span><br><span class="line">     * @param parent the parent class loader</span><br><span class="line">     *</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    public BaseDexClassLoader(ByteBuffer[] dexFiles, String librarySearchPath, ClassLoader parent) &#123;</span><br><span class="line">        super(parent);</span><br><span class="line">        this.sharedLibraryLoaders = null;</span><br><span class="line">        this.sharedLibraryLoadersAfter = null;</span><br><span class="line">        this.pathList = new DexPathList(this, librarySearchPath);</span><br><span class="line">        this.pathList.initByteBufferDexPath(dexFiles);</span><br><span class="line">        // Run background verification after having set &#x27;pathList&#x27;.</span><br><span class="line">        this.pathList.maybeRunBackgroundVerification(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123;</span><br><span class="line">        // First, check whether the class is present in our shared libraries.</span><br><span class="line">        if (sharedLibraryLoaders != null) &#123;</span><br><span class="line">            for (ClassLoader loader : sharedLibraryLoaders) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    return loader.loadClass(name);</span><br><span class="line">                &#125; catch (ClassNotFoundException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // Check whether the class in question is present in the dexPath that</span><br><span class="line">        // this classloader operates on.</span><br><span class="line">        List&lt;Throwable&gt; suppressedExceptions = new ArrayList&lt;Throwable&gt;();</span><br><span class="line">        Class c = pathList.findClass(name, suppressedExceptions);</span><br><span class="line">        if (c != null) &#123;</span><br><span class="line">            return c;</span><br><span class="line">        &#125;</span><br><span class="line">        // Now, check whether the class is present in the &quot;after&quot; shared libraries.</span><br><span class="line">        if (sharedLibraryLoadersAfter != null) &#123;</span><br><span class="line">            for (ClassLoader loader : sharedLibraryLoadersAfter) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    return loader.loadClass(name);</span><br><span class="line">                &#125; catch (ClassNotFoundException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (c == null) &#123;</span><br><span class="line">            ClassNotFoundException cnfe = new ClassNotFoundException(</span><br><span class="line">                    &quot;Didn&#x27;t find class \&quot;&quot; + name + &quot;\&quot; on path: &quot; + pathList);</span><br><span class="line">            for (Throwable t : suppressedExceptions) &#123;</span><br><span class="line">                cnfe.addSuppressed(t);</span><br><span class="line">            &#125;</span><br><span class="line">            throw cnfe;</span><br><span class="line">        &#125;</span><br><span class="line">        return c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Adds a new dex path to path list.</span><br><span class="line">     *</span><br><span class="line">     * @param dexPath dex path to add to path list</span><br><span class="line">     *</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    @SystemApi(client = MODULE_LIBRARIES)</span><br><span class="line">    public void addDexPath(@Nullable String dexPath) &#123;</span><br><span class="line">        addDexPath(dexPath, false /*isTrusted*/);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    public void addDexPath(String dexPath, boolean isTrusted) &#123;</span><br><span class="line">        pathList.addDexPath(dexPath, null /*optimizedDirectory*/, isTrusted);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Adds additional native paths for consideration in subsequent calls to</span><br><span class="line">     * &#123;@link #findLibrary(String)&#125;.</span><br><span class="line">     *</span><br><span class="line">     * @param libPaths collection of paths to be added to path list</span><br><span class="line">     *</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    @SystemApi(client = MODULE_LIBRARIES)</span><br><span class="line">    public void addNativePath(@NonNull Collection&lt;String&gt; libPaths) &#123;</span><br><span class="line">        pathList.addNativePath(libPaths);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected URL findResource(String name) &#123;</span><br><span class="line">        if (sharedLibraryLoaders != null) &#123;</span><br><span class="line">            for (ClassLoader loader : sharedLibraryLoaders) &#123;</span><br><span class="line">                URL url = loader.getResource(name);</span><br><span class="line">                if (url != null) &#123;</span><br><span class="line">                    return url;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        URL url = pathList.findResource(name);</span><br><span class="line">        if (url != null) &#123;</span><br><span class="line">            return url;</span><br><span class="line">        &#125;</span><br><span class="line">        if (sharedLibraryLoadersAfter != null) &#123;</span><br><span class="line">            for (ClassLoader loader : sharedLibraryLoadersAfter) &#123;</span><br><span class="line">                URL url2 = loader.getResource(name);</span><br><span class="line">                if (url2 != null) &#123;</span><br><span class="line">                    return url2;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected Enumeration&lt;URL&gt; findResources(String name) &#123;</span><br><span class="line">        Enumeration&lt;URL&gt; myResources = pathList.findResources(name);</span><br><span class="line">        if (sharedLibraryLoaders == null &amp;&amp; sharedLibraryLoadersAfter == null) &#123;</span><br><span class="line">          return myResources;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int sharedLibraryLoadersCount =</span><br><span class="line">                (sharedLibraryLoaders != null) ? sharedLibraryLoaders.length : 0;</span><br><span class="line">        int sharedLibraryLoadersAfterCount =</span><br><span class="line">                (sharedLibraryLoadersAfter != null) ? sharedLibraryLoadersAfter.length : 0;</span><br><span class="line"></span><br><span class="line">        Enumeration&lt;URL&gt;[] tmp =</span><br><span class="line">                (Enumeration&lt;URL&gt;[]) new Enumeration&lt;?&gt;[sharedLibraryLoadersCount +</span><br><span class="line">                        sharedLibraryLoadersAfterCount</span><br><span class="line">                        + 1];</span><br><span class="line">        // First add sharedLibrary resources.</span><br><span class="line">        // This will add duplicate resources if a shared library is loaded twice, but that&#x27;s ok</span><br><span class="line">        // as we don&#x27;t guarantee uniqueness.</span><br><span class="line">        int i = 0;</span><br><span class="line">        for (; i &lt; sharedLibraryLoadersCount; i++) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                tmp[i] = sharedLibraryLoaders[i].getResources(name);</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                // Ignore.</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // Then add resource from this dex path.</span><br><span class="line">        tmp[i++] = myResources;</span><br><span class="line"></span><br><span class="line">        // Finally add resources from shared libraries that are to be loaded after.</span><br><span class="line">        for (int j = 0; j &lt; sharedLibraryLoadersAfterCount; i++, j++) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                tmp[i] = sharedLibraryLoadersAfter[j].getResources(name);</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                // Ignore.</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return new CompoundEnumeration&lt;&gt;(tmp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String findLibrary(String name) &#123;</span><br><span class="line">        return pathList.findLibrary(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Returns package information for the given package.</span><br><span class="line">     * Unfortunately, instances of this class don&#x27;t really have this</span><br><span class="line">     * information, and as a non-secure &#123;@code ClassLoader&#125;, it isn&#x27;t</span><br><span class="line">     * even required to, according to the spec. Yet, we want to</span><br><span class="line">     * provide it, in order to make all those hopeful callers of</span><br><span class="line">     * &#123;@code myClass.getPackage().getName()&#125; happy. Thus we construct</span><br><span class="line">     * a &#123;@code Package&#125; object the first time it is being requested</span><br><span class="line">     * and fill most of the fields with fake values. The &#123;@code</span><br><span class="line">     * Package&#125; object is then put into the &#123;@code ClassLoader&#125;&#x27;s</span><br><span class="line">     * package cache, so we see the same one next time. We don&#x27;t</span><br><span class="line">     * create &#123;@code Package&#125; objects for &#123;@code null&#125; arguments or</span><br><span class="line">     * for the default package.</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;There is a limited chance that we end up with multiple</span><br><span class="line">     * &#123;@code Package&#125; objects representing the same package: It can</span><br><span class="line">     * happen when when a package is scattered across different JAR</span><br><span class="line">     * files which were loaded by different &#123;@code ClassLoader&#125;</span><br><span class="line">     * instances. This is rather unlikely, and given that this whole</span><br><span class="line">     * thing is more or less a workaround, probably not worth the</span><br><span class="line">     * effort to address.</span><br><span class="line">     *</span><br><span class="line">     * @param name the name of the class</span><br><span class="line">     * @return the package information for the class, or &#123;@code null&#125;</span><br><span class="line">     * if there is no package information available for it</span><br><span class="line">     *</span><br><span class="line">     * @deprecated See &#123;@link ClassLoader#getPackage(String)&#125;</span><br><span class="line">     */</span><br><span class="line">    @Deprecated</span><br><span class="line">    @Override</span><br><span class="line">    protected synchronized Package getPackage(String name) &#123;</span><br><span class="line">        if (name != null &amp;&amp; !name.isEmpty()) &#123;</span><br><span class="line">            Package pack = super.getPackage(name);</span><br><span class="line"></span><br><span class="line">            if (pack == null) &#123;</span><br><span class="line">                pack = definePackage(name, &quot;Unknown&quot;, &quot;0.0&quot;, &quot;Unknown&quot;,</span><br><span class="line">                        &quot;Unknown&quot;, &quot;0.0&quot;, &quot;Unknown&quot;, null);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return pack;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Returns colon-separated set of directories where libraries should be</span><br><span class="line">     * searched for first, before the standard set of directories.</span><br><span class="line">     *</span><br><span class="line">     * @return colon-separated set of search directories</span><br><span class="line">     *</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    @SystemApi(client = MODULE_LIBRARIES)</span><br><span class="line">    public @NonNull String getLdLibraryPath() &#123;</span><br><span class="line">        StringBuilder result = new StringBuilder();</span><br><span class="line">        for (File directory : pathList.getNativeLibraryDirectories()) &#123;</span><br><span class="line">            if (result.length() &gt; 0) &#123;</span><br><span class="line">                result.append(&#x27;:&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">            result.append(directory);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return result.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override public String toString() &#123;</span><br><span class="line">        return getClass().getName() + &quot;[&quot; + pathList + &quot;]&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Sets the reporter for dex load notifications.</span><br><span class="line">     * Once set, all new instances of BaseDexClassLoader will report upon</span><br><span class="line">     * constructions the loaded dex files.</span><br><span class="line">     *</span><br><span class="line">     * @param newReporter the new Reporter. Setting &#123;@code null&#125; will cancel reporting.</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    @SystemApi(client = MODULE_LIBRARIES)</span><br><span class="line">    public static void setReporter(@Nullable Reporter newReporter) &#123;</span><br><span class="line">        reporter = newReporter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    public static Reporter getReporter() &#123;</span><br><span class="line">        return reporter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Reports the construction of a &#123;@link BaseDexClassLoader&#125; and provides opaque</span><br><span class="line">     * information about the class loader chain.</span><br><span class="line">     *</span><br><span class="line">     * @hide</span><br><span class="line">     */</span><br><span class="line">    @SystemApi(client = MODULE_LIBRARIES)</span><br><span class="line">    public interface Reporter &#123;</span><br><span class="line">        /**</span><br><span class="line">         * Reports the construction of a BaseDexClassLoader and provides opaque information about</span><br><span class="line">         * the class loader chain. For example, if the childmost ClassLoader in the chain:</span><br><span class="line">         * &#123;@quote BaseDexClassLoader &#123; foo.dex &#125; -&gt; BaseDexClassLoader &#123; base.apk &#125;</span><br><span class="line">         *    -&gt; BootClassLoader &#125; was just initialized then the load of &#123;@code &quot;foo.dex&quot;&#125; would be</span><br><span class="line">         * reported with a classLoaderContext of &#123;@code &quot;PCL[];PCL[base.apk]&quot;&#125;.</span><br><span class="line">         *</span><br><span class="line">         * @param contextsMap A map from dex file paths to the class loader context used to load</span><br><span class="line">         *     each dex file.</span><br><span class="line">         *</span><br><span class="line">         * @hide</span><br><span class="line">         */</span><br><span class="line">        @SystemApi(client = MODULE_LIBRARIES)</span><br><span class="line">        void report(@NonNull Map&lt;String, String&gt; contextsMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入到basedexclassloader中 再次使用父类classloader进行加载 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Copyright (C) 2011 The Android Open Source Project</span><br><span class="line"> *</span><br><span class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> * you may not use this file except in compliance with the License.</span><br><span class="line"> * You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">package dalvik.system;</span><br><span class="line"></span><br><span class="line">import android.compat.annotation.UnsupportedAppUsage;</span><br><span class="line">import android.system.ErrnoException;</span><br><span class="line">import android.system.StructStat;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.lang.reflect.Array;</span><br><span class="line">import java.net.MalformedURLException;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.nio.ByteBuffer;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.Collection;</span><br><span class="line">import java.util.Collections;</span><br><span class="line">import java.util.Enumeration;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Objects;</span><br><span class="line">import libcore.io.ClassPathURLStreamHandler;</span><br><span class="line">import libcore.io.IoUtils;</span><br><span class="line">import libcore.io.Libcore;</span><br><span class="line"></span><br><span class="line">import static android.system.OsConstants.S_ISDIR;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * A pair of lists of entries, associated with a &#123;@code ClassLoader&#125;.</span><br><span class="line"> * One of the lists is a dex/resource path &amp;mdash; typically referred</span><br><span class="line"> * to as a &quot;class path&quot; &amp;mdash; list, and the other names directories</span><br><span class="line"> * containing native code libraries. Class path entries may be any of:</span><br><span class="line"> * a &#123;@code .jar&#125; or &#123;@code .zip&#125; file containing an optional</span><br><span class="line"> * top-level &#123;@code classes.dex&#125; file as well as arbitrary resources,</span><br><span class="line"> * or a plain &#123;@code .dex&#125; file (with no possibility of associated</span><br><span class="line"> * resources).</span><br><span class="line"> *</span><br><span class="line"> * &lt;p&gt;This class also contains methods to use these lists to look up</span><br><span class="line"> * classes and resources.&lt;/p&gt;</span><br><span class="line"> *</span><br><span class="line"> * @hide</span><br><span class="line"> */</span><br><span class="line">public final class DexPathList &#123;</span><br><span class="line">    private static final String DEX_SUFFIX = &quot;.dex&quot;;</span><br><span class="line">    private static final String zipSeparator = &quot;!/&quot;;</span><br><span class="line"></span><br><span class="line">    /** class definition context */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private final ClassLoader definingContext;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * List of dex/resource (class path) elements.</span><br><span class="line">     * Should be called pathElements, but the Facebook app uses reflection</span><br><span class="line">     * to modify &#x27;dexElements&#x27; (http://b/7726934).</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private Element[] dexElements;</span><br><span class="line"></span><br><span class="line">    /** List of native library path elements. */</span><br><span class="line">    // Some applications rely on this field being an array or we&#x27;d use a final list here</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    /* package visible for testing */ NativeLibraryElement[] nativeLibraryPathElements;</span><br><span class="line"></span><br><span class="line">    /** List of application native library directories. */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private final List&lt;File&gt; nativeLibraryDirectories;</span><br><span class="line"></span><br><span class="line">    /** List of system native library directories. */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private final List&lt;File&gt; systemNativeLibraryDirectories;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Exceptions thrown during creation of the dexElements list.</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private IOException[] dexElementsSuppressedExceptions;</span><br><span class="line"></span><br><span class="line">    private List&lt;File&gt; getAllNativeLibraryDirectories() &#123;</span><br><span class="line">        List&lt;File&gt; allNativeLibraryDirectories = new ArrayList&lt;&gt;(nativeLibraryDirectories);</span><br><span class="line">        allNativeLibraryDirectories.addAll(systemNativeLibraryDirectories);</span><br><span class="line">        return allNativeLibraryDirectories;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Construct an instance.</span><br><span class="line">     *</span><br><span class="line">     * @param definingContext the context in which any as-yet unresolved</span><br><span class="line">     * classes should be defined</span><br><span class="line">     *</span><br><span class="line">     * @param dexFiles the bytebuffers containing the dex files that we should load classes from.</span><br><span class="line">     */</span><br><span class="line">    public DexPathList(ClassLoader definingContext, String librarySearchPath) &#123;</span><br><span class="line">        if (definingContext == null) &#123;</span><br><span class="line">            throw new NullPointerException(&quot;definingContext == null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        this.definingContext = definingContext;</span><br><span class="line">        this.nativeLibraryDirectories = splitPaths(librarySearchPath, false);</span><br><span class="line">        this.systemNativeLibraryDirectories =</span><br><span class="line">                splitPaths(System.getProperty(&quot;java.library.path&quot;), true);</span><br><span class="line">        this.nativeLibraryPathElements = makePathElements(getAllNativeLibraryDirectories());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Constructs an instance.</span><br><span class="line">     *</span><br><span class="line">     * @param definingContext the context in which any as-yet unresolved</span><br><span class="line">     * classes should be defined</span><br><span class="line">     * @param dexPath list of dex/resource path elements, separated by</span><br><span class="line">     * &#123;@code File.pathSeparator&#125;</span><br><span class="line">     * @param librarySearchPath list of native library directory path elements,</span><br><span class="line">     * separated by &#123;@code File.pathSeparator&#125;</span><br><span class="line">     * @param optimizedDirectory directory where optimized &#123;@code .dex&#125; files</span><br><span class="line">     * should be found and written to, or &#123;@code null&#125; to use the default</span><br><span class="line">     * system directory for same</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    public DexPathList(ClassLoader definingContext, String dexPath,</span><br><span class="line">            String librarySearchPath, File optimizedDirectory) &#123;</span><br><span class="line">        this(definingContext, dexPath, librarySearchPath, optimizedDirectory, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DexPathList(ClassLoader definingContext, String dexPath,</span><br><span class="line">            String librarySearchPath, File optimizedDirectory, boolean isTrusted) &#123;</span><br><span class="line">        if (definingContext == null) &#123;</span><br><span class="line">            throw new NullPointerException(&quot;definingContext == null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (dexPath == null) &#123;</span><br><span class="line">            throw new NullPointerException(&quot;dexPath == null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (optimizedDirectory != null) &#123;</span><br><span class="line">            if (!optimizedDirectory.exists())  &#123;</span><br><span class="line">                throw new IllegalArgumentException(</span><br><span class="line">                        &quot;optimizedDirectory doesn&#x27;t exist: &quot;</span><br><span class="line">                        + optimizedDirectory);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!(optimizedDirectory.canRead()</span><br><span class="line">                            &amp;&amp; optimizedDirectory.canWrite())) &#123;</span><br><span class="line">                throw new IllegalArgumentException(</span><br><span class="line">                        &quot;optimizedDirectory not readable/writable: &quot;</span><br><span class="line">                        + optimizedDirectory);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        this.definingContext = definingContext;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;IOException&gt; suppressedExceptions = new ArrayList&lt;IOException&gt;();</span><br><span class="line">        // save dexPath for BaseDexClassLoader</span><br><span class="line">        this.dexElements = makeDexElements(splitDexPath(dexPath), optimizedDirectory,</span><br><span class="line">                                           suppressedExceptions, definingContext, isTrusted);</span><br><span class="line"></span><br><span class="line">        // Native libraries may exist in both the system and</span><br><span class="line">        // application library paths, and we use this search order:</span><br><span class="line">        //</span><br><span class="line">        //   1. This class loader&#x27;s library path for application libraries (librarySearchPath):</span><br><span class="line">        //   1.1. Native library directories</span><br><span class="line">        //   1.2. Path to libraries in apk-files</span><br><span class="line">        //   2. The VM&#x27;s library path from the system property for system libraries</span><br><span class="line">        //      also known as java.library.path</span><br><span class="line">        //</span><br><span class="line">        // This order was reversed prior to Gingerbread; see http://b/2933456.</span><br><span class="line">        this.nativeLibraryDirectories = splitPaths(librarySearchPath, false);</span><br><span class="line">        this.systemNativeLibraryDirectories =</span><br><span class="line">                splitPaths(System.getProperty(&quot;java.library.path&quot;), true);</span><br><span class="line">        this.nativeLibraryPathElements = makePathElements(getAllNativeLibraryDirectories());</span><br><span class="line"></span><br><span class="line">        if (suppressedExceptions.size() &gt; 0) &#123;</span><br><span class="line">            this.dexElementsSuppressedExceptions =</span><br><span class="line">                suppressedExceptions.toArray(new IOException[suppressedExceptions.size()]);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            dexElementsSuppressedExceptions = null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override public String toString() &#123;</span><br><span class="line">        return &quot;DexPathList[&quot; + Arrays.toString(dexElements) +</span><br><span class="line">            &quot;,nativeLibraryDirectories=&quot; +</span><br><span class="line">            Arrays.toString(getAllNativeLibraryDirectories().toArray()) + &quot;]&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * For BaseDexClassLoader.getLdLibraryPath.</span><br><span class="line">     */</span><br><span class="line">    public List&lt;File&gt; getNativeLibraryDirectories() &#123;</span><br><span class="line">        return nativeLibraryDirectories;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Adds a new path to this instance</span><br><span class="line">     * @param dexPath list of dex/resource path element, separated by</span><br><span class="line">     * &#123;@code File.pathSeparator&#125;</span><br><span class="line">     * @param optimizedDirectory directory where optimized &#123;@code .dex&#125; files</span><br><span class="line">     * should be found and written to, or &#123;@code null&#125; to use the default</span><br><span class="line">     * system directory for same</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    public void addDexPath(String dexPath, File optimizedDirectory) &#123;</span><br><span class="line">      addDexPath(dexPath, optimizedDirectory, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void addDexPath(String dexPath, File optimizedDirectory, boolean isTrusted) &#123;</span><br><span class="line">        final List&lt;IOException&gt; suppressedExceptionList = new ArrayList&lt;IOException&gt;();</span><br><span class="line">        final Element[] newElements = makeDexElements(splitDexPath(dexPath), optimizedDirectory,</span><br><span class="line">                suppressedExceptionList, definingContext, isTrusted);</span><br><span class="line"></span><br><span class="line">        if (newElements != null &amp;&amp; newElements.length &gt; 0) &#123;</span><br><span class="line">            dexElements = concat(Element.class, dexElements, newElements);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (suppressedExceptionList.size() &gt; 0) &#123;</span><br><span class="line">            final IOException[] newSuppExceptions = suppressedExceptionList.toArray(</span><br><span class="line">                    new IOException[suppressedExceptionList.size()]);</span><br><span class="line">            dexElementsSuppressedExceptions = dexElementsSuppressedExceptions != null</span><br><span class="line">                    ? concat(IOException.class, dexElementsSuppressedExceptions, newSuppExceptions)</span><br><span class="line">                    : newSuppExceptions;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static&lt;T&gt; T[] concat(Class&lt;T&gt; componentType, T[] inputA, T[] inputB) &#123;</span><br><span class="line">        T[] output = (T[]) Array.newInstance(componentType, inputA.length + inputB.length);</span><br><span class="line">        System.arraycopy(inputA, 0, output, 0, inputA.length);</span><br><span class="line">        System.arraycopy(inputB, 0, output, inputA.length, inputB.length);</span><br><span class="line">        return output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * For InMemoryDexClassLoader. Initializes &#123;@code dexElements&#125; with dex files</span><br><span class="line">     * loaded from &#123;@code dexFiles&#125; buffers.</span><br><span class="line">     *</span><br><span class="line">     * @param dexFiles ByteBuffers containing raw dex data. Apks are not supported.</span><br><span class="line">     */</span><br><span class="line">    /* package */ void initByteBufferDexPath(ByteBuffer[] dexFiles) &#123;</span><br><span class="line">        if (dexFiles == null) &#123;</span><br><span class="line">            throw new NullPointerException(&quot;dexFiles == null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (Arrays.stream(dexFiles).anyMatch(v -&gt; v == null)) &#123;</span><br><span class="line">            throw new NullPointerException(&quot;dexFiles contains a null Buffer!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (dexElements != null || dexElementsSuppressedExceptions != null) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;Should only be called once&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final List&lt;IOException&gt; suppressedExceptions = new ArrayList&lt;IOException&gt;();</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            Element[] null_elements = null;</span><br><span class="line">            DexFile dex = new DexFile(dexFiles, definingContext, null_elements);</span><br><span class="line">            dexElements = new Element[] &#123; new Element(dex) &#125;;</span><br><span class="line">        &#125; catch (IOException suppressed) &#123;</span><br><span class="line">            System.logE(&quot;Unable to load dex files&quot;, suppressed);</span><br><span class="line">            suppressedExceptions.add(suppressed);</span><br><span class="line">            dexElements = new Element[0];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (suppressedExceptions.size() &gt; 0) &#123;</span><br><span class="line">            dexElementsSuppressedExceptions = suppressedExceptions.toArray(</span><br><span class="line">                    new IOException[suppressedExceptions.size()]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* package */ void maybeRunBackgroundVerification(ClassLoader loader) &#123;</span><br><span class="line">        // Spawn background thread to verify all classes and cache verification results.</span><br><span class="line">        // Must be called *after* `this.dexElements` has been initialized and `loader.pathList`</span><br><span class="line">        // has been set for ART to find its classes (the fields are hardcoded in ART and dex</span><br><span class="line">        // files iterated over in the order of the array).</span><br><span class="line">        // We only spawn the background thread if the bytecode is not backed by an oat</span><br><span class="line">        // file, i.e. this is the first time this bytecode is being loaded and/or</span><br><span class="line">        // verification results have not been cached yet.</span><br><span class="line">        for (Element element : dexElements) &#123;</span><br><span class="line">            if (element.dexFile != null &amp;&amp; !element.dexFile.isBackedByOatFile()) &#123;</span><br><span class="line">                element.dexFile.verifyInBackground(loader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Splits the given dex path string into elements using the path</span><br><span class="line">     * separator, pruning out any elements that do not refer to existing</span><br><span class="line">     * and readable files.</span><br><span class="line">     */</span><br><span class="line">    private static List&lt;File&gt; splitDexPath(String path) &#123;</span><br><span class="line">        return splitPaths(path, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Splits the given path strings into file elements using the path</span><br><span class="line">     * separator, combining the results and filtering out elements</span><br><span class="line">     * that don&#x27;t exist, aren&#x27;t readable, or aren&#x27;t either a regular</span><br><span class="line">     * file or a directory (as specified). Either string may be empty</span><br><span class="line">     * or &#123;@code null&#125;, in which case it is ignored. If both strings</span><br><span class="line">     * are empty or &#123;@code null&#125;, or all elements get pruned out, then</span><br><span class="line">     * this returns a zero-element list.</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private static List&lt;File&gt; splitPaths(String searchPath, boolean directoriesOnly) &#123;</span><br><span class="line">        List&lt;File&gt; result = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        if (searchPath != null) &#123;</span><br><span class="line">            for (String path : searchPath.split(File.pathSeparator)) &#123;</span><br><span class="line">                if (directoriesOnly) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        StructStat sb = Libcore.os.stat(path);</span><br><span class="line">                        if (!S_ISDIR(sb.st_mode)) &#123;</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; catch (ErrnoException ignored) &#123;</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                result.add(new File(path));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // This method is not used anymore. Kept around only because there are many legacy users of it.</span><br><span class="line">    @SuppressWarnings(&quot;unused&quot;)</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    public static Element[] makeInMemoryDexElements(ByteBuffer[] dexFiles,</span><br><span class="line">            List&lt;IOException&gt; suppressedExceptions) &#123;</span><br><span class="line">        Element[] elements = new Element[dexFiles.length];</span><br><span class="line">        int elementPos = 0;</span><br><span class="line">        for (ByteBuffer buf : dexFiles) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                DexFile dex = new DexFile(new ByteBuffer[] &#123; buf &#125;, /* classLoader */ null,</span><br><span class="line">                        /* dexElements */ null);</span><br><span class="line">                elements[elementPos++] = new Element(dex);</span><br><span class="line">            &#125; catch (IOException suppressed) &#123;</span><br><span class="line">                System.logE(&quot;Unable to load dex file: &quot; + buf, suppressed);</span><br><span class="line">                suppressedExceptions.add(suppressed);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (elementPos != elements.length) &#123;</span><br><span class="line">            elements = Arrays.copyOf(elements, elementPos);</span><br><span class="line">        &#125;</span><br><span class="line">        return elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Makes an array of dex/resource path elements, one per element of</span><br><span class="line">     * the given array.</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private static Element[] makeDexElements(List&lt;File&gt; files, File optimizedDirectory,</span><br><span class="line">            List&lt;IOException&gt; suppressedExceptions, ClassLoader loader) &#123;</span><br><span class="line">        return makeDexElements(files, optimizedDirectory, suppressedExceptions, loader, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private static Element[] makeDexElements(List&lt;File&gt; files, File optimizedDirectory,</span><br><span class="line">            List&lt;IOException&gt; suppressedExceptions, ClassLoader loader, boolean isTrusted) &#123;</span><br><span class="line">      Element[] elements = new Element[files.size()];</span><br><span class="line">      int elementsPos = 0;</span><br><span class="line">      /*</span><br><span class="line">       * Open all files and load the (direct or contained) dex files up front.</span><br><span class="line">       */</span><br><span class="line">      for (File file : files) &#123;</span><br><span class="line">          if (file.isDirectory()) &#123;</span><br><span class="line">              // We support directories for looking up resources. Looking up resources in</span><br><span class="line">              // directories is useful for running libcore tests.</span><br><span class="line">              elements[elementsPos++] = new Element(file);</span><br><span class="line">          &#125; else if (file.isFile()) &#123;</span><br><span class="line">              String name = file.getName();</span><br><span class="line"></span><br><span class="line">              DexFile dex = null;</span><br><span class="line">              if (name.endsWith(DEX_SUFFIX)) &#123;</span><br><span class="line">                  // Raw dex file (not inside a zip/jar).</span><br><span class="line">                  try &#123;</span><br><span class="line">                      dex = loadDexFile(file, optimizedDirectory, loader, elements);</span><br><span class="line">                      if (dex != null) &#123;</span><br><span class="line">                          elements[elementsPos++] = new Element(dex, null);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; catch (IOException suppressed) &#123;</span><br><span class="line">                      System.logE(&quot;Unable to load dex file: &quot; + file, suppressed);</span><br><span class="line">                      suppressedExceptions.add(suppressed);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  try &#123;</span><br><span class="line">                      dex = loadDexFile(file, optimizedDirectory, loader, elements);</span><br><span class="line">                  &#125; catch (IOException suppressed) &#123;</span><br><span class="line">                      /*</span><br><span class="line">                       * IOException might get thrown &quot;legitimately&quot; by the DexFile constructor if</span><br><span class="line">                       * the zip file turns out to be resource-only (that is, no classes.dex file</span><br><span class="line">                       * in it).</span><br><span class="line">                       * Let dex == null and hang on to the exception to add to the tea-leaves for</span><br><span class="line">                       * when findClass returns null.</span><br><span class="line">                       */</span><br><span class="line">                      suppressedExceptions.add(suppressed);</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  if (dex == null) &#123;</span><br><span class="line">                      elements[elementsPos++] = new Element(file);</span><br><span class="line">                  &#125; else &#123;</span><br><span class="line">                      elements[elementsPos++] = new Element(dex, file);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              if (dex != null &amp;&amp; isTrusted) &#123;</span><br><span class="line">                dex.setTrusted();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">              System.logW(&quot;ClassLoader referenced unknown path: &quot; + file);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (elementsPos != elements.length) &#123;</span><br><span class="line">          elements = Arrays.copyOf(elements, elementsPos);</span><br><span class="line">      &#125;</span><br><span class="line">      return elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Constructs a &#123;@code DexFile&#125; instance, as appropriate depending on whether</span><br><span class="line">     * &#123;@code optimizedDirectory&#125; is &#123;@code null&#125;. An application image file may be associated with</span><br><span class="line">     * the &#123;@code loader&#125; if it is not null.</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private static DexFile loadDexFile(File file, File optimizedDirectory, ClassLoader loader,</span><br><span class="line">                                       Element[] elements)</span><br><span class="line">            throws IOException &#123;</span><br><span class="line">        if (optimizedDirectory == null) &#123;</span><br><span class="line">            return new DexFile(file, loader, elements);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            String optimizedPath = optimizedPathFor(file, optimizedDirectory);</span><br><span class="line">            return DexFile.loadDex(file.getPath(), optimizedPath, 0, loader, elements);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Converts a dex/jar file path and an output directory to an</span><br><span class="line">     * output file path for an associated optimized dex file.</span><br><span class="line">     */</span><br><span class="line">    private static String optimizedPathFor(File path,</span><br><span class="line">            File optimizedDirectory) &#123;</span><br><span class="line">        /*</span><br><span class="line">         * Get the filename component of the path, and replace the</span><br><span class="line">         * suffix with &quot;.dex&quot; if that&#x27;s not already the suffix.</span><br><span class="line">         *</span><br><span class="line">         * We don&#x27;t want to use &quot;.odex&quot;, because the build system uses</span><br><span class="line">         * that for files that are paired with resource-only jar</span><br><span class="line">         * files. If the VM can assume that there&#x27;s no classes.dex in</span><br><span class="line">         * the matching jar, it doesn&#x27;t need to open the jar to check</span><br><span class="line">         * for updated dependencies, providing a slight performance</span><br><span class="line">         * boost at startup. The use of &quot;.dex&quot; here matches the use on</span><br><span class="line">         * files in /data/dalvik-cache.</span><br><span class="line">         */</span><br><span class="line">        String fileName = path.getName();</span><br><span class="line">        if (!fileName.endsWith(DEX_SUFFIX)) &#123;</span><br><span class="line">            int lastDot = fileName.lastIndexOf(&quot;.&quot;);</span><br><span class="line">            if (lastDot &lt; 0) &#123;</span><br><span class="line">                fileName += DEX_SUFFIX;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                StringBuilder sb = new StringBuilder(lastDot + 4);</span><br><span class="line">                sb.append(fileName, 0, lastDot);</span><br><span class="line">                sb.append(DEX_SUFFIX);</span><br><span class="line">                fileName = sb.toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        File result = new File(optimizedDirectory, fileName);</span><br><span class="line">        return result.getPath();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * TODO (dimitry): Revert after apps stops relying on the existence of this</span><br><span class="line">     * method (see http://b/21957414 and http://b/26317852 for details)</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    @SuppressWarnings(&quot;unused&quot;)</span><br><span class="line">    private static Element[] makePathElements(List&lt;File&gt; files, File optimizedDirectory,</span><br><span class="line">            List&lt;IOException&gt; suppressedExceptions) &#123;</span><br><span class="line">        return makeDexElements(files, optimizedDirectory, suppressedExceptions, null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Makes an array of directory/zip path elements for the native library search path, one per</span><br><span class="line">     * element of the given array.</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private static NativeLibraryElement[] makePathElements(List&lt;File&gt; files) &#123;</span><br><span class="line">        NativeLibraryElement[] elements = new NativeLibraryElement[files.size()];</span><br><span class="line">        int elementsPos = 0;</span><br><span class="line">        for (File file : files) &#123;</span><br><span class="line">            String path = file.getPath();</span><br><span class="line"></span><br><span class="line">            if (path.contains(zipSeparator)) &#123;</span><br><span class="line">                String split[] = path.split(zipSeparator, 2);</span><br><span class="line">                File zip = new File(split[0]);</span><br><span class="line">                String dir = split[1];</span><br><span class="line">                elements[elementsPos++] = new NativeLibraryElement(zip, dir);</span><br><span class="line">            &#125; else if (file.isDirectory()) &#123;</span><br><span class="line">                // We support directories for looking up native libraries.</span><br><span class="line">                elements[elementsPos++] = new NativeLibraryElement(file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (elementsPos != elements.length) &#123;</span><br><span class="line">            elements = Arrays.copyOf(elements, elementsPos);</span><br><span class="line">        &#125;</span><br><span class="line">        return elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Finds the named class in one of the dex files pointed at by</span><br><span class="line">     * this instance. This will find the one in the earliest listed</span><br><span class="line">     * path element. If the class is found but has not yet been</span><br><span class="line">     * defined, then this method will define it in the defining</span><br><span class="line">     * context that this instance was constructed with.</span><br><span class="line">     *</span><br><span class="line">     * @param name of class to find</span><br><span class="line">     * @param suppressed exceptions encountered whilst finding the class</span><br><span class="line">     * @return the named class or &#123;@code null&#125; if the class is not</span><br><span class="line">     * found in any of the dex files</span><br><span class="line">     */</span><br><span class="line">    public Class&lt;?&gt; findClass(String name, List&lt;Throwable&gt; suppressed) &#123;</span><br><span class="line">        for (Element element : dexElements) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = element.findClass(name, definingContext, suppressed);</span><br><span class="line">            if (clazz != null) &#123;</span><br><span class="line">                return clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (dexElementsSuppressedExceptions != null) &#123;</span><br><span class="line">            suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Finds the named resource in one of the zip/jar files pointed at</span><br><span class="line">     * by this instance. This will find the one in the earliest listed</span><br><span class="line">     * path element.</span><br><span class="line">     *</span><br><span class="line">     * @return a URL to the named resource or &#123;@code null&#125; if the</span><br><span class="line">     * resource is not found in any of the zip/jar files</span><br><span class="line">     */</span><br><span class="line">    public URL findResource(String name) &#123;</span><br><span class="line">        for (Element element : dexElements) &#123;</span><br><span class="line">            URL url = element.findResource(name);</span><br><span class="line">            if (url != null) &#123;</span><br><span class="line">                return url;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Finds all the resources with the given name, returning an</span><br><span class="line">     * enumeration of them. If there are no resources with the given</span><br><span class="line">     * name, then this method returns an empty enumeration.</span><br><span class="line">     */</span><br><span class="line">    public Enumeration&lt;URL&gt; findResources(String name) &#123;</span><br><span class="line">        ArrayList&lt;URL&gt; result = new ArrayList&lt;URL&gt;();</span><br><span class="line"></span><br><span class="line">        for (Element element : dexElements) &#123;</span><br><span class="line">            URL url = element.findResource(name);</span><br><span class="line">            if (url != null) &#123;</span><br><span class="line">                result.add(url);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return Collections.enumeration(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Finds the named native code library on any of the library</span><br><span class="line">     * directories pointed at by this instance. This will find the</span><br><span class="line">     * one in the earliest listed directory, ignoring any that are not</span><br><span class="line">     * readable regular files.</span><br><span class="line">     *</span><br><span class="line">     * @return the complete path to the library or &#123;@code null&#125; if no</span><br><span class="line">     * library was found</span><br><span class="line">     */</span><br><span class="line">    public String findLibrary(String libraryName) &#123;</span><br><span class="line">        String fileName = System.mapLibraryName(libraryName);</span><br><span class="line"></span><br><span class="line">        for (NativeLibraryElement element : nativeLibraryPathElements) &#123;</span><br><span class="line">            String path = element.findNativeLibrary(fileName);</span><br><span class="line"></span><br><span class="line">            if (path != null) &#123;</span><br><span class="line">                return path;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Returns the list of all individual dex files paths from the current list.</span><br><span class="line">     * The list will contain only file paths (i.e. no directories).</span><br><span class="line">     */</span><br><span class="line">    /*package*/ List&lt;String&gt; getDexPaths() &#123;</span><br><span class="line">        List&lt;String&gt; dexPaths = new ArrayList&lt;String&gt;();</span><br><span class="line">        for (Element e : dexElements) &#123;</span><br><span class="line">            String dexPath = e.getDexPath();</span><br><span class="line">            if (dexPath != null) &#123;</span><br><span class="line">                // Add the element to the list only if it is a file. A null dex path signals the</span><br><span class="line">                // element is a resource directory or an in-memory dex file.</span><br><span class="line">                dexPaths.add(dexPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dexPaths;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Adds a collection of library paths from which to load native libraries. Paths can be absolute</span><br><span class="line">     * native library directories (i.e. /data/app/foo/lib/arm64) or apk references (i.e.</span><br><span class="line">     * /data/app/foo/base.apk!/lib/arm64).</span><br><span class="line">     *</span><br><span class="line">     * Note: This method will attempt to dedupe elements.</span><br><span class="line">     * Note: This method replaces the value of &#123;@link #nativeLibraryPathElements&#125;</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    public void addNativePath(Collection&lt;String&gt; libPaths) &#123;</span><br><span class="line">        if (libPaths.isEmpty()) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;File&gt; libFiles = new ArrayList&lt;&gt;(libPaths.size());</span><br><span class="line">        for (String path : libPaths) &#123;</span><br><span class="line">            libFiles.add(new File(path));</span><br><span class="line">        &#125;</span><br><span class="line">        ArrayList&lt;NativeLibraryElement&gt; newPaths =</span><br><span class="line">                new ArrayList&lt;&gt;(nativeLibraryPathElements.length + libPaths.size());</span><br><span class="line">        newPaths.addAll(Arrays.asList(nativeLibraryPathElements));</span><br><span class="line">        for (NativeLibraryElement element : makePathElements(libFiles)) &#123;</span><br><span class="line">            if (!newPaths.contains(element)) &#123;</span><br><span class="line">                newPaths.add(element);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        nativeLibraryPathElements = newPaths.toArray(new NativeLibraryElement[newPaths.size()]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Element of the dex/resource path. Note: should be called DexElement, but apps reflect on</span><br><span class="line">     * this.</span><br><span class="line">     */</span><br><span class="line">    /*package*/ static class Element &#123;</span><br><span class="line">        /**</span><br><span class="line">         * A file denoting a zip file (in case of a resource jar or a dex jar), or a directory</span><br><span class="line">         * (only when dexFile is null).</span><br><span class="line">         */</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        private final File path;</span><br><span class="line">        /** Whether &#123;@code path.isDirectory()&#125;, or &#123;@code null&#125; if &#123;@code path == null&#125;. */</span><br><span class="line">        private final Boolean pathIsDirectory;</span><br><span class="line"></span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        private final DexFile dexFile;</span><br><span class="line"></span><br><span class="line">        private ClassPathURLStreamHandler urlHandler;</span><br><span class="line">        private boolean initialized;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * Element encapsulates a dex file. This may be a plain dex file (in which case dexZipPath</span><br><span class="line">         * should be null), or a jar (in which case dexZipPath should denote the zip file).</span><br><span class="line">         */</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        public Element(DexFile dexFile, File dexZipPath) &#123;</span><br><span class="line">            if (dexFile == null &amp;&amp; dexZipPath == null) &#123;</span><br><span class="line">                throw new NullPointerException(&quot;Either dexFile or path must be non-null&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            this.dexFile = dexFile;</span><br><span class="line">            this.path = dexZipPath;</span><br><span class="line">            // Do any I/O in the constructor so we don&#x27;t have to do it elsewhere, eg. toString().</span><br><span class="line">            this.pathIsDirectory = (path == null) ? null : path.isDirectory();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Element(DexFile dexFile) &#123;</span><br><span class="line">            this(dexFile, null);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Element(File path) &#123;</span><br><span class="line">            this(null, path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * Constructor for a bit of backwards compatibility. Some apps use reflection into</span><br><span class="line">         * internal APIs. Warn, and emulate old behavior if we can. See b/33399341.</span><br><span class="line">         *</span><br><span class="line">         * @deprecated The Element class has been split. Use new Element constructors for</span><br><span class="line">         *             classes and resources, and NativeLibraryElement for the library</span><br><span class="line">         *             search path.</span><br><span class="line">         */</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        @Deprecated</span><br><span class="line">        public Element(File dir, boolean isDirectory, File zip, DexFile dexFile) &#123;</span><br><span class="line">            this(dir != null ? null : dexFile, dir != null ? dir : zip);</span><br><span class="line">            System.err.println(&quot;Warning: Using deprecated Element constructor. Do not use internal&quot;</span><br><span class="line">                    + &quot; APIs, this constructor will be removed in the future.&quot;);</span><br><span class="line">            if (dir != null &amp;&amp; (zip != null || dexFile != null)) &#123;</span><br><span class="line">                throw new IllegalArgumentException(&quot;Using dir and zip|dexFile no longer&quot;</span><br><span class="line">                        + &quot; supported.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            if (isDirectory &amp;&amp; (zip != null || dexFile != null)) &#123;</span><br><span class="line">                throw new IllegalArgumentException(&quot;Unsupported argument combination.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">         * Returns the dex path of this element or null if the element refers to a directory.</span><br><span class="line">         */</span><br><span class="line">        private String getDexPath() &#123;</span><br><span class="line">            if (path != null) &#123;</span><br><span class="line">                return path.isDirectory() ? null : path.getAbsolutePath();</span><br><span class="line">            &#125; else if (dexFile != null) &#123;</span><br><span class="line">                // DexFile.getName() returns the path of the dex file.</span><br><span class="line">                return dexFile.getName();</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public String toString() &#123;</span><br><span class="line">            if (dexFile == null) &#123;</span><br><span class="line">              return (pathIsDirectory ? &quot;directory \&quot;&quot; : &quot;zip file \&quot;&quot;) + path + &quot;\&quot;&quot;;</span><br><span class="line">            &#125; else if (path == null) &#123;</span><br><span class="line">              return &quot;dex file \&quot;&quot; + dexFile + &quot;\&quot;&quot;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              return &quot;zip file \&quot;&quot; + path + &quot;\&quot;&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public synchronized void maybeInit() &#123;</span><br><span class="line">            if (initialized) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (path == null || pathIsDirectory) &#123;</span><br><span class="line">                initialized = true;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                // Disable zip path validation for loading APKs as it does not pose a risk of the</span><br><span class="line">                // zip path traversal vulnerability.</span><br><span class="line">                urlHandler = new ClassPathURLStreamHandler(path.getPath(),</span><br><span class="line">                        /* enableZipPathValidator */ false);</span><br><span class="line">            &#125; catch (IOException ioe) &#123;</span><br><span class="line">                /*</span><br><span class="line">                 * Note: ZipException (a subclass of IOException)</span><br><span class="line">                 * might get thrown by the ZipFile constructor</span><br><span class="line">                 * (e.g. if the file isn&#x27;t actually a zip/jar</span><br><span class="line">                 * file).</span><br><span class="line">                 */</span><br><span class="line">                System.logE(&quot;Unable to open zip file: &quot; + path, ioe);</span><br><span class="line">                urlHandler = null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Mark this element as initialized only after we&#x27;ve successfully created</span><br><span class="line">            // the associated ClassPathURLStreamHandler. That way, we won&#x27;t leave this</span><br><span class="line">            // element in an inconsistent state if an exception is thrown during initialization.</span><br><span class="line">            //</span><br><span class="line">            // See b/35633614.</span><br><span class="line">            initialized = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Class&lt;?&gt; findClass(String name, ClassLoader definingContext,</span><br><span class="line">                List&lt;Throwable&gt; suppressed) &#123;</span><br><span class="line">            return dexFile != null ? dexFile.loadClassBinaryName(name, definingContext, suppressed)</span><br><span class="line">                    : null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public URL findResource(String name) &#123;</span><br><span class="line">            maybeInit();</span><br><span class="line"></span><br><span class="line">            if (urlHandler != null) &#123;</span><br><span class="line">              return urlHandler.getEntryUrlOrNull(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // We support directories so we can run tests and/or legacy code</span><br><span class="line">            // that uses Class.getResource.</span><br><span class="line">            if (path != null &amp;&amp; path.isDirectory()) &#123;</span><br><span class="line">                File resourceFile = new File(path, name);</span><br><span class="line">                if (resourceFile.exists()) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        return resourceFile.toURI().toURL();</span><br><span class="line">                    &#125; catch (MalformedURLException ex) &#123;</span><br><span class="line">                        throw new RuntimeException(ex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Element of the native library path</span><br><span class="line">     */</span><br><span class="line">    /*package*/ static class NativeLibraryElement &#123;</span><br><span class="line">        /**</span><br><span class="line">         * A file denoting a directory or zip file.</span><br><span class="line">         */</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        private final File path;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * If path denotes a zip file, this denotes a base path inside the zip.</span><br><span class="line">         */</span><br><span class="line">        private final String zipDir;</span><br><span class="line"></span><br><span class="line">        private ClassPathURLStreamHandler urlHandler;</span><br><span class="line">        private boolean initialized;</span><br><span class="line"></span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        public NativeLibraryElement(File dir) &#123;</span><br><span class="line">            this.path = dir;</span><br><span class="line">            this.zipDir = null;</span><br><span class="line"></span><br><span class="line">            // We should check whether path is a directory, but that is non-eliminatable overhead.</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public NativeLibraryElement(File zip, String zipDir) &#123;</span><br><span class="line">            this.path = zip;</span><br><span class="line">            this.zipDir = zipDir;</span><br><span class="line"></span><br><span class="line">            // Simple check that should be able to be eliminated by inlining. We should also</span><br><span class="line">            // check whether path is a file, but that is non-eliminatable overhead.</span><br><span class="line">            if (zipDir == null) &#123;</span><br><span class="line">              throw new IllegalArgumentException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public String toString() &#123;</span><br><span class="line">            if (zipDir == null) &#123;</span><br><span class="line">                return &quot;directory \&quot;&quot; + path + &quot;\&quot;&quot;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return &quot;zip file \&quot;&quot; + path + &quot;\&quot;&quot; +</span><br><span class="line">                  (!zipDir.isEmpty() ? &quot;, dir \&quot;&quot; + zipDir + &quot;\&quot;&quot; : &quot;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public synchronized void maybeInit() &#123;</span><br><span class="line">            if (initialized) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (zipDir == null) &#123;</span><br><span class="line">                initialized = true;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                // Disable zip path validation for loading APKs as it does not pose a risk of the</span><br><span class="line">                // zip path traversal vulnerability.</span><br><span class="line">                urlHandler = new ClassPathURLStreamHandler(path.getPath(),</span><br><span class="line">                        /* enableZipPathValidator */ false);</span><br><span class="line">            &#125; catch (IOException ioe) &#123;</span><br><span class="line">                /*</span><br><span class="line">                 * Note: ZipException (a subclass of IOException)</span><br><span class="line">                 * might get thrown by the ZipFile constructor</span><br><span class="line">                 * (e.g. if the file isn&#x27;t actually a zip/jar</span><br><span class="line">                 * file).</span><br><span class="line">                 */</span><br><span class="line">                System.logE(&quot;Unable to open zip file: &quot; + path, ioe);</span><br><span class="line">                urlHandler = null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Mark this element as initialized only after we&#x27;ve successfully created</span><br><span class="line">            // the associated ClassPathURLStreamHandler. That way, we won&#x27;t leave this</span><br><span class="line">            // element in an inconsistent state if an exception is thrown during initialization.</span><br><span class="line">            //</span><br><span class="line">            // See b/35633614.</span><br><span class="line">            initialized = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public String findNativeLibrary(String name) &#123;</span><br><span class="line">            maybeInit();</span><br><span class="line"></span><br><span class="line">            if (zipDir == null) &#123;</span><br><span class="line">                String entryPath = new File(path, name).getPath();</span><br><span class="line">                if (IoUtils.canOpenReadOnly(entryPath)) &#123;</span><br><span class="line">                    return entryPath;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (urlHandler != null) &#123;</span><br><span class="line">                // Having a urlHandler means the element has a zip file.</span><br><span class="line">                // In this case Android supports loading the library iff</span><br><span class="line">                // it is stored in the zip uncompressed.</span><br><span class="line">                String entryName = zipDir + &#x27;/&#x27; + name;</span><br><span class="line">                if (urlHandler.isEntryStored(entryName)) &#123;</span><br><span class="line">                  return path.getPath() + zipSeparator + entryName;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public boolean equals(Object o) &#123;</span><br><span class="line">            if (this == o) return true;</span><br><span class="line">            if (!(o instanceof NativeLibraryElement)) return false;</span><br><span class="line">            NativeLibraryElement that = (NativeLibraryElement) o;</span><br><span class="line">            return Objects.equals(path, that.path) &amp;&amp;</span><br><span class="line">                    Objects.equals(zipDir, that.zipDir);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public int hashCode() &#123;</span><br><span class="line">            return Objects.hash(path, zipDir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里是为了查看 在安卓7中dexfile存在getbyte方法可以直接得到对应的dex字节码 对应的也就是fdex2对应的脱壳手段</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250919143337-hn696zu.png" alt="image"></p>
<p>跟进dexfile中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DexFile(String fileName, ClassLoader loader, DexPathList.Element[] elements)</span><br><span class="line">          throws IOException &#123;</span><br><span class="line">      mCookie = openDexFile(fileName, null, 0, loader, elements);</span><br><span class="line">      mInternalCookie = mCookie;</span><br><span class="line">      mFileName = fileName;</span><br><span class="line">      //System.out.println(&quot;DEX FILE cookie is &quot; + mCookie + &quot; fileName=&quot; + fileName);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>发现mCookie 也是一个脱壳点</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250919144845-djps3xo.png" alt="image"></p>
<p>继续跟进</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250919144904-1bequ76.png" alt="image"></p>
<p>这时候就是native的函数了</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250919145228-efw44qv.png" alt="image"></p>
<p>进入art进行查看 这里是进行了函数的注册 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250919145421-boh5yi2.png" alt="image"></p>
<p>这里就是进行了类目和方法名的拼接 也就是我们常看见的so中的导出函数的形式 那么他正确的函数名为dexfile_openDexFileNative</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250919145622-f5go1na.png" alt="image"></p>
<p>在这里进行 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">static jobject DexFile_openInMemoryDexFilesNative(JNIEnv* env,</span><br><span class="line">                                                  jclass,</span><br><span class="line">                                                  jobjectArray buffers,</span><br><span class="line">                                                  jobjectArray arrays,</span><br><span class="line">                                                  jintArray jstarts,</span><br><span class="line">                                                  jintArray jends,</span><br><span class="line">                                                  jobject class_loader,</span><br><span class="line">                                                  jobjectArray dex_elements) &#123;</span><br><span class="line">  jsize buffers_length = env-&gt;GetArrayLength(buffers);</span><br><span class="line">  CHECK_EQ(buffers_length, env-&gt;GetArrayLength(arrays));</span><br><span class="line">  CHECK_EQ(buffers_length, env-&gt;GetArrayLength(jstarts));</span><br><span class="line">  CHECK_EQ(buffers_length, env-&gt;GetArrayLength(jends));</span><br><span class="line"></span><br><span class="line">  ScopedIntArrayAccessor starts(env, jstarts);</span><br><span class="line">  ScopedIntArrayAccessor ends(env, jends);</span><br><span class="line"></span><br><span class="line">  // Allocate memory for dex files and copy data from ByteBuffers.</span><br><span class="line">  std::vector&lt;MemMap&gt; dex_mem_maps;</span><br><span class="line">  dex_mem_maps.reserve(buffers_length);</span><br><span class="line">  for (jsize i = 0; i &lt; buffers_length; ++i) &#123;</span><br><span class="line">    jobject buffer = env-&gt;GetObjectArrayElement(buffers, i);</span><br><span class="line">    jbyteArray array = reinterpret_cast&lt;jbyteArray&gt;(env-&gt;GetObjectArrayElement(arrays, i));</span><br><span class="line">    jint start = starts.Get(i);</span><br><span class="line">    jint end = ends.Get(i);</span><br><span class="line"></span><br><span class="line">    MemMap dex_data = AllocateDexMemoryMap(env, start, end);</span><br><span class="line">    if (!dex_data.IsValid()) &#123;</span><br><span class="line">      DCHECK(Thread::Current()-&gt;IsExceptionPending());</span><br><span class="line">      return nullptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (array == nullptr) &#123;</span><br><span class="line">      // Direct ByteBuffer</span><br><span class="line">      uint8_t* base_address = reinterpret_cast&lt;uint8_t*&gt;(env-&gt;GetDirectBufferAddress(buffer));</span><br><span class="line">      if (base_address == nullptr) &#123;</span><br><span class="line">        ScopedObjectAccess soa(env);</span><br><span class="line">        ThrowWrappedIOException(&quot;dexFileBuffer not direct&quot;);</span><br><span class="line">        return nullptr;</span><br><span class="line">      &#125;</span><br><span class="line">      size_t length = static_cast&lt;size_t&gt;(end - start);</span><br><span class="line">      memcpy(dex_data.Begin(), base_address + start, length);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // ByteBuffer backed by a byte array</span><br><span class="line">      jbyte* destination = reinterpret_cast&lt;jbyte*&gt;(dex_data.Begin());</span><br><span class="line">      env-&gt;GetByteArrayRegion(array, start, end - start, destination);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dex_mem_maps.push_back(std::move(dex_data));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Hand MemMaps over to OatFileManager to open the dex files and potentially</span><br><span class="line">  // create a backing OatFile instance from an anonymous vdex.</span><br><span class="line">  std::vector&lt;std::string&gt; error_msgs;</span><br><span class="line">  const OatFile* oat_file = nullptr;</span><br><span class="line">  std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt; dex_files =</span><br><span class="line">      Runtime::Current()-&gt;GetOatFileManager().OpenDexFilesFromOat(std::move(dex_mem_maps),</span><br><span class="line">                                                                  class_loader,</span><br><span class="line">                                                                  dex_elements,</span><br><span class="line">                                                                  /*out*/ &amp;oat_file,</span><br><span class="line">                                                                  /*out*/ &amp;error_msgs);</span><br><span class="line">  return CreateCookieFromOatFileManagerResult(env, dex_files, oat_file, error_msgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回含有dex信息的cookie CreateCookieFromOatFileManagerResult创建的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">static jobject CreateCookieFromOatFileManagerResult(</span><br><span class="line">    JNIEnv* env,</span><br><span class="line">    std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt;&amp; dex_files,</span><br><span class="line">    const OatFile* oat_file,</span><br><span class="line">    const std::vector&lt;std::string&gt;&amp; error_msgs) &#123;</span><br><span class="line">  ClassLinker* linker = Runtime::Current()-&gt;GetClassLinker();</span><br><span class="line">  if (dex_files.empty()) &#123;</span><br><span class="line">    ScopedObjectAccess soa(env);</span><br><span class="line">    CHECK(!error_msgs.empty());</span><br><span class="line">    // The most important message is at the end. So set up nesting by going forward, which will</span><br><span class="line">    // wrap the existing exception as a cause for the following one.</span><br><span class="line">    auto it = error_msgs.begin();</span><br><span class="line">    auto itEnd = error_msgs.end();</span><br><span class="line">    for ( ; it != itEnd; ++it) &#123;</span><br><span class="line">      ThrowWrappedIOException(&quot;%s&quot;, it-&gt;c_str());</span><br><span class="line">    &#125;</span><br><span class="line">    return nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  jlongArray array = ConvertDexFilesToJavaArray(env, oat_file, dex_files);</span><br><span class="line">  if (array == nullptr) &#123;</span><br><span class="line">    ScopedObjectAccess soa(env);</span><br><span class="line">    for (auto&amp; dex_file : dex_files) &#123;</span><br><span class="line">      if (linker-&gt;IsDexFileRegistered(soa.Self(), *dex_file)) &#123;</span><br><span class="line">        dex_file.release();  // NOLINT</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mcookie就含有dexfile的信息可以进行脱壳</p>
<p>接下来查看OpenDexFilesFromOat</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Copyright (C) 2015 The Android Open Source Project</span><br><span class="line"> *</span><br><span class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> * you may not use this file except in compliance with the License.</span><br><span class="line"> * You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">#include &quot;oat_file_manager.h&quot;</span><br><span class="line"></span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;memory&gt;</span><br><span class="line">#include &lt;queue&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line"></span><br><span class="line">#include &quot;android-base/file.h&quot;</span><br><span class="line">#include &quot;android-base/stringprintf.h&quot;</span><br><span class="line">#include &quot;android-base/strings.h&quot;</span><br><span class="line">#include &quot;art_field-inl.h&quot;</span><br><span class="line">#include &quot;base/bit_vector-inl.h&quot;</span><br><span class="line">#include &quot;base/file_utils.h&quot;</span><br><span class="line">#include &quot;base/logging.h&quot;  // For VLOG.</span><br><span class="line">#include &quot;base/mutex-inl.h&quot;</span><br><span class="line">#include &quot;base/sdk_version.h&quot;</span><br><span class="line">#include &quot;base/stl_util.h&quot;</span><br><span class="line">#include &quot;base/systrace.h&quot;</span><br><span class="line">#include &quot;class_linker.h&quot;</span><br><span class="line">#include &quot;class_loader_context.h&quot;</span><br><span class="line">#include &quot;dex/art_dex_file_loader.h&quot;</span><br><span class="line">#include &quot;dex/dex_file-inl.h&quot;</span><br><span class="line">#include &quot;dex/dex_file_loader.h&quot;</span><br><span class="line">#include &quot;dex/dex_file_tracking_registrar.h&quot;</span><br><span class="line">#include &quot;gc/scoped_gc_critical_section.h&quot;</span><br><span class="line">#include &quot;gc/space/image_space.h&quot;</span><br><span class="line">#include &quot;handle_scope-inl.h&quot;</span><br><span class="line">#include &quot;jit/jit.h&quot;</span><br><span class="line">#include &quot;jni/java_vm_ext.h&quot;</span><br><span class="line">#include &quot;jni/jni_internal.h&quot;</span><br><span class="line">#include &quot;mirror/class_loader.h&quot;</span><br><span class="line">#include &quot;mirror/object-inl.h&quot;</span><br><span class="line">#include &quot;oat_file.h&quot;</span><br><span class="line">#include &quot;oat_file_assistant.h&quot;</span><br><span class="line">#include &quot;obj_ptr-inl.h&quot;</span><br><span class="line">#include &quot;runtime_image.h&quot;</span><br><span class="line">#include &quot;scoped_thread_state_change-inl.h&quot;</span><br><span class="line">#include &quot;thread-current-inl.h&quot;</span><br><span class="line">#include &quot;thread_list.h&quot;</span><br><span class="line">#include &quot;thread_pool.h&quot;</span><br><span class="line">#include &quot;vdex_file.h&quot;</span><br><span class="line">#include &quot;verifier/verifier_deps.h&quot;</span><br><span class="line">#include &quot;well_known_classes.h&quot;</span><br><span class="line"></span><br><span class="line">namespace art HIDDEN &#123;</span><br><span class="line"></span><br><span class="line">using android::base::StringPrintf;</span><br><span class="line"></span><br><span class="line">// If true, we attempt to load the application image if it exists.</span><br><span class="line">static constexpr bool kEnableAppImage = true;</span><br><span class="line"></span><br><span class="line">// If true, we attempt to load an app image generated by the runtime.</span><br><span class="line">static const bool kEnableRuntimeAppImage = true;</span><br><span class="line"></span><br><span class="line">#if defined(__ANDROID__)</span><br><span class="line">static const char* kDisableAppImageKeyword = &quot;_disable_art_image_&quot;;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">const OatFile* OatFileManager::RegisterOatFile(std::unique_ptr&lt;const OatFile&gt; oat_file,</span><br><span class="line">                                               bool in_memory) &#123;</span><br><span class="line">  // Use class_linker vlog to match the log for dex file registration.</span><br><span class="line">  VLOG(class_linker) &lt;&lt; &quot;Registered oat file &quot; &lt;&lt; oat_file-&gt;GetLocation();</span><br><span class="line">  PaletteNotifyOatFileLoaded(oat_file-&gt;GetLocation().c_str());</span><br><span class="line"></span><br><span class="line">  WriterMutexLock mu(Thread::Current(), *Locks::oat_file_manager_lock_);</span><br><span class="line">  CHECK(in_memory ||</span><br><span class="line">        !only_use_system_oat_files_ ||</span><br><span class="line">        LocationIsTrusted(oat_file-&gt;GetLocation(), !Runtime::Current()-&gt;DenyArtApexDataFiles()) ||</span><br><span class="line">        !oat_file-&gt;IsExecutable())</span><br><span class="line">      &lt;&lt; &quot;Registering a non /system oat file: &quot; &lt;&lt; oat_file-&gt;GetLocation() &lt;&lt; &quot; android-root=&quot;</span><br><span class="line">      &lt;&lt; GetAndroidRoot();</span><br><span class="line">  DCHECK(oat_file != nullptr);</span><br><span class="line">  if (kIsDebugBuild) &#123;</span><br><span class="line">    CHECK(oat_files_.find(oat_file) == oat_files_.end());</span><br><span class="line">    for (const std::unique_ptr&lt;const OatFile&gt;&amp; existing : oat_files_) &#123;</span><br><span class="line">      CHECK_NE(oat_file.get(), existing.get()) &lt;&lt; oat_file-&gt;GetLocation();</span><br><span class="line">      // Check that we don&#x27;t have an oat file with the same address. Copies of the same oat file</span><br><span class="line">      // should be loaded at different addresses.</span><br><span class="line">      CHECK_NE(oat_file-&gt;Begin(), existing-&gt;Begin()) &lt;&lt; &quot;Oat file already mapped at that location&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  const OatFile* ret = oat_file.get();</span><br><span class="line">  oat_files_.insert(std::move(oat_file));</span><br><span class="line">  return ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void OatFileManager::UnRegisterAndDeleteOatFile(const OatFile* oat_file) &#123;</span><br><span class="line">  WriterMutexLock mu(Thread::Current(), *Locks::oat_file_manager_lock_);</span><br><span class="line">  DCHECK(oat_file != nullptr);</span><br><span class="line">  std::unique_ptr&lt;const OatFile&gt; compare(oat_file);</span><br><span class="line">  auto it = oat_files_.find(compare);</span><br><span class="line">  CHECK(it != oat_files_.end());</span><br><span class="line">  oat_files_.erase(it);</span><br><span class="line">  compare.release();  // NOLINT b/117926937</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const OatFile* OatFileManager::FindOpenedOatFileFromDexLocation(</span><br><span class="line">    const std::string&amp; dex_base_location) const &#123;</span><br><span class="line">  ReaderMutexLock mu(Thread::Current(), *Locks::oat_file_manager_lock_);</span><br><span class="line">  for (const std::unique_ptr&lt;const OatFile&gt;&amp; oat_file : oat_files_) &#123;</span><br><span class="line">    const std::vector&lt;const OatDexFile*&gt;&amp; oat_dex_files = oat_file-&gt;GetOatDexFiles();</span><br><span class="line">    for (const OatDexFile* oat_dex_file : oat_dex_files) &#123;</span><br><span class="line">      if (DexFileLoader::GetBaseLocation(oat_dex_file-&gt;GetDexFileLocation()) == dex_base_location) &#123;</span><br><span class="line">        return oat_file.get();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return nullptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const OatFile* OatFileManager::FindOpenedOatFileFromOatLocation(const std::string&amp; oat_location)</span><br><span class="line">    const &#123;</span><br><span class="line">  ReaderMutexLock mu(Thread::Current(), *Locks::oat_file_manager_lock_);</span><br><span class="line">  return FindOpenedOatFileFromOatLocationLocked(oat_location);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const OatFile* OatFileManager::FindOpenedOatFileFromOatLocationLocked(</span><br><span class="line">    const std::string&amp; oat_location) const &#123;</span><br><span class="line">  for (const std::unique_ptr&lt;const OatFile&gt;&amp; oat_file : oat_files_) &#123;</span><br><span class="line">    if (oat_file-&gt;GetLocation() == oat_location) &#123;</span><br><span class="line">      return oat_file.get();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return nullptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::vector&lt;const OatFile*&gt; OatFileManager::GetBootOatFiles() const &#123;</span><br><span class="line">  std::vector&lt;gc::space::ImageSpace*&gt; image_spaces =</span><br><span class="line">      Runtime::Current()-&gt;GetHeap()-&gt;GetBootImageSpaces();</span><br><span class="line">  std::vector&lt;const OatFile*&gt; oat_files;</span><br><span class="line">  oat_files.reserve(image_spaces.size());</span><br><span class="line">  for (gc::space::ImageSpace* image_space : image_spaces) &#123;</span><br><span class="line">    oat_files.push_back(image_space-&gt;GetOatFile());</span><br><span class="line">  &#125;</span><br><span class="line">  return oat_files;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">OatFileManager::OatFileManager()</span><br><span class="line">    : only_use_system_oat_files_(false) &#123;&#125;</span><br><span class="line"></span><br><span class="line">OatFileManager::~OatFileManager() &#123;</span><br><span class="line">  // Explicitly clear oat_files_ since the OatFile destructor calls back into OatFileManager for</span><br><span class="line">  // UnRegisterOatFileLocation.</span><br><span class="line">  oat_files_.clear();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::vector&lt;const OatFile*&gt; OatFileManager::RegisterImageOatFiles(</span><br><span class="line">    const std::vector&lt;gc::space::ImageSpace*&gt;&amp; spaces) &#123;</span><br><span class="line">  std::vector&lt;const OatFile*&gt; oat_files;</span><br><span class="line">  oat_files.reserve(spaces.size());</span><br><span class="line">  for (gc::space::ImageSpace* space : spaces) &#123;</span><br><span class="line">    // The oat file was generated in memory if the image space has a profile.</span><br><span class="line">    bool in_memory = !space-&gt;GetProfileFiles().empty();</span><br><span class="line">    oat_files.push_back(RegisterOatFile(space-&gt;ReleaseOatFile(), in_memory));</span><br><span class="line">  &#125;</span><br><span class="line">  return oat_files;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool OatFileManager::ShouldLoadAppImage() const &#123;</span><br><span class="line">  Runtime* const runtime = Runtime::Current();</span><br><span class="line">  if (!kEnableAppImage || runtime-&gt;IsJavaDebuggableAtInit()) &#123;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">#if defined(__ANDROID__)</span><br><span class="line">  const char* process_name = getprogname();</span><br><span class="line">  // Some processes would rather take the runtime impact in the interest of memory (b/292210260)</span><br><span class="line">  if (process_name != nullptr &amp;&amp; strstr(process_name, kDisableAppImageKeyword) != nullptr) &#123;</span><br><span class="line">    LOG(INFO) &lt;&lt; &quot;Skipping app image load for &quot; &lt;&lt; process_name;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt; OatFileManager::OpenDexFilesFromOat(</span><br><span class="line">    const char* dex_location,</span><br><span class="line">    jobject class_loader,</span><br><span class="line">    jobjectArray dex_elements,</span><br><span class="line">    const OatFile** out_oat_file,</span><br><span class="line">    std::vector&lt;std::string&gt;* error_msgs) &#123;</span><br><span class="line">  ScopedTrace trace(StringPrintf(&quot;%s(%s)&quot;, __FUNCTION__, dex_location));</span><br><span class="line">  CHECK(dex_location != nullptr);</span><br><span class="line">  CHECK(error_msgs != nullptr);</span><br><span class="line"></span><br><span class="line">  // Verify we aren&#x27;t holding the mutator lock, which could starve GC when</span><br><span class="line">  // hitting the disk.</span><br><span class="line">  Thread* const self = Thread::Current();</span><br><span class="line">  Locks::mutator_lock_-&gt;AssertNotHeld(self);</span><br><span class="line">  Runtime* const runtime = Runtime::Current();</span><br><span class="line"></span><br><span class="line">  std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt; dex_files;</span><br><span class="line">  std::unique_ptr&lt;ClassLoaderContext&gt; context(</span><br><span class="line">      ClassLoaderContext::CreateContextForClassLoader(class_loader, dex_elements));</span><br><span class="line"></span><br><span class="line">  // If the class_loader is null there&#x27;s not much we can do. This happens if a dex files is loaded</span><br><span class="line">  // directly with DexFile APIs instead of using class loaders.</span><br><span class="line">  if (class_loader == nullptr) &#123;</span><br><span class="line">    LOG(WARNING) &lt;&lt; &quot;Opening an oat file without a class loader. &quot;</span><br><span class="line">                 &lt;&lt; &quot;Are you using the deprecated DexFile APIs?&quot;;</span><br><span class="line">  &#125; else if (context != nullptr) &#123;</span><br><span class="line">    auto oat_file_assistant = std::make_unique&lt;OatFileAssistant&gt;(dex_location,</span><br><span class="line">                                                                 kRuntimeQuickCodeISA,</span><br><span class="line">                                                                 context.get(),</span><br><span class="line">                                                                 runtime-&gt;GetOatFilesExecutable(),</span><br><span class="line">                                                                 only_use_system_oat_files_);</span><br><span class="line"></span><br><span class="line">    // Get the current optimization status for trace debugging.</span><br><span class="line">    // Implementation detail note: GetOptimizationStatus will select the same</span><br><span class="line">    // oat file as GetBestOatFile used below, and in doing so it already pre-populates</span><br><span class="line">    // some OatFileAssistant internal fields.</span><br><span class="line">    std::string odex_location;</span><br><span class="line">    std::string compilation_filter;</span><br><span class="line">    std::string compilation_reason;</span><br><span class="line">    std::string odex_status;</span><br><span class="line">    OatFileAssistant::Location ignored_location;</span><br><span class="line">    oat_file_assistant-&gt;GetOptimizationStatus(</span><br><span class="line">        &amp;odex_location, &amp;compilation_filter, &amp;compilation_reason, &amp;odex_status, &amp;ignored_location);</span><br><span class="line"></span><br><span class="line">    ScopedTrace odex_loading(StringPrintf(</span><br><span class="line">        &quot;location=%s status=%s filter=%s reason=%s&quot;,</span><br><span class="line">        odex_location.c_str(),</span><br><span class="line">        odex_status.c_str(),</span><br><span class="line">        compilation_filter.c_str(),</span><br><span class="line">        compilation_reason.c_str()));</span><br><span class="line"></span><br><span class="line">    const bool has_registered_app_info = Runtime::Current()-&gt;GetAppInfo()-&gt;HasRegisteredAppInfo();</span><br><span class="line">    const AppInfo::CodeType code_type =</span><br><span class="line">        Runtime::Current()-&gt;GetAppInfo()-&gt;GetRegisteredCodeType(dex_location);</span><br><span class="line">    // We only want to madvise primary/split dex artifacts as a startup optimization. However,</span><br><span class="line">    // as the code_type for those artifacts may not be set until the initial app info registration,</span><br><span class="line">    // we conservatively madvise everything until the app info registration is complete.</span><br><span class="line">    const bool should_madvise = !has_registered_app_info ||</span><br><span class="line">                                code_type == AppInfo::CodeType::kPrimaryApk ||</span><br><span class="line">                                code_type == AppInfo::CodeType::kSplitApk;</span><br><span class="line"></span><br><span class="line">    // Proceed with oat file loading.</span><br><span class="line">    std::unique_ptr&lt;const OatFile&gt; oat_file(oat_file_assistant-&gt;GetBestOatFile().release());</span><br><span class="line">    VLOG(oat) &lt;&lt; &quot;OatFileAssistant(&quot; &lt;&lt; dex_location &lt;&lt; &quot;).GetBestOatFile()=&quot;</span><br><span class="line">              &lt;&lt; (oat_file != nullptr ? oat_file-&gt;GetLocation() : &quot;&quot;)</span><br><span class="line">              &lt;&lt; &quot; (executable=&quot; &lt;&lt; (oat_file != nullptr ? oat_file-&gt;IsExecutable() : false) &lt;&lt; &quot;)&quot;;</span><br><span class="line"></span><br><span class="line">    CHECK(oat_file == nullptr || odex_location == oat_file-&gt;GetLocation())</span><br><span class="line">        &lt;&lt; &quot;OatFileAssistant non-determinism in choosing best oat files. &quot;</span><br><span class="line">        &lt;&lt; &quot;optimization-status-location=&quot; &lt;&lt; odex_location</span><br><span class="line">        &lt;&lt; &quot; best_oat_file-location=&quot; &lt;&lt; oat_file-&gt;GetLocation();</span><br><span class="line"></span><br><span class="line">    if (oat_file != nullptr) &#123;</span><br><span class="line">      bool compilation_enabled =</span><br><span class="line">          CompilerFilter::IsAotCompilationEnabled(oat_file-&gt;GetCompilerFilter());</span><br><span class="line">      // Load the dex files from the oat file.</span><br><span class="line">      bool added_image_space = false;</span><br><span class="line">      if (should_madvise) &#123;</span><br><span class="line">        VLOG(oat) &lt;&lt; &quot;Madvising oat file: &quot; &lt;&lt; oat_file-&gt;GetLocation();</span><br><span class="line">        size_t madvise_size_limit = runtime-&gt;GetMadviseWillNeedSizeOdex();</span><br><span class="line">        Runtime::MadviseFileForRange(madvise_size_limit,</span><br><span class="line">                                     oat_file-&gt;Size(),</span><br><span class="line">                                     oat_file-&gt;Begin(),</span><br><span class="line">                                     oat_file-&gt;End(),</span><br><span class="line">                                     oat_file-&gt;GetLocation());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ScopedTrace app_image_timing(&quot;AppImage:Loading&quot;);</span><br><span class="line"></span><br><span class="line">      // We need to throw away the image space if we are debuggable but the oat-file source of the</span><br><span class="line">      // image is not otherwise we might get classes with inlined methods or other such things.</span><br><span class="line">      std::unique_ptr&lt;gc::space::ImageSpace&gt; image_space;</span><br><span class="line">      if (ShouldLoadAppImage()) &#123;</span><br><span class="line">        if (oat_file-&gt;IsExecutable()) &#123;</span><br><span class="line">          // App images generated by the compiler can only be used if the oat file</span><br><span class="line">          // is executable.</span><br><span class="line">          image_space = oat_file_assistant-&gt;OpenImageSpace(oat_file.get());</span><br><span class="line">        &#125;</span><br><span class="line">        // Load the runtime image. This logic must be aligned with the one that determines when to</span><br><span class="line">        // keep runtime images in `ArtManagerLocal.cleanup` in</span><br><span class="line">        // `art/libartservice/service/java/com/android/server/art/ArtManagerLocal.java`.</span><br><span class="line">        if (kEnableRuntimeAppImage &amp;&amp; image_space == nullptr &amp;&amp; !compilation_enabled) &#123;</span><br><span class="line">          std::string art_file = RuntimeImage::GetRuntimeImagePath(dex_location);</span><br><span class="line">          std::string error_msg;</span><br><span class="line">          image_space = gc::space::ImageSpace::CreateFromAppImage(</span><br><span class="line">              art_file.c_str(), oat_file.get(), &amp;error_msg);</span><br><span class="line">          if (image_space == nullptr) &#123;</span><br><span class="line">            (OS::FileExists(art_file.c_str()) ? LOG_STREAM(INFO) : VLOG_STREAM(image))</span><br><span class="line">                &lt;&lt; &quot;Could not load runtime generated app image: &quot; &lt;&lt; error_msg;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (image_space != nullptr) &#123;</span><br><span class="line">        ScopedObjectAccess soa(self);</span><br><span class="line">        StackHandleScope&lt;1&gt; hs(self);</span><br><span class="line">        Handle&lt;mirror::ClassLoader&gt; h_loader(</span><br><span class="line">            hs.NewHandle(soa.Decode&lt;mirror::ClassLoader&gt;(class_loader)));</span><br><span class="line">        // Can not load app image without class loader.</span><br><span class="line">        if (h_loader != nullptr) &#123;</span><br><span class="line">          oat_file-&gt;SetAppImageBegin(image_space-&gt;Begin());</span><br><span class="line">          std::string temp_error_msg;</span><br><span class="line">          // Add image space has a race condition since other threads could be reading from the</span><br><span class="line">          // spaces array.</span><br><span class="line">          &#123;</span><br><span class="line">            ScopedThreadSuspension sts(self, ThreadState::kSuspended);</span><br><span class="line">            gc::ScopedGCCriticalSection gcs(self,</span><br><span class="line">                                            gc::kGcCauseAddRemoveAppImageSpace,</span><br><span class="line">                                            gc::kCollectorTypeAddRemoveAppImageSpace);</span><br><span class="line">            ScopedSuspendAll ssa(&quot;Add image space&quot;);</span><br><span class="line">            runtime-&gt;GetHeap()-&gt;AddSpace(image_space.get());</span><br><span class="line">          &#125;</span><br><span class="line">          &#123;</span><br><span class="line">            ScopedTrace image_space_timing(&quot;Adding image space&quot;);</span><br><span class="line">            gc::space::ImageSpace* space_ptr = image_space.get();</span><br><span class="line">            added_image_space = runtime-&gt;GetClassLinker()-&gt;AddImageSpaces(</span><br><span class="line">                ArrayRef&lt;gc::space::ImageSpace*&gt;(&amp;space_ptr, /*size=*/1),</span><br><span class="line">                h_loader,</span><br><span class="line">                context.get(),</span><br><span class="line">                /*out*/ &amp;dex_files,</span><br><span class="line">                /*out*/ &amp;temp_error_msg);</span><br><span class="line">          &#125;</span><br><span class="line">          if (added_image_space) &#123;</span><br><span class="line">            // Successfully added image space to heap, release the map so that it does not get</span><br><span class="line">            // freed.</span><br><span class="line">            image_space.release();  // NOLINT b/117926937</span><br><span class="line"></span><br><span class="line">            // Register for tracking.</span><br><span class="line">            for (const auto&amp; dex_file : dex_files) &#123;</span><br><span class="line">              dex::tracking::RegisterDexFile(dex_file.get());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            LOG(INFO) &lt;&lt; &quot;Failed to add image file: &quot; &lt;&lt; temp_error_msg;</span><br><span class="line">            oat_file-&gt;SetAppImageBegin(nullptr);</span><br><span class="line">            dex_files.clear();</span><br><span class="line">            &#123;</span><br><span class="line">              ScopedThreadSuspension sts(self, ThreadState::kSuspended);</span><br><span class="line">              gc::ScopedGCCriticalSection gcs(self,</span><br><span class="line">                                              gc::kGcCauseAddRemoveAppImageSpace,</span><br><span class="line">                                              gc::kCollectorTypeAddRemoveAppImageSpace);</span><br><span class="line">              ScopedSuspendAll ssa(&quot;Remove image space&quot;);</span><br><span class="line">              runtime-&gt;GetHeap()-&gt;RemoveSpace(image_space.get());</span><br><span class="line">            &#125;</span><br><span class="line">            // Non-fatal, don&#x27;t update error_msg.</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (!added_image_space) &#123;</span><br><span class="line">        DCHECK(dex_files.empty());</span><br><span class="line"></span><br><span class="line">        if (oat_file-&gt;RequiresImage()) &#123;</span><br><span class="line">          LOG(WARNING) &lt;&lt; &quot;Loading &quot;</span><br><span class="line">                       &lt;&lt; oat_file-&gt;GetLocation()</span><br><span class="line">                       &lt;&lt; &quot; non-executable as it requires an image which we failed to load&quot;;</span><br><span class="line">          // file as non-executable.</span><br><span class="line">          auto nonexecutable_oat_file_assistant =</span><br><span class="line">              std::make_unique&lt;OatFileAssistant&gt;(dex_location,</span><br><span class="line">                                                 kRuntimeQuickCodeISA,</span><br><span class="line">                                                 context.get(),</span><br><span class="line">                                                 /*load_executable=*/false,</span><br><span class="line">                                                 only_use_system_oat_files_);</span><br><span class="line">          oat_file.reset(nonexecutable_oat_file_assistant-&gt;GetBestOatFile().release());</span><br><span class="line"></span><br><span class="line">          // The file could be deleted concurrently (for example background</span><br><span class="line">          // dexopt, or secondary oat file being deleted by the app).</span><br><span class="line">          if (oat_file == nullptr) &#123;</span><br><span class="line">            LOG(WARNING) &lt;&lt; &quot;Failed to reload oat file non-executable &quot; &lt;&lt; dex_location;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (oat_file != nullptr) &#123;</span><br><span class="line">          dex_files = oat_file_assistant-&gt;LoadDexFiles(*oat_file.get(), dex_location);</span><br><span class="line"></span><br><span class="line">          // Register for tracking.</span><br><span class="line">          for (const auto&amp; dex_file : dex_files) &#123;</span><br><span class="line">            dex::tracking::RegisterDexFile(dex_file.get());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (dex_files.empty()) &#123;</span><br><span class="line">        ScopedTrace failed_to_open_dex_files(&quot;FailedToOpenDexFilesFromOat&quot;);</span><br><span class="line">        error_msgs-&gt;push_back(&quot;Failed to open dex files from &quot; + odex_location);</span><br><span class="line">      &#125; else if (should_madvise) &#123;</span><br><span class="line">        size_t madvise_size_limit = Runtime::Current()-&gt;GetMadviseWillNeedTotalDexSize();</span><br><span class="line">        for (const std::unique_ptr&lt;const DexFile&gt;&amp; dex_file : dex_files) &#123;</span><br><span class="line">          // Prefetch the dex file based on vdex size limit (name should</span><br><span class="line">          // have been dex size limit).</span><br><span class="line">          VLOG(oat) &lt;&lt; &quot;Madvising dex file: &quot; &lt;&lt; dex_file-&gt;GetLocation();</span><br><span class="line">          Runtime::MadviseFileForRange(madvise_size_limit,</span><br><span class="line">                                       dex_file-&gt;Size(),</span><br><span class="line">                                       dex_file-&gt;Begin(),</span><br><span class="line">                                       dex_file-&gt;Begin() + dex_file-&gt;Size(),</span><br><span class="line">                                       dex_file-&gt;GetLocation());</span><br><span class="line">          if (dex_file-&gt;Size() &gt;= madvise_size_limit) &#123;</span><br><span class="line">            break;</span><br><span class="line">          &#125;</span><br><span class="line">          madvise_size_limit -= dex_file-&gt;Size();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (oat_file != nullptr) &#123;</span><br><span class="line">        VLOG(class_linker) &lt;&lt; &quot;Registering &quot; &lt;&lt; oat_file-&gt;GetLocation();</span><br><span class="line">        *out_oat_file = RegisterOatFile(std::move(oat_file));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // oat_file == nullptr</span><br><span class="line">      // Verify if any of the dex files being loaded is already in the class path.</span><br><span class="line">      // If so, report an error with the current stack trace.</span><br><span class="line">      // Most likely the developer didn&#x27;t intend to do this because it will waste</span><br><span class="line">      // performance and memory.</span><br><span class="line">      if (oat_file_assistant-&gt;GetBestStatus() == OatFileAssistant::kOatContextOutOfDate) &#123;</span><br><span class="line">        std::set&lt;const DexFile*&gt; already_exists_in_classpath =</span><br><span class="line">            context-&gt;CheckForDuplicateDexFiles(MakeNonOwningPointerVector(dex_files));</span><br><span class="line">        if (!already_exists_in_classpath.empty()) &#123;</span><br><span class="line">          ScopedTrace duplicate_dex_files(&quot;DuplicateDexFilesInContext&quot;);</span><br><span class="line">          auto duplicate_it = already_exists_in_classpath.begin();</span><br><span class="line">          std::string duplicates = (*duplicate_it)-&gt;GetLocation();</span><br><span class="line">          for (duplicate_it++ ; duplicate_it != already_exists_in_classpath.end(); duplicate_it++) &#123;</span><br><span class="line">            duplicates += &quot;,&quot; + (*duplicate_it)-&gt;GetLocation();</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          std::ostringstream out;</span><br><span class="line">          out &lt;&lt; &quot;Trying to load dex files which is already loaded in the same ClassLoader &quot;</span><br><span class="line">              &lt;&lt; &quot;hierarchy.\n&quot;</span><br><span class="line">              &lt;&lt; &quot;This is a strong indication of bad ClassLoader construct which leads to poor &quot;</span><br><span class="line">              &lt;&lt; &quot;performance and wastes memory.\n&quot;</span><br><span class="line">              &lt;&lt; &quot;The list of duplicate dex files is: &quot; &lt;&lt; duplicates &lt;&lt; &quot;\n&quot;</span><br><span class="line">              &lt;&lt; &quot;The current class loader context is: &quot;</span><br><span class="line">              &lt;&lt; context-&gt;EncodeContextForOatFile(&quot;&quot;) &lt;&lt; &quot;\n&quot;</span><br><span class="line">              &lt;&lt; &quot;Java stack trace:\n&quot;;</span><br><span class="line"></span><br><span class="line">          &#123;</span><br><span class="line">            ScopedObjectAccess soa(self);</span><br><span class="line">            self-&gt;DumpJavaStack(out);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          // We log this as an ERROR to stress the fact that this is most likely unintended.</span><br><span class="line">          // Note that ART cannot do anything about it. It is up to the app to fix their logic.</span><br><span class="line">          // Here we are trying to give a heads up on why the app might have performance issues.</span><br><span class="line">          LOG(ERROR) &lt;&lt; out.str();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Runtime::Current()-&gt;GetAppInfo()-&gt;RegisterOdexStatus(</span><br><span class="line">        dex_location,</span><br><span class="line">        compilation_filter,</span><br><span class="line">        compilation_reason,</span><br><span class="line">        odex_status);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // If we arrive here with an empty dex files list, it means we fail to load</span><br><span class="line">  // it/them through an .oat file.</span><br><span class="line">  if (dex_files.empty()) &#123;</span><br><span class="line">    std::string error_msg;</span><br><span class="line">    static constexpr bool kVerifyChecksum = true;</span><br><span class="line">    ArtDexFileLoader dex_file_loader(dex_location);</span><br><span class="line">    if (!dex_file_loader.Open(Runtime::Current()-&gt;IsVerificationEnabled(),</span><br><span class="line">                              kVerifyChecksum,</span><br><span class="line">                              /*out*/ &amp;error_msg,</span><br><span class="line">                              &amp;dex_files)) &#123;</span><br><span class="line">      ScopedTrace fail_to_open_dex_from_apk(&quot;FailedToOpenDexFilesFromApk&quot;);</span><br><span class="line">      LOG(WARNING) &lt;&lt; error_msg;</span><br><span class="line">      error_msgs-&gt;push_back(&quot;Failed to open dex files from &quot; + std::string(dex_location)</span><br><span class="line">                            + &quot; because: &quot; + error_msg);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (Runtime::Current()-&gt;GetJit() != nullptr) &#123;</span><br><span class="line">    Runtime::Current()-&gt;GetJit()-&gt;RegisterDexFiles(dex_files, class_loader);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Now that we loaded the dex/odex files, notify the runtime.</span><br><span class="line">  // Note that we do this everytime we load dex files.</span><br><span class="line">  Runtime::Current()-&gt;NotifyDexFileLoaded();</span><br><span class="line"></span><br><span class="line">  return dex_files;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static std::vector&lt;const DexFile::Header*&gt; GetDexFileHeaders(const std::vector&lt;MemMap&gt;&amp; maps) &#123;</span><br><span class="line">  std::vector&lt;const DexFile::Header*&gt; headers;</span><br><span class="line">  headers.reserve(maps.size());</span><br><span class="line">  for (const MemMap&amp; map : maps) &#123;</span><br><span class="line">    DCHECK(map.IsValid());</span><br><span class="line">    headers.push_back(reinterpret_cast&lt;const DexFile::Header*&gt;(map.Begin()));</span><br><span class="line">  &#125;</span><br><span class="line">  return headers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt; OatFileManager::OpenDexFilesFromOat(</span><br><span class="line">    std::vector&lt;MemMap&gt;&amp;&amp; dex_mem_maps,</span><br><span class="line">    jobject class_loader,</span><br><span class="line">    jobjectArray dex_elements,</span><br><span class="line">    const OatFile** out_oat_file,</span><br><span class="line">    std::vector&lt;std::string&gt;* error_msgs) &#123;</span><br><span class="line">  std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt; dex_files = OpenDexFilesFromOat_Impl(</span><br><span class="line">      std::move(dex_mem_maps),</span><br><span class="line">      class_loader,</span><br><span class="line">      dex_elements,</span><br><span class="line">      out_oat_file,</span><br><span class="line">      error_msgs);</span><br><span class="line"></span><br><span class="line">  if (error_msgs-&gt;empty()) &#123;</span><br><span class="line">    // Remove write permission from DexFile pages. We do this at the end because</span><br><span class="line">    // OatFile assigns OatDexFile pointer in the DexFile objects.</span><br><span class="line">    for (std::unique_ptr&lt;const DexFile&gt;&amp; dex_file : dex_files) &#123;</span><br><span class="line">      if (!dex_file-&gt;DisableWrite()) &#123;</span><br><span class="line">        error_msgs-&gt;push_back(&quot;Failed to make dex file &quot; + dex_file-&gt;GetLocation() + &quot; read-only&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!error_msgs-&gt;empty()) &#123;</span><br><span class="line">    return std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return dex_files;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt; OatFileManager::OpenDexFilesFromOat_Impl(</span><br><span class="line">    std::vector&lt;MemMap&gt;&amp;&amp; dex_mem_maps,</span><br><span class="line">    jobject class_loader,</span><br><span class="line">    jobjectArray dex_elements,</span><br><span class="line">    const OatFile** out_oat_file,</span><br><span class="line">    std::vector&lt;std::string&gt;* error_msgs) &#123;</span><br><span class="line">  ScopedTrace trace(__FUNCTION__);</span><br><span class="line">  std::string error_msg;</span><br><span class="line">  DCHECK(error_msgs != nullptr);</span><br><span class="line"></span><br><span class="line">  // Extract dex file headers from `dex_mem_maps`.</span><br><span class="line">  const std::vector&lt;const DexFile::Header*&gt; dex_headers = GetDexFileHeaders(dex_mem_maps);</span><br><span class="line"></span><br><span class="line">  // Determine dex/vdex locations and the combined location checksum.</span><br><span class="line">  std::string dex_location;</span><br><span class="line">  std::string vdex_path;</span><br><span class="line">  bool has_vdex = OatFileAssistant::AnonymousDexVdexLocation(dex_headers,</span><br><span class="line">                                                             kRuntimeQuickCodeISA,</span><br><span class="line">                                                             &amp;dex_location,</span><br><span class="line">                                                             &amp;vdex_path);</span><br><span class="line"></span><br><span class="line">  // Attempt to open an existing vdex and check dex file checksums match.</span><br><span class="line">  std::unique_ptr&lt;VdexFile&gt; vdex_file = nullptr;</span><br><span class="line">  if (has_vdex &amp;&amp; OS::FileExists(vdex_path.c_str())) &#123;</span><br><span class="line">    vdex_file = VdexFile::Open(vdex_path,</span><br><span class="line">                               /*low_4gb=*/false,</span><br><span class="line">                               &amp;error_msg);</span><br><span class="line">    if (vdex_file == nullptr) &#123;</span><br><span class="line">      LOG(WARNING) &lt;&lt; &quot;Failed to open vdex &quot; &lt;&lt; vdex_path &lt;&lt; &quot;: &quot; &lt;&lt; error_msg;</span><br><span class="line">    &#125; else if (!vdex_file-&gt;MatchesDexFileChecksums(dex_headers)) &#123;</span><br><span class="line">      LOG(WARNING) &lt;&lt; &quot;Failed to open vdex &quot; &lt;&lt; vdex_path &lt;&lt; &quot;: dex file checksum mismatch&quot;;</span><br><span class="line">      vdex_file.reset(nullptr);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Load dex files. Skip structural dex file verification if vdex was found</span><br><span class="line">  // and dex checksums matched.</span><br><span class="line">  std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt; dex_files;</span><br><span class="line">  for (size_t i = 0; i &lt; dex_mem_maps.size(); ++i) &#123;</span><br><span class="line">    static constexpr bool kVerifyChecksum = true;</span><br><span class="line">    ArtDexFileLoader dex_file_loader(std::move(dex_mem_maps[i]),</span><br><span class="line">                                     DexFileLoader::GetMultiDexLocation(i, dex_location.c_str()));</span><br><span class="line">    std::unique_ptr&lt;const DexFile&gt; dex_file(dex_file_loader.Open(</span><br><span class="line">        dex_headers[i]-&gt;checksum_,</span><br><span class="line">        /* verify= */ (vdex_file == nullptr) &amp;&amp; Runtime::Current()-&gt;IsVerificationEnabled(),</span><br><span class="line">        kVerifyChecksum,</span><br><span class="line">        &amp;error_msg));</span><br><span class="line">    if (dex_file != nullptr) &#123;</span><br><span class="line">      dex::tracking::RegisterDexFile(dex_file.get());  // Register for tracking.</span><br><span class="line">      dex_files.push_back(std::move(dex_file));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      error_msgs-&gt;push_back(&quot;Failed to open dex files from memory: &quot; + error_msg);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Check if we should proceed to creating an OatFile instance backed by the vdex.</span><br><span class="line">  // We need: (a) an existing vdex, (b) class loader (can be null if invoked via reflection),</span><br><span class="line">  // and (c) no errors during dex file loading.</span><br><span class="line">  if (vdex_file == nullptr || class_loader == nullptr || !error_msgs-&gt;empty()) &#123;</span><br><span class="line">    return dex_files;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Attempt to create a class loader context, check OpenDexFiles succeeds (prerequisite</span><br><span class="line">  // for using the context later).</span><br><span class="line">  std::unique_ptr&lt;ClassLoaderContext&gt; context = ClassLoaderContext::CreateContextForClassLoader(</span><br><span class="line">      class_loader,</span><br><span class="line">      dex_elements);</span><br><span class="line">  if (context == nullptr) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; &quot;Could not create class loader context for &quot; &lt;&lt; vdex_path;</span><br><span class="line">    return dex_files;</span><br><span class="line">  &#125;</span><br><span class="line">  DCHECK(context-&gt;OpenDexFiles())</span><br><span class="line">      &lt;&lt; &quot;Context created from already opened dex files should not attempt to open again&quot;;</span><br><span class="line"></span><br><span class="line">  // Initialize an OatFile instance backed by the loaded vdex.</span><br><span class="line">  std::unique_ptr&lt;OatFile&gt; oat_file(OatFile::OpenFromVdex(MakeNonOwningPointerVector(dex_files),</span><br><span class="line">                                                          std::move(vdex_file),</span><br><span class="line">                                                          dex_location,</span><br><span class="line">                                                          context.get()));</span><br><span class="line">  if (oat_file != nullptr) &#123;</span><br><span class="line">    VLOG(class_linker) &lt;&lt; &quot;Registering &quot; &lt;&lt; oat_file-&gt;GetLocation();</span><br><span class="line">    *out_oat_file = RegisterOatFile(std::move(oat_file));</span><br><span class="line">  &#125;</span><br><span class="line">  return dex_files;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Check how many vdex files exist in the same directory as the vdex file we are about</span><br><span class="line">// to write. If more than or equal to kAnonymousVdexCacheSize, unlink the least</span><br><span class="line">// recently used one(s) (according to stat-reported atime).</span><br><span class="line">static bool UnlinkLeastRecentlyUsedVdexIfNeeded(const std::string&amp; vdex_path_to_add,</span><br><span class="line">                                                std::string* error_msg) &#123;</span><br><span class="line">  std::string basename = android::base::Basename(vdex_path_to_add);</span><br><span class="line">  if (!OatFileAssistant::IsAnonymousVdexBasename(basename)) &#123;</span><br><span class="line">    // File is not for in memory dex files.</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (OS::FileExists(vdex_path_to_add.c_str())) &#123;</span><br><span class="line">    // File already exists and will be overwritten.</span><br><span class="line">    // This will not change the number of entries in the cache.</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  auto last_slash = vdex_path_to_add.rfind(&#x27;/&#x27;);</span><br><span class="line">  CHECK(last_slash != std::string::npos);</span><br><span class="line">  std::string vdex_dir = vdex_path_to_add.substr(0, last_slash + 1);</span><br><span class="line"></span><br><span class="line">  if (!OS::DirectoryExists(vdex_dir.c_str())) &#123;</span><br><span class="line">    // Folder does not exist yet. Cache has zero entries.</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;std::pair&lt;time_t, std::string&gt;&gt; cache;</span><br><span class="line"></span><br><span class="line">  DIR* c_dir = opendir(vdex_dir.c_str());</span><br><span class="line">  if (c_dir == nullptr) &#123;</span><br><span class="line">    *error_msg = &quot;Unable to open &quot; + vdex_dir + &quot; to delete unused vdex files&quot;;</span><br><span class="line">    return false;</span><br><span class="line">  &#125;</span><br><span class="line">  for (struct dirent* de = readdir(c_dir); de != nullptr; de = readdir(c_dir)) &#123;</span><br><span class="line">    if (de-&gt;d_type != DT_REG) &#123;</span><br><span class="line">      continue;</span><br><span class="line">    &#125;</span><br><span class="line">    basename = de-&gt;d_name;</span><br><span class="line">    if (!OatFileAssistant::IsAnonymousVdexBasename(basename)) &#123;</span><br><span class="line">      continue;</span><br><span class="line">    &#125;</span><br><span class="line">    std::string fullname = vdex_dir + basename;</span><br><span class="line"></span><br><span class="line">    struct stat s;</span><br><span class="line">    int rc = TEMP_FAILURE_RETRY(stat(fullname.c_str(), &amp;s));</span><br><span class="line">    if (rc == -1) &#123;</span><br><span class="line">      *error_msg = &quot;Failed to stat() anonymous vdex file &quot; + fullname;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cache.push_back(std::make_pair(s.st_atime, fullname));</span><br><span class="line">  &#125;</span><br><span class="line">  CHECK_EQ(0, closedir(c_dir)) &lt;&lt; &quot;Unable to close directory.&quot;;</span><br><span class="line"></span><br><span class="line">  if (cache.size() &lt; OatFileManager::kAnonymousVdexCacheSize) &#123;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::sort(cache.begin(),</span><br><span class="line">            cache.end(),</span><br><span class="line">            [](const auto&amp; a, const auto&amp; b) &#123; return a.first &lt; b.first; &#125;);</span><br><span class="line">  for (size_t i = OatFileManager::kAnonymousVdexCacheSize - 1; i &lt; cache.size(); ++i) &#123;</span><br><span class="line">    if (unlink(cache[i].second.c_str()) != 0) &#123;</span><br><span class="line">      *error_msg = &quot;Could not unlink anonymous vdex file &quot; + cache[i].second;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class BackgroundVerificationTask final : public Task &#123;</span><br><span class="line"> public:</span><br><span class="line">  BackgroundVerificationTask(const std::vector&lt;const DexFile*&gt;&amp; dex_files,</span><br><span class="line">                             jobject class_loader,</span><br><span class="line">                             const std::string&amp; vdex_path)</span><br><span class="line">      : dex_files_(dex_files),</span><br><span class="line">        vdex_path_(vdex_path) &#123;</span><br><span class="line">    Thread* const self = Thread::Current();</span><br><span class="line">    ScopedObjectAccess soa(self);</span><br><span class="line">    // Create a global ref for `class_loader` because it will be accessed from a different thread.</span><br><span class="line">    class_loader_ = soa.Vm()-&gt;AddGlobalRef(self, soa.Decode&lt;mirror::ClassLoader&gt;(class_loader));</span><br><span class="line">    CHECK(class_loader_ != nullptr);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ~BackgroundVerificationTask() &#123;</span><br><span class="line">    Thread* const self = Thread::Current();</span><br><span class="line">    ScopedObjectAccess soa(self);</span><br><span class="line">    soa.Vm()-&gt;DeleteGlobalRef(self, class_loader_);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  void Run(Thread* self) override &#123;</span><br><span class="line">    std::string error_msg;</span><br><span class="line">    ClassLinker* const class_linker = Runtime::Current()-&gt;GetClassLinker();</span><br><span class="line">    verifier::VerifierDeps verifier_deps(dex_files_);</span><br><span class="line"></span><br><span class="line">    // Iterate over all classes and verify them.</span><br><span class="line">    for (const DexFile* dex_file : dex_files_) &#123;</span><br><span class="line">      for (uint32_t cdef_idx = 0; cdef_idx &lt; dex_file-&gt;NumClassDefs(); cdef_idx++) &#123;</span><br><span class="line">        const dex::ClassDef&amp; class_def = dex_file-&gt;GetClassDef(cdef_idx);</span><br><span class="line"></span><br><span class="line">        // Take handles inside the loop. The background verification is low priority</span><br><span class="line">        // and we want to minimize the risk of blocking anyone else.</span><br><span class="line">        ScopedObjectAccess soa(self);</span><br><span class="line">        StackHandleScope&lt;2&gt; hs(self);</span><br><span class="line">        Handle&lt;mirror::ClassLoader&gt; h_loader(hs.NewHandle(</span><br><span class="line">            soa.Decode&lt;mirror::ClassLoader&gt;(class_loader_)));</span><br><span class="line">        Handle&lt;mirror::Class&gt; h_class =</span><br><span class="line">            hs.NewHandle(class_linker-&gt;FindClass(self, *dex_file, class_def.class_idx_, h_loader));</span><br><span class="line"></span><br><span class="line">        if (h_class == nullptr) &#123;</span><br><span class="line">          DCHECK(self-&gt;IsExceptionPending());</span><br><span class="line">          self-&gt;ClearException();</span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (&amp;h_class-&gt;GetDexFile() != dex_file) &#123;</span><br><span class="line">          // There is a different class in the class path or a parent class loader</span><br><span class="line">          // with the same descriptor. This `h_class` is not resolvable, skip it.</span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DCHECK(h_class-&gt;IsResolved()) &lt;&lt; h_class-&gt;PrettyDescriptor();</span><br><span class="line">        class_linker-&gt;VerifyClass(self, &amp;verifier_deps, h_class);</span><br><span class="line">        if (self-&gt;IsExceptionPending()) &#123;</span><br><span class="line">          // ClassLinker::VerifyClass can throw, but the exception isn&#x27;t useful here.</span><br><span class="line">          self-&gt;ClearException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DCHECK(h_class-&gt;IsVerified() || h_class-&gt;IsErroneous())</span><br><span class="line">            &lt;&lt; h_class-&gt;PrettyDescriptor() &lt;&lt; &quot;: state=&quot; &lt;&lt; h_class-&gt;GetStatus();</span><br><span class="line"></span><br><span class="line">        if (h_class-&gt;IsVerified()) &#123;</span><br><span class="line">          verifier_deps.RecordClassVerified(*dex_file, class_def);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Delete old vdex files if there are too many in the folder.</span><br><span class="line">    if (!UnlinkLeastRecentlyUsedVdexIfNeeded(vdex_path_, &amp;error_msg)) &#123;</span><br><span class="line">      LOG(ERROR) &lt;&lt; &quot;Could not unlink old vdex files &quot; &lt;&lt; vdex_path_ &lt;&lt; &quot;: &quot; &lt;&lt; error_msg;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Construct a vdex file and write `verifier_deps` into it.</span><br><span class="line">    if (!VdexFile::WriteToDisk(vdex_path_,</span><br><span class="line">                               dex_files_,</span><br><span class="line">                               verifier_deps,</span><br><span class="line">                               &amp;error_msg)) &#123;</span><br><span class="line">      LOG(ERROR) &lt;&lt; &quot;Could not write anonymous vdex &quot; &lt;&lt; vdex_path_ &lt;&lt; &quot;: &quot; &lt;&lt; error_msg;</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  void Finalize() override &#123;</span><br><span class="line">    delete this;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> private:</span><br><span class="line">  const std::vector&lt;const DexFile*&gt; dex_files_;</span><br><span class="line">  jobject class_loader_;</span><br><span class="line">  const std::string vdex_path_;</span><br><span class="line"></span><br><span class="line">  DISALLOW_COPY_AND_ASSIGN(BackgroundVerificationTask);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">void OatFileManager::RunBackgroundVerification(const std::vector&lt;const DexFile*&gt;&amp; dex_files,</span><br><span class="line">                                               jobject class_loader) &#123;</span><br><span class="line">  Runtime* const runtime = Runtime::Current();</span><br><span class="line">  Thread* const self = Thread::Current();</span><br><span class="line"></span><br><span class="line">  if (runtime-&gt;IsJavaDebuggable()) &#123;</span><br><span class="line">    // Threads created by ThreadPool (&quot;runtime threads&quot;) are not allowed to load</span><br><span class="line">    // classes when debuggable to match class-initialization semantics</span><br><span class="line">    // expectations. Do not verify in the background.</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    // Temporarily create a class loader context to see if we recognize the</span><br><span class="line">    // chain.</span><br><span class="line">    std::unique_ptr&lt;ClassLoaderContext&gt; context(</span><br><span class="line">        ClassLoaderContext::CreateContextForClassLoader(class_loader, nullptr));</span><br><span class="line">    if (context == nullptr) &#123;</span><br><span class="line">      // We only run background verification for class loaders we know the lookup</span><br><span class="line">      // chain. Because the background verification runs on runtime threads,</span><br><span class="line">      // which do not call Java, we won&#x27;t be able to load classes when</span><br><span class="line">      // verifying, which is something the current verifier relies on.</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!IsSdkVersionSetAndAtLeast(runtime-&gt;GetTargetSdkVersion(), SdkVersion::kQ)) &#123;</span><br><span class="line">    // Do not run for legacy apps as they may depend on the previous class loader behaviour.</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (runtime-&gt;IsShuttingDown(self)) &#123;</span><br><span class="line">    // Not allowed to create new threads during runtime shutdown.</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (dex_files.size() &lt; 1) &#123;</span><br><span class="line">    // Nothing to verify.</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::string dex_location = dex_files[0]-&gt;GetLocation();</span><br><span class="line">  const std::string&amp; data_dir = Runtime::Current()-&gt;GetProcessDataDirectory();</span><br><span class="line">  if (!dex_location.starts_with(data_dir)) &#123;</span><br><span class="line">    // For now, we only run background verification for secondary dex files.</span><br><span class="line">    // Running it for primary or split APKs could have some undesirable</span><br><span class="line">    // side-effects, like overloading the device on app startup.</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::string error_msg;</span><br><span class="line">  std::string odex_filename;</span><br><span class="line">  if (!OatFileAssistant::DexLocationToOdexFilename(dex_location,</span><br><span class="line">                                                   kRuntimeQuickCodeISA,</span><br><span class="line">                                                   &amp;odex_filename,</span><br><span class="line">                                                   &amp;error_msg)) &#123;</span><br><span class="line">    LOG(WARNING) &lt;&lt; &quot;Could not get odex filename for &quot; &lt;&lt; dex_location &lt;&lt; &quot;: &quot; &lt;&lt; error_msg;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (LocationIsOnArtApexData(odex_filename) &amp;&amp; Runtime::Current()-&gt;DenyArtApexDataFiles()) &#123;</span><br><span class="line">    // Ignore vdex file associated with this odex file as the odex file is not trustworthy.</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    WriterMutexLock mu(self, *Locks::oat_file_manager_lock_);</span><br><span class="line">    if (verification_thread_pool_ == nullptr) &#123;</span><br><span class="line">      verification_thread_pool_.reset(</span><br><span class="line">          ThreadPool::Create(&quot;Verification thread pool&quot;, /* num_threads= */ 1));</span><br><span class="line">      verification_thread_pool_-&gt;StartWorkers(self);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  verification_thread_pool_-&gt;AddTask(self, new BackgroundVerificationTask(</span><br><span class="line">      dex_files,</span><br><span class="line">      class_loader,</span><br><span class="line">      GetVdexFilename(odex_filename)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void OatFileManager::WaitForWorkersToBeCreated() &#123;</span><br><span class="line">  DCHECK(!Runtime::Current()-&gt;IsShuttingDown(Thread::Current()))</span><br><span class="line">      &lt;&lt; &quot;Cannot create new threads during runtime shutdown&quot;;</span><br><span class="line">  if (verification_thread_pool_ != nullptr) &#123;</span><br><span class="line">    verification_thread_pool_-&gt;WaitForWorkersToBeCreated();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void OatFileManager::DeleteThreadPool() &#123;</span><br><span class="line">  verification_thread_pool_.reset(nullptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void OatFileManager::WaitForBackgroundVerificationTasksToFinish() &#123;</span><br><span class="line">  if (verification_thread_pool_ == nullptr) &#123;</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Thread* const self = Thread::Current();</span><br><span class="line">  verification_thread_pool_-&gt;Wait(self, /* do_work= */ true, /* may_hold_locks= */ false);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void OatFileManager::WaitForBackgroundVerificationTasks() &#123;</span><br><span class="line">  if (verification_thread_pool_ != nullptr) &#123;</span><br><span class="line">    Thread* const self = Thread::Current();</span><br><span class="line">    verification_thread_pool_-&gt;WaitForWorkersToBeCreated();</span><br><span class="line">    verification_thread_pool_-&gt;Wait(self, /* do_work= */ true, /* may_hold_locks= */ false);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void OatFileManager::ClearOnlyUseTrustedOatFiles() &#123;</span><br><span class="line">  only_use_system_oat_files_ = false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void OatFileManager::SetOnlyUseTrustedOatFiles() &#123;</span><br><span class="line">  ReaderMutexLock mu(Thread::Current(), *Locks::oat_file_manager_lock_);</span><br><span class="line">  if (!oat_files_.empty()) &#123;</span><br><span class="line">    LOG(FATAL) &lt;&lt; &quot;Unexpected non-empty loaded oat files &quot;;</span><br><span class="line">  &#125;</span><br><span class="line">  only_use_system_oat_files_ = true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void OatFileManager::DumpForSigQuit(std::ostream&amp; os) &#123;</span><br><span class="line">  ReaderMutexLock mu(Thread::Current(), *Locks::oat_file_manager_lock_);</span><br><span class="line">  std::vector&lt;const OatFile*&gt; boot_oat_files = GetBootOatFiles();</span><br><span class="line">  for (const std::unique_ptr&lt;const OatFile&gt;&amp; oat_file : oat_files_) &#123;</span><br><span class="line">    if (ContainsElement(boot_oat_files, oat_file.get())) &#123;</span><br><span class="line">      continue;</span><br><span class="line">    &#125;</span><br><span class="line">    os &lt;&lt; oat_file-&gt;GetLocation() &lt;&lt; &quot;: &quot; &lt;&lt; oat_file-&gt;GetCompilerFilter() &lt;&lt; &quot;\n&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool OatFileManager::ContainsPc(const void* code) &#123;</span><br><span class="line">  ReaderMutexLock mu(Thread::Current(), *Locks::oat_file_manager_lock_);</span><br><span class="line">  std::vector&lt;const OatFile*&gt; boot_oat_files = GetBootOatFiles();</span><br><span class="line">  for (const std::unique_ptr&lt;const OatFile&gt;&amp; oat_file : oat_files_) &#123;</span><br><span class="line">    if (oat_file-&gt;Contains(code)) &#123;</span><br><span class="line">      return true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;  // namespace art</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250919214822-po8a9w2.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250919215048-dbzuqf7.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250919220846-6ingjhj.png" alt="image"></p>
<p>解析dex 对应着dexfile构造函数脱壳 继续分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Copyright (C) 2017 The Android Open Source Project</span><br><span class="line"> *</span><br><span class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> * you may not use this file except in compliance with the License.</span><br><span class="line"> * You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">#ifndef ART_LIBDEXFILE_DEX_ART_DEX_FILE_LOADER_H_</span><br><span class="line">#define ART_LIBDEXFILE_DEX_ART_DEX_FILE_LOADER_H_</span><br><span class="line"></span><br><span class="line">#include &lt;cstdint&gt;</span><br><span class="line">#include &lt;memory&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line"></span><br><span class="line">#include &quot;base/macros.h&quot;</span><br><span class="line">#include &quot;dex/dex_file_loader.h&quot;</span><br><span class="line"></span><br><span class="line">namespace art &#123;</span><br><span class="line"></span><br><span class="line">class DexFile;</span><br><span class="line">class DexFileContainer;</span><br><span class="line">class MemMap;</span><br><span class="line">class OatDexFile;</span><br><span class="line">class ZipArchive;</span><br><span class="line"></span><br><span class="line">// Class that is used to open dex files and deal with corresponding multidex and location logic.</span><br><span class="line">class ArtDexFileLoader : public DexFileLoader &#123;</span><br><span class="line"> public:</span><br><span class="line">  using DexFileLoader::DexFileLoader;  // Use constructors from base class.</span><br><span class="line">  using DexFileLoader::Open;           // Don&#x27;t shadow overloads from base class.</span><br><span class="line"></span><br><span class="line">  // Old signature preserved for app-compat.</span><br><span class="line">  std::unique_ptr&lt;const DexFile&gt; Open(const uint8_t* base,</span><br><span class="line">                                      size_t size,</span><br><span class="line">                                      const std::string&amp; location,</span><br><span class="line">                                      uint32_t location_checksum,</span><br><span class="line">                                      const OatDexFile* oat_dex_file,</span><br><span class="line">                                      bool verify,</span><br><span class="line">                                      bool verify_checksum,</span><br><span class="line">                                      std::string* error_msg,</span><br><span class="line">                                      std::unique_ptr&lt;DexFileContainer&gt; container) const;</span><br><span class="line"></span><br><span class="line">  // Old signature preserved for app-compat.</span><br><span class="line">  std::unique_ptr&lt;const DexFile&gt; Open(const std::string&amp; location,</span><br><span class="line">                                      uint32_t location_checksum,</span><br><span class="line">                                      MemMap&amp;&amp; mem_map,</span><br><span class="line">                                      bool verify,</span><br><span class="line">                                      bool verify_checksum,</span><br><span class="line">                                      std::string* error_msg) const;</span><br><span class="line"></span><br><span class="line">  // Old signature preserved for app-compat.</span><br><span class="line">  bool Open(const char* filename,</span><br><span class="line">            const std::string&amp; location,</span><br><span class="line">            bool verify,</span><br><span class="line">            bool verify_checksum,</span><br><span class="line">            std::string* error_msg,</span><br><span class="line">            std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt;* dex_files) const;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  // namespace art</span><br><span class="line"></span><br><span class="line">#endif  // ART_LIBDEXFILE_DEX_ART_DEX_FILE_LOADER_H_</span><br></pre></td></tr></table></figure>

<p>也是一个脱壳点 含有map的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Copyright (C) 2017 The Android Open Source Project</span><br><span class="line"> *</span><br><span class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> * you may not use this file except in compliance with the License.</span><br><span class="line"> * You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">#include &quot;art_dex_file_loader.h&quot;</span><br><span class="line"></span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;memory&gt;</span><br><span class="line"></span><br><span class="line">#include &quot;android-base/stringprintf.h&quot;</span><br><span class="line">#include &quot;base/file_magic.h&quot;</span><br><span class="line">#include &quot;base/file_utils.h&quot;</span><br><span class="line">#include &quot;base/logging.h&quot;</span><br><span class="line">#include &quot;base/mem_map.h&quot;</span><br><span class="line">#include &quot;base/mman.h&quot;  // For the PROT_* and MAP_* constants.</span><br><span class="line">#include &quot;base/stl_util.h&quot;</span><br><span class="line">#include &quot;base/systrace.h&quot;</span><br><span class="line">#include &quot;base/unix_file/fd_file.h&quot;</span><br><span class="line">#include &quot;base/zip_archive.h&quot;</span><br><span class="line">#include &quot;dex/compact_dex_file.h&quot;</span><br><span class="line">#include &quot;dex/dex_file.h&quot;</span><br><span class="line">#include &quot;dex/dex_file_verifier.h&quot;</span><br><span class="line">#include &quot;dex/standard_dex_file.h&quot;</span><br><span class="line"></span><br><span class="line">namespace art &#123;</span><br><span class="line"></span><br><span class="line">std::unique_ptr&lt;const DexFile&gt; ArtDexFileLoader::Open(</span><br><span class="line">    const uint8_t* base,</span><br><span class="line">    size_t size,</span><br><span class="line">    const std::string&amp; location,</span><br><span class="line">    uint32_t location_checksum,</span><br><span class="line">    const OatDexFile* oat_dex_file,</span><br><span class="line">    bool verify,</span><br><span class="line">    bool verify_checksum,</span><br><span class="line">    std::string* error_msg,</span><br><span class="line">    std::unique_ptr&lt;DexFileContainer&gt; container) const &#123;</span><br><span class="line">  return OpenCommon(base,</span><br><span class="line">                    size,</span><br><span class="line">                    /*data_base=*/nullptr,</span><br><span class="line">                    /*data_size=*/0,</span><br><span class="line">                    location,</span><br><span class="line">                    location_checksum,</span><br><span class="line">                    oat_dex_file,</span><br><span class="line">                    verify,</span><br><span class="line">                    verify_checksum,</span><br><span class="line">                    error_msg,</span><br><span class="line">                    std::move(container),</span><br><span class="line">                    /*verify_result=*/nullptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">std::unique_ptr&lt;const DexFile&gt; ArtDexFileLoader::Open(const std::string&amp; location,</span><br><span class="line">                                                      uint32_t location_checksum,</span><br><span class="line">                                                      MemMap&amp;&amp; mem_map,</span><br><span class="line">                                                      bool verify,</span><br><span class="line">                                                      bool verify_checksum,</span><br><span class="line">                                                      std::string* error_msg) const &#123;</span><br><span class="line">  ArtDexFileLoader loader(std::move(mem_map), location);</span><br><span class="line">  return loader.Open(location_checksum, verify, verify_checksum, error_msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool ArtDexFileLoader::Open(const char* filename,</span><br><span class="line">                            const std::string&amp; location,</span><br><span class="line">                            bool verify,</span><br><span class="line">                            bool verify_checksum,</span><br><span class="line">                            std::string* error_msg,</span><br><span class="line">                            std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt;* dex_files) const &#123;</span><br><span class="line">  ArtDexFileLoader loader(filename, location);</span><br><span class="line">  return loader.Open(verify, verify_checksum, error_msg, dex_files);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;  // namespace art</span><br></pre></td></tr></table></figure>

<p>opencommon也是脱壳点 含有size和begin</p>
<p>‍</p>
<p>‍</p>
<h1 id="dexclassloader源码"><a href="#dexclassloader源码" class="headerlink" title="dexclassloader源码"></a>dexclassloader源码</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Copyright (C) 2008 The Android Open Source Project</span><br><span class="line"> *</span><br><span class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> * you may not use this file except in compliance with the License.</span><br><span class="line"> * You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">package dalvik.system;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * A class loader that loads classes from &#123;@code .jar&#125; and &#123;@code .apk&#125; files</span><br><span class="line"> * containing a &#123;@code classes.dex&#125; entry. This can be used to execute code not</span><br><span class="line"> * installed as part of an application.</span><br><span class="line"> *</span><br><span class="line"> * &lt;p&gt;Prior to API level 26, this class loader requires an</span><br><span class="line"> * application-private, writable directory to cache optimized classes.</span><br><span class="line"> * Use &#123;@code Context.getCodeCacheDir()&#125; to create such a directory:</span><br><span class="line"> * &lt;pre&gt;   &#123;@code</span><br><span class="line"> *   File dexOutputDir = context.getCodeCacheDir();</span><br><span class="line"> * &#125;&lt;/pre&gt;</span><br><span class="line"> *</span><br><span class="line"> * &lt;p&gt;&lt;strong&gt;Do not cache optimized classes on external storage.&lt;/strong&gt;</span><br><span class="line"> * External storage does not provide access controls necessary to protect your</span><br><span class="line"> * application from code injection attacks.</span><br><span class="line"> */</span><br><span class="line">public class DexClassLoader extends BaseDexClassLoader &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Creates a &#123;@code DexClassLoader&#125; that finds interpreted and native</span><br><span class="line">     * code.  Interpreted classes are found in a set of DEX files contained</span><br><span class="line">     * in Jar or APK files.</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;The path lists are separated using the character specified by the</span><br><span class="line">     * &#123;@code path.separator&#125; system property, which defaults to &#123;@code :&#125;.</span><br><span class="line">     *</span><br><span class="line">     * @param dexPath the list of jar/apk files containing classes and</span><br><span class="line">     *     resources, delimited by &#123;@code File.pathSeparator&#125;, which</span><br><span class="line">     *     defaults to &#123;@code &quot;:&quot;&#125; on Android</span><br><span class="line">     * @param optimizedDirectory this parameter is deprecated and has no effect since API level 26.</span><br><span class="line">     * @param librarySearchPath the list of directories containing native</span><br><span class="line">     *     libraries, delimited by &#123;@code File.pathSeparator&#125;; may be</span><br><span class="line">     *     &#123;@code null&#125;</span><br><span class="line">     * @param parent the parent class loader</span><br><span class="line">     */</span><br><span class="line">    public DexClassLoader(String dexPath, String optimizedDirectory,</span><br><span class="line">            String librarySearchPath, ClassLoader parent) &#123;</span><br><span class="line">        super(dexPath, null, librarySearchPath, parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>父类四个参数的构造方法 继承basedexclassloader</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250920161914-br3fkyd.png" alt="image"></p>
<p>在这里使用pathlist构造方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Copyright (C) 2011 The Android Open Source Project</span><br><span class="line"> *</span><br><span class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> * you may not use this file except in compliance with the License.</span><br><span class="line"> * You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">package dalvik.system;</span><br><span class="line"></span><br><span class="line">import android.compat.annotation.UnsupportedAppUsage;</span><br><span class="line">import android.system.ErrnoException;</span><br><span class="line">import android.system.StructStat;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.lang.reflect.Array;</span><br><span class="line">import java.net.MalformedURLException;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.nio.ByteBuffer;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.Collection;</span><br><span class="line">import java.util.Collections;</span><br><span class="line">import java.util.Enumeration;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Objects;</span><br><span class="line">import libcore.io.ClassPathURLStreamHandler;</span><br><span class="line">import libcore.io.IoUtils;</span><br><span class="line">import libcore.io.Libcore;</span><br><span class="line"></span><br><span class="line">import static android.system.OsConstants.S_ISDIR;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * A pair of lists of entries, associated with a &#123;@code ClassLoader&#125;.</span><br><span class="line"> * One of the lists is a dex/resource path &amp;mdash; typically referred</span><br><span class="line"> * to as a &quot;class path&quot; &amp;mdash; list, and the other names directories</span><br><span class="line"> * containing native code libraries. Class path entries may be any of:</span><br><span class="line"> * a &#123;@code .jar&#125; or &#123;@code .zip&#125; file containing an optional</span><br><span class="line"> * top-level &#123;@code classes.dex&#125; file as well as arbitrary resources,</span><br><span class="line"> * or a plain &#123;@code .dex&#125; file (with no possibility of associated</span><br><span class="line"> * resources).</span><br><span class="line"> *</span><br><span class="line"> * &lt;p&gt;This class also contains methods to use these lists to look up</span><br><span class="line"> * classes and resources.&lt;/p&gt;</span><br><span class="line"> *</span><br><span class="line"> * @hide</span><br><span class="line"> */</span><br><span class="line">public final class DexPathList &#123;</span><br><span class="line">    private static final String DEX_SUFFIX = &quot;.dex&quot;;</span><br><span class="line">    private static final String zipSeparator = &quot;!/&quot;;</span><br><span class="line"></span><br><span class="line">    /** class definition context */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private final ClassLoader definingContext;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * List of dex/resource (class path) elements.</span><br><span class="line">     * Should be called pathElements, but the Facebook app uses reflection</span><br><span class="line">     * to modify &#x27;dexElements&#x27; (http://b/7726934).</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private Element[] dexElements;</span><br><span class="line"></span><br><span class="line">    /** List of native library path elements. */</span><br><span class="line">    // Some applications rely on this field being an array or we&#x27;d use a final list here</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    /* package visible for testing */ NativeLibraryElement[] nativeLibraryPathElements;</span><br><span class="line"></span><br><span class="line">    /** List of application native library directories. */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private final List&lt;File&gt; nativeLibraryDirectories;</span><br><span class="line"></span><br><span class="line">    /** List of system native library directories. */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private final List&lt;File&gt; systemNativeLibraryDirectories;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Exceptions thrown during creation of the dexElements list.</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private IOException[] dexElementsSuppressedExceptions;</span><br><span class="line"></span><br><span class="line">    private List&lt;File&gt; getAllNativeLibraryDirectories() &#123;</span><br><span class="line">        List&lt;File&gt; allNativeLibraryDirectories = new ArrayList&lt;&gt;(nativeLibraryDirectories);</span><br><span class="line">        allNativeLibraryDirectories.addAll(systemNativeLibraryDirectories);</span><br><span class="line">        return allNativeLibraryDirectories;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Construct an instance.</span><br><span class="line">     *</span><br><span class="line">     * @param definingContext the context in which any as-yet unresolved</span><br><span class="line">     * classes should be defined</span><br><span class="line">     *</span><br><span class="line">     * @param dexFiles the bytebuffers containing the dex files that we should load classes from.</span><br><span class="line">     */</span><br><span class="line">    public DexPathList(ClassLoader definingContext, String librarySearchPath) &#123;</span><br><span class="line">        if (definingContext == null) &#123;</span><br><span class="line">            throw new NullPointerException(&quot;definingContext == null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        this.definingContext = definingContext;</span><br><span class="line">        this.nativeLibraryDirectories = splitPaths(librarySearchPath, false);</span><br><span class="line">        this.systemNativeLibraryDirectories =</span><br><span class="line">                splitPaths(System.getProperty(&quot;java.library.path&quot;), true);</span><br><span class="line">        this.nativeLibraryPathElements = makePathElements(getAllNativeLibraryDirectories());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Constructs an instance.</span><br><span class="line">     *</span><br><span class="line">     * @param definingContext the context in which any as-yet unresolved</span><br><span class="line">     * classes should be defined</span><br><span class="line">     * @param dexPath list of dex/resource path elements, separated by</span><br><span class="line">     * &#123;@code File.pathSeparator&#125;</span><br><span class="line">     * @param librarySearchPath list of native library directory path elements,</span><br><span class="line">     * separated by &#123;@code File.pathSeparator&#125;</span><br><span class="line">     * @param optimizedDirectory directory where optimized &#123;@code .dex&#125; files</span><br><span class="line">     * should be found and written to, or &#123;@code null&#125; to use the default</span><br><span class="line">     * system directory for same</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    public DexPathList(ClassLoader definingContext, String dexPath,</span><br><span class="line">            String librarySearchPath, File optimizedDirectory) &#123;</span><br><span class="line">        this(definingContext, dexPath, librarySearchPath, optimizedDirectory, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DexPathList(ClassLoader definingContext, String dexPath,</span><br><span class="line">            String librarySearchPath, File optimizedDirectory, boolean isTrusted) &#123;</span><br><span class="line">        if (definingContext == null) &#123;</span><br><span class="line">            throw new NullPointerException(&quot;definingContext == null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (dexPath == null) &#123;</span><br><span class="line">            throw new NullPointerException(&quot;dexPath == null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (optimizedDirectory != null) &#123;</span><br><span class="line">            if (!optimizedDirectory.exists())  &#123;</span><br><span class="line">                throw new IllegalArgumentException(</span><br><span class="line">                        &quot;optimizedDirectory doesn&#x27;t exist: &quot;</span><br><span class="line">                        + optimizedDirectory);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!(optimizedDirectory.canRead()</span><br><span class="line">                            &amp;&amp; optimizedDirectory.canWrite())) &#123;</span><br><span class="line">                throw new IllegalArgumentException(</span><br><span class="line">                        &quot;optimizedDirectory not readable/writable: &quot;</span><br><span class="line">                        + optimizedDirectory);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        this.definingContext = definingContext;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;IOException&gt; suppressedExceptions = new ArrayList&lt;IOException&gt;();</span><br><span class="line">        // save dexPath for BaseDexClassLoader</span><br><span class="line">        this.dexElements = makeDexElements(splitDexPath(dexPath), optimizedDirectory,</span><br><span class="line">                                           suppressedExceptions, definingContext, isTrusted);</span><br><span class="line"></span><br><span class="line">        // Native libraries may exist in both the system and</span><br><span class="line">        // application library paths, and we use this search order:</span><br><span class="line">        //</span><br><span class="line">        //   1. This class loader&#x27;s library path for application libraries (librarySearchPath):</span><br><span class="line">        //   1.1. Native library directories</span><br><span class="line">        //   1.2. Path to libraries in apk-files</span><br><span class="line">        //   2. The VM&#x27;s library path from the system property for system libraries</span><br><span class="line">        //      also known as java.library.path</span><br><span class="line">        //</span><br><span class="line">        // This order was reversed prior to Gingerbread; see http://b/2933456.</span><br><span class="line">        this.nativeLibraryDirectories = splitPaths(librarySearchPath, false);</span><br><span class="line">        this.systemNativeLibraryDirectories =</span><br><span class="line">                splitPaths(System.getProperty(&quot;java.library.path&quot;), true);</span><br><span class="line">        this.nativeLibraryPathElements = makePathElements(getAllNativeLibraryDirectories());</span><br><span class="line"></span><br><span class="line">        if (suppressedExceptions.size() &gt; 0) &#123;</span><br><span class="line">            this.dexElementsSuppressedExceptions =</span><br><span class="line">                suppressedExceptions.toArray(new IOException[suppressedExceptions.size()]);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            dexElementsSuppressedExceptions = null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override public String toString() &#123;</span><br><span class="line">        return &quot;DexPathList[&quot; + Arrays.toString(dexElements) +</span><br><span class="line">            &quot;,nativeLibraryDirectories=&quot; +</span><br><span class="line">            Arrays.toString(getAllNativeLibraryDirectories().toArray()) + &quot;]&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * For BaseDexClassLoader.getLdLibraryPath.</span><br><span class="line">     */</span><br><span class="line">    public List&lt;File&gt; getNativeLibraryDirectories() &#123;</span><br><span class="line">        return nativeLibraryDirectories;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Adds a new path to this instance</span><br><span class="line">     * @param dexPath list of dex/resource path element, separated by</span><br><span class="line">     * &#123;@code File.pathSeparator&#125;</span><br><span class="line">     * @param optimizedDirectory directory where optimized &#123;@code .dex&#125; files</span><br><span class="line">     * should be found and written to, or &#123;@code null&#125; to use the default</span><br><span class="line">     * system directory for same</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    public void addDexPath(String dexPath, File optimizedDirectory) &#123;</span><br><span class="line">      addDexPath(dexPath, optimizedDirectory, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void addDexPath(String dexPath, File optimizedDirectory, boolean isTrusted) &#123;</span><br><span class="line">        final List&lt;IOException&gt; suppressedExceptionList = new ArrayList&lt;IOException&gt;();</span><br><span class="line">        final Element[] newElements = makeDexElements(splitDexPath(dexPath), optimizedDirectory,</span><br><span class="line">                suppressedExceptionList, definingContext, isTrusted);</span><br><span class="line"></span><br><span class="line">        if (newElements != null &amp;&amp; newElements.length &gt; 0) &#123;</span><br><span class="line">            dexElements = concat(Element.class, dexElements, newElements);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (suppressedExceptionList.size() &gt; 0) &#123;</span><br><span class="line">            final IOException[] newSuppExceptions = suppressedExceptionList.toArray(</span><br><span class="line">                    new IOException[suppressedExceptionList.size()]);</span><br><span class="line">            dexElementsSuppressedExceptions = dexElementsSuppressedExceptions != null</span><br><span class="line">                    ? concat(IOException.class, dexElementsSuppressedExceptions, newSuppExceptions)</span><br><span class="line">                    : newSuppExceptions;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static&lt;T&gt; T[] concat(Class&lt;T&gt; componentType, T[] inputA, T[] inputB) &#123;</span><br><span class="line">        T[] output = (T[]) Array.newInstance(componentType, inputA.length + inputB.length);</span><br><span class="line">        System.arraycopy(inputA, 0, output, 0, inputA.length);</span><br><span class="line">        System.arraycopy(inputB, 0, output, inputA.length, inputB.length);</span><br><span class="line">        return output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * For InMemoryDexClassLoader. Initializes &#123;@code dexElements&#125; with dex files</span><br><span class="line">     * loaded from &#123;@code dexFiles&#125; buffers.</span><br><span class="line">     *</span><br><span class="line">     * @param dexFiles ByteBuffers containing raw dex data. Apks are not supported.</span><br><span class="line">     */</span><br><span class="line">    /* package */ void initByteBufferDexPath(ByteBuffer[] dexFiles) &#123;</span><br><span class="line">        if (dexFiles == null) &#123;</span><br><span class="line">            throw new NullPointerException(&quot;dexFiles == null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (Arrays.stream(dexFiles).anyMatch(v -&gt; v == null)) &#123;</span><br><span class="line">            throw new NullPointerException(&quot;dexFiles contains a null Buffer!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (dexElements != null || dexElementsSuppressedExceptions != null) &#123;</span><br><span class="line">            throw new IllegalStateException(&quot;Should only be called once&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        final List&lt;IOException&gt; suppressedExceptions = new ArrayList&lt;IOException&gt;();</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            Element[] null_elements = null;</span><br><span class="line">            DexFile dex = new DexFile(dexFiles, definingContext, null_elements);</span><br><span class="line">            dexElements = new Element[] &#123; new Element(dex) &#125;;</span><br><span class="line">        &#125; catch (IOException suppressed) &#123;</span><br><span class="line">            System.logE(&quot;Unable to load dex files&quot;, suppressed);</span><br><span class="line">            suppressedExceptions.add(suppressed);</span><br><span class="line">            dexElements = new Element[0];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (suppressedExceptions.size() &gt; 0) &#123;</span><br><span class="line">            dexElementsSuppressedExceptions = suppressedExceptions.toArray(</span><br><span class="line">                    new IOException[suppressedExceptions.size()]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /* package */ void maybeRunBackgroundVerification(ClassLoader loader) &#123;</span><br><span class="line">        // Spawn background thread to verify all classes and cache verification results.</span><br><span class="line">        // Must be called *after* `this.dexElements` has been initialized and `loader.pathList`</span><br><span class="line">        // has been set for ART to find its classes (the fields are hardcoded in ART and dex</span><br><span class="line">        // files iterated over in the order of the array).</span><br><span class="line">        // We only spawn the background thread if the bytecode is not backed by an oat</span><br><span class="line">        // file, i.e. this is the first time this bytecode is being loaded and/or</span><br><span class="line">        // verification results have not been cached yet.</span><br><span class="line">        for (Element element : dexElements) &#123;</span><br><span class="line">            if (element.dexFile != null &amp;&amp; !element.dexFile.isBackedByOatFile()) &#123;</span><br><span class="line">                element.dexFile.verifyInBackground(loader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Splits the given dex path string into elements using the path</span><br><span class="line">     * separator, pruning out any elements that do not refer to existing</span><br><span class="line">     * and readable files.</span><br><span class="line">     */</span><br><span class="line">    private static List&lt;File&gt; splitDexPath(String path) &#123;</span><br><span class="line">        return splitPaths(path, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Splits the given path strings into file elements using the path</span><br><span class="line">     * separator, combining the results and filtering out elements</span><br><span class="line">     * that don&#x27;t exist, aren&#x27;t readable, or aren&#x27;t either a regular</span><br><span class="line">     * file or a directory (as specified). Either string may be empty</span><br><span class="line">     * or &#123;@code null&#125;, in which case it is ignored. If both strings</span><br><span class="line">     * are empty or &#123;@code null&#125;, or all elements get pruned out, then</span><br><span class="line">     * this returns a zero-element list.</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private static List&lt;File&gt; splitPaths(String searchPath, boolean directoriesOnly) &#123;</span><br><span class="line">        List&lt;File&gt; result = new ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        if (searchPath != null) &#123;</span><br><span class="line">            for (String path : searchPath.split(File.pathSeparator)) &#123;</span><br><span class="line">                if (directoriesOnly) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        StructStat sb = Libcore.os.stat(path);</span><br><span class="line">                        if (!S_ISDIR(sb.st_mode)) &#123;</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; catch (ErrnoException ignored) &#123;</span><br><span class="line">                        continue;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                result.add(new File(path));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // This method is not used anymore. Kept around only because there are many legacy users of it.</span><br><span class="line">    @SuppressWarnings(&quot;unused&quot;)</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    public static Element[] makeInMemoryDexElements(ByteBuffer[] dexFiles,</span><br><span class="line">            List&lt;IOException&gt; suppressedExceptions) &#123;</span><br><span class="line">        Element[] elements = new Element[dexFiles.length];</span><br><span class="line">        int elementPos = 0;</span><br><span class="line">        for (ByteBuffer buf : dexFiles) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                DexFile dex = new DexFile(new ByteBuffer[] &#123; buf &#125;, /* classLoader */ null,</span><br><span class="line">                        /* dexElements */ null);</span><br><span class="line">                elements[elementPos++] = new Element(dex);</span><br><span class="line">            &#125; catch (IOException suppressed) &#123;</span><br><span class="line">                System.logE(&quot;Unable to load dex file: &quot; + buf, suppressed);</span><br><span class="line">                suppressedExceptions.add(suppressed);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (elementPos != elements.length) &#123;</span><br><span class="line">            elements = Arrays.copyOf(elements, elementPos);</span><br><span class="line">        &#125;</span><br><span class="line">        return elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Makes an array of dex/resource path elements, one per element of</span><br><span class="line">     * the given array.</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private static Element[] makeDexElements(List&lt;File&gt; files, File optimizedDirectory,</span><br><span class="line">            List&lt;IOException&gt; suppressedExceptions, ClassLoader loader) &#123;</span><br><span class="line">        return makeDexElements(files, optimizedDirectory, suppressedExceptions, loader, false);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private static Element[] makeDexElements(List&lt;File&gt; files, File optimizedDirectory,</span><br><span class="line">            List&lt;IOException&gt; suppressedExceptions, ClassLoader loader, boolean isTrusted) &#123;</span><br><span class="line">      Element[] elements = new Element[files.size()];</span><br><span class="line">      int elementsPos = 0;</span><br><span class="line">      /*</span><br><span class="line">       * Open all files and load the (direct or contained) dex files up front.</span><br><span class="line">       */</span><br><span class="line">      for (File file : files) &#123;</span><br><span class="line">          if (file.isDirectory()) &#123;</span><br><span class="line">              // We support directories for looking up resources. Looking up resources in</span><br><span class="line">              // directories is useful for running libcore tests.</span><br><span class="line">              elements[elementsPos++] = new Element(file);</span><br><span class="line">          &#125; else if (file.isFile()) &#123;</span><br><span class="line">              String name = file.getName();</span><br><span class="line"></span><br><span class="line">              DexFile dex = null;</span><br><span class="line">              if (name.endsWith(DEX_SUFFIX)) &#123;</span><br><span class="line">                  // Raw dex file (not inside a zip/jar).</span><br><span class="line">                  try &#123;</span><br><span class="line">                      dex = loadDexFile(file, optimizedDirectory, loader, elements);</span><br><span class="line">                      if (dex != null) &#123;</span><br><span class="line">                          elements[elementsPos++] = new Element(dex, null);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; catch (IOException suppressed) &#123;</span><br><span class="line">                      System.logE(&quot;Unable to load dex file: &quot; + file, suppressed);</span><br><span class="line">                      suppressedExceptions.add(suppressed);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  try &#123;</span><br><span class="line">                      dex = loadDexFile(file, optimizedDirectory, loader, elements);</span><br><span class="line">                  &#125; catch (IOException suppressed) &#123;</span><br><span class="line">                      /*</span><br><span class="line">                       * IOException might get thrown &quot;legitimately&quot; by the DexFile constructor if</span><br><span class="line">                       * the zip file turns out to be resource-only (that is, no classes.dex file</span><br><span class="line">                       * in it).</span><br><span class="line">                       * Let dex == null and hang on to the exception to add to the tea-leaves for</span><br><span class="line">                       * when findClass returns null.</span><br><span class="line">                       */</span><br><span class="line">                      suppressedExceptions.add(suppressed);</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  if (dex == null) &#123;</span><br><span class="line">                      elements[elementsPos++] = new Element(file);</span><br><span class="line">                  &#125; else &#123;</span><br><span class="line">                      elements[elementsPos++] = new Element(dex, file);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              if (dex != null &amp;&amp; isTrusted) &#123;</span><br><span class="line">                dex.setTrusted();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">              System.logW(&quot;ClassLoader referenced unknown path: &quot; + file);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (elementsPos != elements.length) &#123;</span><br><span class="line">          elements = Arrays.copyOf(elements, elementsPos);</span><br><span class="line">      &#125;</span><br><span class="line">      return elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Constructs a &#123;@code DexFile&#125; instance, as appropriate depending on whether</span><br><span class="line">     * &#123;@code optimizedDirectory&#125; is &#123;@code null&#125;. An application image file may be associated with</span><br><span class="line">     * the &#123;@code loader&#125; if it is not null.</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private static DexFile loadDexFile(File file, File optimizedDirectory, ClassLoader loader,</span><br><span class="line">                                       Element[] elements)</span><br><span class="line">            throws IOException &#123;</span><br><span class="line">        if (optimizedDirectory == null) &#123;</span><br><span class="line">            return new DexFile(file, loader, elements);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            String optimizedPath = optimizedPathFor(file, optimizedDirectory);</span><br><span class="line">            return DexFile.loadDex(file.getPath(), optimizedPath, 0, loader, elements);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Converts a dex/jar file path and an output directory to an</span><br><span class="line">     * output file path for an associated optimized dex file.</span><br><span class="line">     */</span><br><span class="line">    private static String optimizedPathFor(File path,</span><br><span class="line">            File optimizedDirectory) &#123;</span><br><span class="line">        /*</span><br><span class="line">         * Get the filename component of the path, and replace the</span><br><span class="line">         * suffix with &quot;.dex&quot; if that&#x27;s not already the suffix.</span><br><span class="line">         *</span><br><span class="line">         * We don&#x27;t want to use &quot;.odex&quot;, because the build system uses</span><br><span class="line">         * that for files that are paired with resource-only jar</span><br><span class="line">         * files. If the VM can assume that there&#x27;s no classes.dex in</span><br><span class="line">         * the matching jar, it doesn&#x27;t need to open the jar to check</span><br><span class="line">         * for updated dependencies, providing a slight performance</span><br><span class="line">         * boost at startup. The use of &quot;.dex&quot; here matches the use on</span><br><span class="line">         * files in /data/dalvik-cache.</span><br><span class="line">         */</span><br><span class="line">        String fileName = path.getName();</span><br><span class="line">        if (!fileName.endsWith(DEX_SUFFIX)) &#123;</span><br><span class="line">            int lastDot = fileName.lastIndexOf(&quot;.&quot;);</span><br><span class="line">            if (lastDot &lt; 0) &#123;</span><br><span class="line">                fileName += DEX_SUFFIX;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                StringBuilder sb = new StringBuilder(lastDot + 4);</span><br><span class="line">                sb.append(fileName, 0, lastDot);</span><br><span class="line">                sb.append(DEX_SUFFIX);</span><br><span class="line">                fileName = sb.toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        File result = new File(optimizedDirectory, fileName);</span><br><span class="line">        return result.getPath();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">     * TODO (dimitry): Revert after apps stops relying on the existence of this</span><br><span class="line">     * method (see http://b/21957414 and http://b/26317852 for details)</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    @SuppressWarnings(&quot;unused&quot;)</span><br><span class="line">    private static Element[] makePathElements(List&lt;File&gt; files, File optimizedDirectory,</span><br><span class="line">            List&lt;IOException&gt; suppressedExceptions) &#123;</span><br><span class="line">        return makeDexElements(files, optimizedDirectory, suppressedExceptions, null);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Makes an array of directory/zip path elements for the native library search path, one per</span><br><span class="line">     * element of the given array.</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    private static NativeLibraryElement[] makePathElements(List&lt;File&gt; files) &#123;</span><br><span class="line">        NativeLibraryElement[] elements = new NativeLibraryElement[files.size()];</span><br><span class="line">        int elementsPos = 0;</span><br><span class="line">        for (File file : files) &#123;</span><br><span class="line">            String path = file.getPath();</span><br><span class="line"></span><br><span class="line">            if (path.contains(zipSeparator)) &#123;</span><br><span class="line">                String split[] = path.split(zipSeparator, 2);</span><br><span class="line">                File zip = new File(split[0]);</span><br><span class="line">                String dir = split[1];</span><br><span class="line">                elements[elementsPos++] = new NativeLibraryElement(zip, dir);</span><br><span class="line">            &#125; else if (file.isDirectory()) &#123;</span><br><span class="line">                // We support directories for looking up native libraries.</span><br><span class="line">                elements[elementsPos++] = new NativeLibraryElement(file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (elementsPos != elements.length) &#123;</span><br><span class="line">            elements = Arrays.copyOf(elements, elementsPos);</span><br><span class="line">        &#125;</span><br><span class="line">        return elements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Finds the named class in one of the dex files pointed at by</span><br><span class="line">     * this instance. This will find the one in the earliest listed</span><br><span class="line">     * path element. If the class is found but has not yet been</span><br><span class="line">     * defined, then this method will define it in the defining</span><br><span class="line">     * context that this instance was constructed with.</span><br><span class="line">     *</span><br><span class="line">     * @param name of class to find</span><br><span class="line">     * @param suppressed exceptions encountered whilst finding the class</span><br><span class="line">     * @return the named class or &#123;@code null&#125; if the class is not</span><br><span class="line">     * found in any of the dex files</span><br><span class="line">     */</span><br><span class="line">    public Class&lt;?&gt; findClass(String name, List&lt;Throwable&gt; suppressed) &#123;</span><br><span class="line">        for (Element element : dexElements) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = element.findClass(name, definingContext, suppressed);</span><br><span class="line">            if (clazz != null) &#123;</span><br><span class="line">                return clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (dexElementsSuppressedExceptions != null) &#123;</span><br><span class="line">            suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Finds the named resource in one of the zip/jar files pointed at</span><br><span class="line">     * by this instance. This will find the one in the earliest listed</span><br><span class="line">     * path element.</span><br><span class="line">     *</span><br><span class="line">     * @return a URL to the named resource or &#123;@code null&#125; if the</span><br><span class="line">     * resource is not found in any of the zip/jar files</span><br><span class="line">     */</span><br><span class="line">    public URL findResource(String name) &#123;</span><br><span class="line">        for (Element element : dexElements) &#123;</span><br><span class="line">            URL url = element.findResource(name);</span><br><span class="line">            if (url != null) &#123;</span><br><span class="line">                return url;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Finds all the resources with the given name, returning an</span><br><span class="line">     * enumeration of them. If there are no resources with the given</span><br><span class="line">     * name, then this method returns an empty enumeration.</span><br><span class="line">     */</span><br><span class="line">    public Enumeration&lt;URL&gt; findResources(String name) &#123;</span><br><span class="line">        ArrayList&lt;URL&gt; result = new ArrayList&lt;URL&gt;();</span><br><span class="line"></span><br><span class="line">        for (Element element : dexElements) &#123;</span><br><span class="line">            URL url = element.findResource(name);</span><br><span class="line">            if (url != null) &#123;</span><br><span class="line">                result.add(url);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return Collections.enumeration(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Finds the named native code library on any of the library</span><br><span class="line">     * directories pointed at by this instance. This will find the</span><br><span class="line">     * one in the earliest listed directory, ignoring any that are not</span><br><span class="line">     * readable regular files.</span><br><span class="line">     *</span><br><span class="line">     * @return the complete path to the library or &#123;@code null&#125; if no</span><br><span class="line">     * library was found</span><br><span class="line">     */</span><br><span class="line">    public String findLibrary(String libraryName) &#123;</span><br><span class="line">        String fileName = System.mapLibraryName(libraryName);</span><br><span class="line"></span><br><span class="line">        for (NativeLibraryElement element : nativeLibraryPathElements) &#123;</span><br><span class="line">            String path = element.findNativeLibrary(fileName);</span><br><span class="line"></span><br><span class="line">            if (path != null) &#123;</span><br><span class="line">                return path;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Returns the list of all individual dex files paths from the current list.</span><br><span class="line">     * The list will contain only file paths (i.e. no directories).</span><br><span class="line">     */</span><br><span class="line">    /*package*/ List&lt;String&gt; getDexPaths() &#123;</span><br><span class="line">        List&lt;String&gt; dexPaths = new ArrayList&lt;String&gt;();</span><br><span class="line">        for (Element e : dexElements) &#123;</span><br><span class="line">            String dexPath = e.getDexPath();</span><br><span class="line">            if (dexPath != null) &#123;</span><br><span class="line">                // Add the element to the list only if it is a file. A null dex path signals the</span><br><span class="line">                // element is a resource directory or an in-memory dex file.</span><br><span class="line">                dexPaths.add(dexPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return dexPaths;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Adds a collection of library paths from which to load native libraries. Paths can be absolute</span><br><span class="line">     * native library directories (i.e. /data/app/foo/lib/arm64) or apk references (i.e.</span><br><span class="line">     * /data/app/foo/base.apk!/lib/arm64).</span><br><span class="line">     *</span><br><span class="line">     * Note: This method will attempt to dedupe elements.</span><br><span class="line">     * Note: This method replaces the value of &#123;@link #nativeLibraryPathElements&#125;</span><br><span class="line">     */</span><br><span class="line">    @UnsupportedAppUsage</span><br><span class="line">    public void addNativePath(Collection&lt;String&gt; libPaths) &#123;</span><br><span class="line">        if (libPaths.isEmpty()) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;File&gt; libFiles = new ArrayList&lt;&gt;(libPaths.size());</span><br><span class="line">        for (String path : libPaths) &#123;</span><br><span class="line">            libFiles.add(new File(path));</span><br><span class="line">        &#125;</span><br><span class="line">        ArrayList&lt;NativeLibraryElement&gt; newPaths =</span><br><span class="line">                new ArrayList&lt;&gt;(nativeLibraryPathElements.length + libPaths.size());</span><br><span class="line">        newPaths.addAll(Arrays.asList(nativeLibraryPathElements));</span><br><span class="line">        for (NativeLibraryElement element : makePathElements(libFiles)) &#123;</span><br><span class="line">            if (!newPaths.contains(element)) &#123;</span><br><span class="line">                newPaths.add(element);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        nativeLibraryPathElements = newPaths.toArray(new NativeLibraryElement[newPaths.size()]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Element of the dex/resource path. Note: should be called DexElement, but apps reflect on</span><br><span class="line">     * this.</span><br><span class="line">     */</span><br><span class="line">    /*package*/ static class Element &#123;</span><br><span class="line">        /**</span><br><span class="line">         * A file denoting a zip file (in case of a resource jar or a dex jar), or a directory</span><br><span class="line">         * (only when dexFile is null).</span><br><span class="line">         */</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        private final File path;</span><br><span class="line">        /** Whether &#123;@code path.isDirectory()&#125;, or &#123;@code null&#125; if &#123;@code path == null&#125;. */</span><br><span class="line">        private final Boolean pathIsDirectory;</span><br><span class="line"></span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        private final DexFile dexFile;</span><br><span class="line"></span><br><span class="line">        private ClassPathURLStreamHandler urlHandler;</span><br><span class="line">        private boolean initialized;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * Element encapsulates a dex file. This may be a plain dex file (in which case dexZipPath</span><br><span class="line">         * should be null), or a jar (in which case dexZipPath should denote the zip file).</span><br><span class="line">         */</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        public Element(DexFile dexFile, File dexZipPath) &#123;</span><br><span class="line">            if (dexFile == null &amp;&amp; dexZipPath == null) &#123;</span><br><span class="line">                throw new NullPointerException(&quot;Either dexFile or path must be non-null&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            this.dexFile = dexFile;</span><br><span class="line">            this.path = dexZipPath;</span><br><span class="line">            // Do any I/O in the constructor so we don&#x27;t have to do it elsewhere, eg. toString().</span><br><span class="line">            this.pathIsDirectory = (path == null) ? null : path.isDirectory();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Element(DexFile dexFile) &#123;</span><br><span class="line">            this(dexFile, null);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Element(File path) &#123;</span><br><span class="line">            this(null, path);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * Constructor for a bit of backwards compatibility. Some apps use reflection into</span><br><span class="line">         * internal APIs. Warn, and emulate old behavior if we can. See b/33399341.</span><br><span class="line">         *</span><br><span class="line">         * @deprecated The Element class has been split. Use new Element constructors for</span><br><span class="line">         *             classes and resources, and NativeLibraryElement for the library</span><br><span class="line">         *             search path.</span><br><span class="line">         */</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        @Deprecated</span><br><span class="line">        public Element(File dir, boolean isDirectory, File zip, DexFile dexFile) &#123;</span><br><span class="line">            this(dir != null ? null : dexFile, dir != null ? dir : zip);</span><br><span class="line">            System.err.println(&quot;Warning: Using deprecated Element constructor. Do not use internal&quot;</span><br><span class="line">                    + &quot; APIs, this constructor will be removed in the future.&quot;);</span><br><span class="line">            if (dir != null &amp;&amp; (zip != null || dexFile != null)) &#123;</span><br><span class="line">                throw new IllegalArgumentException(&quot;Using dir and zip|dexFile no longer&quot;</span><br><span class="line">                        + &quot; supported.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            if (isDirectory &amp;&amp; (zip != null || dexFile != null)) &#123;</span><br><span class="line">                throw new IllegalArgumentException(&quot;Unsupported argument combination.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">         * Returns the dex path of this element or null if the element refers to a directory.</span><br><span class="line">         */</span><br><span class="line">        private String getDexPath() &#123;</span><br><span class="line">            if (path != null) &#123;</span><br><span class="line">                return path.isDirectory() ? null : path.getAbsolutePath();</span><br><span class="line">            &#125; else if (dexFile != null) &#123;</span><br><span class="line">                // DexFile.getName() returns the path of the dex file.</span><br><span class="line">                return dexFile.getName();</span><br><span class="line">            &#125;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public String toString() &#123;</span><br><span class="line">            if (dexFile == null) &#123;</span><br><span class="line">              return (pathIsDirectory ? &quot;directory \&quot;&quot; : &quot;zip file \&quot;&quot;) + path + &quot;\&quot;&quot;;</span><br><span class="line">            &#125; else if (path == null) &#123;</span><br><span class="line">              return &quot;dex file \&quot;&quot; + dexFile + &quot;\&quot;&quot;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              return &quot;zip file \&quot;&quot; + path + &quot;\&quot;&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public synchronized void maybeInit() &#123;</span><br><span class="line">            if (initialized) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (path == null || pathIsDirectory) &#123;</span><br><span class="line">                initialized = true;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                // Disable zip path validation for loading APKs as it does not pose a risk of the</span><br><span class="line">                // zip path traversal vulnerability.</span><br><span class="line">                urlHandler = new ClassPathURLStreamHandler(path.getPath(),</span><br><span class="line">                        /* enableZipPathValidator */ false);</span><br><span class="line">            &#125; catch (IOException ioe) &#123;</span><br><span class="line">                /*</span><br><span class="line">                 * Note: ZipException (a subclass of IOException)</span><br><span class="line">                 * might get thrown by the ZipFile constructor</span><br><span class="line">                 * (e.g. if the file isn&#x27;t actually a zip/jar</span><br><span class="line">                 * file).</span><br><span class="line">                 */</span><br><span class="line">                System.logE(&quot;Unable to open zip file: &quot; + path, ioe);</span><br><span class="line">                urlHandler = null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Mark this element as initialized only after we&#x27;ve successfully created</span><br><span class="line">            // the associated ClassPathURLStreamHandler. That way, we won&#x27;t leave this</span><br><span class="line">            // element in an inconsistent state if an exception is thrown during initialization.</span><br><span class="line">            //</span><br><span class="line">            // See b/35633614.</span><br><span class="line">            initialized = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Class&lt;?&gt; findClass(String name, ClassLoader definingContext,</span><br><span class="line">                List&lt;Throwable&gt; suppressed) &#123;</span><br><span class="line">            return dexFile != null ? dexFile.loadClassBinaryName(name, definingContext, suppressed)</span><br><span class="line">                    : null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public URL findResource(String name) &#123;</span><br><span class="line">            maybeInit();</span><br><span class="line"></span><br><span class="line">            if (urlHandler != null) &#123;</span><br><span class="line">              return urlHandler.getEntryUrlOrNull(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // We support directories so we can run tests and/or legacy code</span><br><span class="line">            // that uses Class.getResource.</span><br><span class="line">            if (path != null &amp;&amp; path.isDirectory()) &#123;</span><br><span class="line">                File resourceFile = new File(path, name);</span><br><span class="line">                if (resourceFile.exists()) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        return resourceFile.toURI().toURL();</span><br><span class="line">                    &#125; catch (MalformedURLException ex) &#123;</span><br><span class="line">                        throw new RuntimeException(ex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Element of the native library path</span><br><span class="line">     */</span><br><span class="line">    /*package*/ static class NativeLibraryElement &#123;</span><br><span class="line">        /**</span><br><span class="line">         * A file denoting a directory or zip file.</span><br><span class="line">         */</span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        private final File path;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * If path denotes a zip file, this denotes a base path inside the zip.</span><br><span class="line">         */</span><br><span class="line">        private final String zipDir;</span><br><span class="line"></span><br><span class="line">        private ClassPathURLStreamHandler urlHandler;</span><br><span class="line">        private boolean initialized;</span><br><span class="line"></span><br><span class="line">        @UnsupportedAppUsage</span><br><span class="line">        public NativeLibraryElement(File dir) &#123;</span><br><span class="line">            this.path = dir;</span><br><span class="line">            this.zipDir = null;</span><br><span class="line"></span><br><span class="line">            // We should check whether path is a directory, but that is non-eliminatable overhead.</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public NativeLibraryElement(File zip, String zipDir) &#123;</span><br><span class="line">            this.path = zip;</span><br><span class="line">            this.zipDir = zipDir;</span><br><span class="line"></span><br><span class="line">            // Simple check that should be able to be eliminated by inlining. We should also</span><br><span class="line">            // check whether path is a file, but that is non-eliminatable overhead.</span><br><span class="line">            if (zipDir == null) &#123;</span><br><span class="line">              throw new IllegalArgumentException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public String toString() &#123;</span><br><span class="line">            if (zipDir == null) &#123;</span><br><span class="line">                return &quot;directory \&quot;&quot; + path + &quot;\&quot;&quot;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return &quot;zip file \&quot;&quot; + path + &quot;\&quot;&quot; +</span><br><span class="line">                  (!zipDir.isEmpty() ? &quot;, dir \&quot;&quot; + zipDir + &quot;\&quot;&quot; : &quot;&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public synchronized void maybeInit() &#123;</span><br><span class="line">            if (initialized) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (zipDir == null) &#123;</span><br><span class="line">                initialized = true;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                // Disable zip path validation for loading APKs as it does not pose a risk of the</span><br><span class="line">                // zip path traversal vulnerability.</span><br><span class="line">                urlHandler = new ClassPathURLStreamHandler(path.getPath(),</span><br><span class="line">                        /* enableZipPathValidator */ false);</span><br><span class="line">            &#125; catch (IOException ioe) &#123;</span><br><span class="line">                /*</span><br><span class="line">                 * Note: ZipException (a subclass of IOException)</span><br><span class="line">                 * might get thrown by the ZipFile constructor</span><br><span class="line">                 * (e.g. if the file isn&#x27;t actually a zip/jar</span><br><span class="line">                 * file).</span><br><span class="line">                 */</span><br><span class="line">                System.logE(&quot;Unable to open zip file: &quot; + path, ioe);</span><br><span class="line">                urlHandler = null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // Mark this element as initialized only after we&#x27;ve successfully created</span><br><span class="line">            // the associated ClassPathURLStreamHandler. That way, we won&#x27;t leave this</span><br><span class="line">            // element in an inconsistent state if an exception is thrown during initialization.</span><br><span class="line">            //</span><br><span class="line">            // See b/35633614.</span><br><span class="line">            initialized = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public String findNativeLibrary(String name) &#123;</span><br><span class="line">            maybeInit();</span><br><span class="line"></span><br><span class="line">            if (zipDir == null) &#123;</span><br><span class="line">                String entryPath = new File(path, name).getPath();</span><br><span class="line">                if (IoUtils.canOpenReadOnly(entryPath)) &#123;</span><br><span class="line">                    return entryPath;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (urlHandler != null) &#123;</span><br><span class="line">                // Having a urlHandler means the element has a zip file.</span><br><span class="line">                // In this case Android supports loading the library iff</span><br><span class="line">                // it is stored in the zip uncompressed.</span><br><span class="line">                String entryName = zipDir + &#x27;/&#x27; + name;</span><br><span class="line">                if (urlHandler.isEntryStored(entryName)) &#123;</span><br><span class="line">                  return path.getPath() + zipSeparator + entryName;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public boolean equals(Object o) &#123;</span><br><span class="line">            if (this == o) return true;</span><br><span class="line">            if (!(o instanceof NativeLibraryElement)) return false;</span><br><span class="line">            NativeLibraryElement that = (NativeLibraryElement) o;</span><br><span class="line">            return Objects.equals(path, that.path) &amp;&amp;</span><br><span class="line">                    Objects.equals(zipDir, that.zipDir);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public int hashCode() &#123;</span><br><span class="line">            return Objects.hash(path, zipDir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250920162018-pxzm42f.png" alt="image"></p>
<p>判断dex的格式加载 </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250920162559-6rhv7j9.png" alt="image"></p>
<p>跟进</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250920163025-3kragl1.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250920163018-oa9gczz.png" alt="image"></p>
<p>inmemorydexclassloader走的上面的构造函数 dexclassloader走的下面的 之后的流程就和inmemorydexclassloader差不多了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">static jobject DexFile_openDexFileNative(JNIEnv* env,</span><br><span class="line">                                         jclass,</span><br><span class="line">                                         jstring javaSourceName,</span><br><span class="line">                                         [[maybe_unused]] jstring javaOutputName,</span><br><span class="line">                                         [[maybe_unused]] jint flags,</span><br><span class="line">                                         jobject class_loader,</span><br><span class="line">                                         jobjectArray dex_elements) &#123;</span><br><span class="line">  ScopedUtfChars sourceName(env, javaSourceName);</span><br><span class="line">  if (sourceName.c_str() == nullptr) &#123;</span><br><span class="line">    return nullptr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (isReadOnlyJavaDclChecked() &amp;&amp; access(sourceName.c_str(), W_OK) == 0) &#123;</span><br><span class="line">    LOG(ERROR) &lt;&lt; &quot;Attempt to load writable dex file: &quot; &lt;&lt; sourceName.c_str();</span><br><span class="line">    if (isReadOnlyJavaDclEnforced(env)) &#123;</span><br><span class="line">      ScopedLocalRef&lt;jclass&gt; se(env, env-&gt;FindClass(&quot;java/lang/SecurityException&quot;));</span><br><span class="line">      std::string message(</span><br><span class="line">          StringPrintf(&quot;Writable dex file &#x27;%s&#x27; is not allowed.&quot;, sourceName.c_str()));</span><br><span class="line">      env-&gt;ThrowNew(se.get(), message.c_str());</span><br><span class="line">      return nullptr;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  std::vector&lt;std::string&gt; error_msgs;</span><br><span class="line">  const OatFile* oat_file = nullptr;</span><br><span class="line">  std::vector&lt;std::unique_ptr&lt;const DexFile&gt;&gt; dex_files =</span><br><span class="line">      Runtime::Current()-&gt;GetOatFileManager().OpenDexFilesFromOat(sourceName.c_str(),</span><br><span class="line">                                                                  class_loader,</span><br><span class="line">                                                                  dex_elements,</span><br><span class="line">                                                                  /*out*/ &amp;oat_file,</span><br><span class="line">                                                                  /*out*/ &amp;error_msgs);</span><br><span class="line">  return CreateCookieFromOatFileManagerResult(env, dex_files, oat_file, error_msgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进OpenDexFilesFromOat</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250920164459-q0rwg4m.png" alt="image"></p>
<p>参数和inmemorydexclassloader有点区别 inmemorydexclassloader第一个参数是map 在其中的oat在10以前是会进行使用也可以选择性禁用 但是在现在的安卓系统中的系统app还有oat 所以并没有进行删除</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250920165838-q0zskpu.png" alt="image"></p>
<p>接下来的内容和inmemorydexclassloader差不多</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250920170838-893alrv.png" alt="image"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250920171219-28mev57.png" alt="image"></p>
<p>openwithmagic也是早期脱壳点</p>
<p>‍</p>
<p>‍</p>
<h1 id="youpk整体脱壳原理"><a href="#youpk整体脱壳原理" class="headerlink" title="youpk整体脱壳原理"></a>youpk整体脱壳原理</h1><p><a target="_blank" rel="noopener" href="https://github.com/Youlor/unpacker/blob/master/android-7.1.2_r33/art/runtime/unpacker/unpacker.cc">unpacker&#x2F;android-7.1.2_r33&#x2F;art&#x2F;runtime&#x2F;unpacker&#x2F;unpacker.cc at master · Youlor&#x2F;unpacker</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250920172235-eoqzjvm.png" alt="image"></p>
<p>核心代码 获取到当前的现成 获取到classlinker 搞到dex对象内容 进行整体脱壳</p>
<p>‍</p>
<h1 id="fdex2脱壳原理"><a href="#fdex2脱壳原理" class="headerlink" title="fdex2脱壳原理"></a>fdex2脱壳原理</h1><p>早期针对一代壳的脱壳方案 也就是整体加固 但现在随着安卓的版本提高fdex2也就淡出视野</p>
<p>一步一步分析一下fdex2的代码 对后面学习安卓很有帮助</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public void handleLoadPackage(XC_LoadPackage.LoadPackageParam lpparam) throws Throwable &#123;</span><br><span class="line">        initRefect();</span><br><span class="line">        XposedBridge.log(&quot;目标包名：&quot;+ lpparam.packageName);</span><br><span class="line">        String str = &quot;java.lang.ClassLoader&quot;;</span><br><span class="line">        String str2 = &quot;loadClass&quot;;</span><br><span class="line">        final String packagename = &quot;com.jiongji.andriod.card&quot;;</span><br><span class="line"></span><br><span class="line">        //   protected Class&lt;?&gt; loadClass(String className, boolean resolve) throws ClassNotFoundException</span><br><span class="line">        if(lpparam.packageName.equals(packagename))&#123;</span><br><span class="line">            // public static Unhook findAndHookMethod(String var0, ClassLoader var1, String var2, Object... var3)</span><br><span class="line">            XposedHelpers.findAndHookMethod(str, lpparam.classLoader, str2, String.class, Boolean.TYPE, new XC_MethodHook() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    super.afterHookedMethod(param);</span><br><span class="line">                    //获取hook函数返回类</span><br><span class="line">                    Class cls = (Class) param.getResult();</span><br><span class="line">                    if(cls == null)&#123;</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    String name = cls.getName();</span><br><span class="line">                    XposedBridge.log(&quot;当前类名：&quot;+name);</span><br><span class="line">                    byte[] bArr = (byte[]) Dex_getBytes.invoke(getDex.invoke(cls,null)); //Class.getDex().getBytes()</span><br><span class="line">                    if(bArr == null) &#123;</span><br><span class="line">                        XposedBridge.log(&quot;数据为空，返回&quot;);</span><br><span class="line">                        return;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    XposedBridge.log(&quot;开始写数据&quot;);</span><br><span class="line">                    String dex_path = &quot;/data/data/&quot;+packagename+&quot;/&quot;+packagename+&quot;_&quot;+bArr.length+&quot;.dex&quot;;</span><br><span class="line">                    XposedBridge.log(dex_path);</span><br><span class="line">                    File file = new File(dex_path);</span><br><span class="line">                    if(file.exists())&#123;</span><br><span class="line">                        return;</span><br><span class="line">                    &#125;</span><br><span class="line">                    writeByte(bArr,file.getAbsolutePath());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                @Override</span><br><span class="line">                protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="line">                    super.beforeHookedMethod(param);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">public Dex getDex() &#123;</span><br><span class="line">    if (dexCache == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    return dexCache.getDex();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public byte[] getBytes() &#123;</span><br><span class="line">        ByteBuffer data = this.data.duplicate(); // positioned ByteBuffers aren&#x27;t thread safe</span><br><span class="line">        byte[] result = new byte[data.capacity()];</span><br><span class="line">        data.position(0);</span><br><span class="line">        data.get(result);</span><br><span class="line">        return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public void initRefect()&#123;</span><br><span class="line">       try &#123;</span><br><span class="line">           // public byte[] getBytes()</span><br><span class="line">           Dex = Class.forName(&quot;com.android.dex.Dex&quot;);</span><br><span class="line">           Dex_getBytes = Dex.getDeclaredMethod(&quot;getBytes&quot;,null);</span><br><span class="line">           // public Dex getDex()</span><br><span class="line">           getDex = Class.forName(&quot;java.lang.Class&quot;).getDeclaredMethod(&quot;getDex&quot;,null);</span><br><span class="line">       &#125; catch (ClassNotFoundException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; catch (NoSuchMethodException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String str = &quot;java.lang.ClassLoader&quot;;</span><br><span class="line">String str2 = &quot;loadClass&quot;;</span><br><span class="line">XposedHelpers.findAndHookMethod(str, lpparam.classLoader, str2, String.class, Boolean.TYPE, new XC_MethodHook() </span><br></pre></td></tr></table></figure>

<p>明确了要hook的类和对应的方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">byte[] bArr = (byte[]) Dex_getBytes.invoke(getDex.invoke(cls,null));</span><br></pre></td></tr></table></figure>

<p>使用了两次反射 第一次返回的是一个dex对象 再去使用Dex_getBytes获取到在内存中的信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dex_getBytes = Dex.getDeclaredMethod(&quot;getBytes&quot;,null);</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250429173618980.png" alt="image-20250429173618980"></p>
<p>这里就可以直接进行dex的内容写入了</p>
<p>整理一下流程 先去hook了java.lang.ClassLoader.loadclass 再去使用反射获取到对应的dex对象 再次反射搞到dex在内存中的信息 很直白的方法</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>这里之所以可以快速简洁的搞到内存中的内容 主要还是getBytes方法的好处 正常的脱壳往往是要查看内容的长度大小的</p>
<p>从源码来看可以避免fdex2的方式很多 比如显式加载我们使用forname的方法就可以直接防掉这个 当然 目前只考虑一代壳 也就是整体加固 其他的壳应该很轻松就可以薄纱fdex2</p>
<p>当然 从fdex2的源码来看 核心并不是hook了什么 而是getdex和getbyte这两个api 通过这两个快速的搞到内容 坏消息 7.1以上api没了</p>
<p>写一个简单的frida代码进行查看一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function check() &#123;</span><br><span class="line">    //com.android.dex.Dex</span><br><span class="line">    //java.lang.Class</span><br><span class="line">    console.log(&quot;yes1&quot;)</span><br><span class="line">    var dex=Java.use(&quot;java.lang.Class&quot;)</span><br><span class="line">    console.log(&quot;yes&quot;)</span><br><span class="line">    var getdex = dex.getDex</span><br><span class="line">    if (getdex == null)&#123;</span><br><span class="line">        console.log(&quot;fail&quot;)</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        console.log(getdex)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Java.perform(function()&#123;</span><br><span class="line">    check()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/../blogpic/image-20250429183012679.png" alt="image-20250429183012679"></p>
<p>GG</p>
<h2 id="frida脚本实现"><a href="#frida脚本实现" class="headerlink" title="frida脚本实现"></a>frida脚本实现</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">function check() &#123;</span><br><span class="line">    //com.android.dex.Dex</span><br><span class="line">    //java.lang.Class</span><br><span class="line">    console.log(&quot;yes1&quot;)</span><br><span class="line">    var dex=Java.use(&quot;java.lang.Class&quot;)</span><br><span class="line">    console.log(&quot;yes&quot;)</span><br><span class="line">    var getdex = dex.getDex</span><br><span class="line">    if (getdex == null)&#123;</span><br><span class="line">        console.log(&quot;fail&quot;)</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        console.log(getdex)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function fdex(classname)&#123;</span><br><span class="line">    Java.perform(function ()&#123;</span><br><span class="line">        Java.enumerateClassLoaderSync().forEach(function (loader)&#123;</span><br><span class="line">            try&#123;</span><br><span class="line">                var thisclass = loader.loadClass()</span><br><span class="line"></span><br><span class="line">                var dexobj = thisclass.getDex()</span><br><span class="line">                var dexbytearry=dexobj.getbyte()</span><br><span class="line"></span><br><span class="line">                var filepath=&quot;/sdcard/&quot;+classname+&quot;.dex&quot;</span><br><span class="line">                writefile(dexbytearry,filepath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;catch(e)&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function writefile(bytearry,filepath)&#123;</span><br><span class="line">    Java.perform(function()&#123;</span><br><span class="line">        var File=Java.use(&quot;java.io.File&quot;)</span><br><span class="line">        var fileoutstream =Java.use(&quot;java.io.FileOutputStream&quot;)</span><br><span class="line">        var fileobj = File.$new(filepath)</span><br><span class="line">        var filestream =fileoutstream.$new(fileobj)</span><br><span class="line">        filestream.write(bytearry)</span><br><span class="line">        filestream.close()</span><br><span class="line">        console.log(&quot;write over&quot;)</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个代码实现了主动的调用需要class所在的dex文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firda -FU -l hook.js --no-pause</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fdex(&quot;classname&quot;)</span><br></pre></td></tr></table></figure>

<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>‍</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./pic/Eau.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./pic/Eau.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">grand</div><div class="post-copyright__author_desc">萌新兼菜鸡</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://bygeee.github.io/2025/09/20/%E5%8A%A0%E5%9B%BA/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://bygeee.github.io/2025/09/20/%E5%8A%A0%E5%9B%BA/')">加固</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://bygeee.github.io/2025/09/20/%E5%8A%A0%E5%9B%BA/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=加固&amp;url=http://bygeee.github.io/2025/09/20/%E5%8A%A0%E5%9B%BA/&amp;pic=/./pic/12.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://bygeee.github.io" target="_blank">grand</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"></div></div></div><div class="post_share"><div class="social-share" data-image="/./pic/41.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/08/29/qiling-labs%E7%BB%83%E4%B9%A0/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./pic/38.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">qiling-labs练习</div></div></a></div><div class="next-post pull-right"><a href="/2025/10/12/%E7%BE%8A%E5%9F%8E%E6%9D%AF/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./pic/40.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">羊城杯</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./pic/Eau.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这里分享一些<b style="color:#fff">简单的技术</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/about"><h1 class="author-info__name">grand</h1><div class="author-info__desc">萌新兼菜鸡</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/bygeee?tab=repositories" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来看我的博客鸭~</div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://img02.anheyu.com/adminuploads/1/2022/09/11/631ddb7c9b250.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://img02.anheyu.com/adminuploads/1/2022/09/11/631ddeb0900b7.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A0%E5%9B%BA"><span class="toc-text">加固</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A0%E5%A3%B3app%E7%9A%84%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">加壳app的运行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">源码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E5%A3%B3app%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">加壳app运行流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA"><span class="toc-text">整体加固</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%90%BD%E5%9C%B0%E5%8A%A0%E8%BD%BD"><span class="toc-text">落地加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%8A%A0%E8%BD%BD"><span class="toc-text">内存加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#fart"><span class="toc-text">fart</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#blackdex"><span class="toc-text">blackdex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fdex2"><span class="toc-text">fdex2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#frida-dexdump"><span class="toc-text">frida-dexdump</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA"><span class="toc-text">抽取加固</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-text">类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="toc-text">类加载的时机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8-1"><span class="toc-text">类加载器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E5%9B%BA%E5%AF%B9hook%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-text">加固对hook的影响</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9Aapp%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">普通app运行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%9B%BAapp%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">加固app运行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%9B%BA%E5%AF%B9ClassLoader%E7%9A%84%E5%B8%B8%E8%A7%81%E4%BF%AE%E6%AD%A3%E6%96%B9%E5%BC%8F"><span class="toc-text">加固对ClassLoader的常见修正方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E5%85%A5ClassLoader"><span class="toc-text">插入ClassLoader</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2ClassLoader"><span class="toc-text">替换ClassLoader</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#art%E4%B8%8B%E7%9A%84%E5%B8%B8%E8%A7%81%E8%84%B1%E5%A3%B3%E7%82%B9"><span class="toc-text">art下的常见脱壳点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dex%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B"><span class="toc-text">dex的加载流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dex2oat%E7%9A%84%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B"><span class="toc-text">dex2oat的编译流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-text">类的加载和初始化流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E8%84%B1%E5%A3%B3%E7%82%B9"><span class="toc-text">函数执行过程中的脱壳点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#inmemorydexclassloader"><span class="toc-text">inmemorydexclassloader</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dexclassloader%E6%BA%90%E7%A0%81"><span class="toc-text">dexclassloader源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#youpk%E6%95%B4%E4%BD%93%E8%84%B1%E5%A3%B3%E5%8E%9F%E7%90%86"><span class="toc-text">youpk整体脱壳原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#fdex2%E8%84%B1%E5%A3%B3%E5%8E%9F%E7%90%86"><span class="toc-text">fdex2脱壳原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-text">思考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#frida%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0"><span class="toc-text">frida脚本实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-text"></span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/01/07/%E9%B8%BF%E8%92%99%E8%B0%83%E8%AF%95/" title="鸿蒙调试"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./pic/43.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="鸿蒙调试"/></a><div class="content"><a class="title" href="/2026/01/07/%E9%B8%BF%E8%92%99%E8%B0%83%E8%AF%95/" title="鸿蒙调试">鸿蒙调试</a><time datetime="2026-01-06T16:00:00.000Z" title="发表于 2026-01-07 00:00:00">2026-01-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/27/%E5%AE%89%E5%8D%93%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/" title="安卓源码编译"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./pic/42.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="安卓源码编译"/></a><div class="content"><a class="title" href="/2025/12/27/%E5%AE%89%E5%8D%93%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/" title="安卓源码编译">安卓源码编译</a><time datetime="2025-12-26T16:00:00.000Z" title="发表于 2025-12-27 00:00:00">2025-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/18/unidbg%E5%85%A5%E9%97%A8%E5%90%88%E9%9B%86/" title="unidbg入门合集"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./pic/41.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="unidbg入门合集"/></a><div class="content"><a class="title" href="/2025/12/18/unidbg%E5%85%A5%E9%97%A8%E5%90%88%E9%9B%86/" title="unidbg入门合集">unidbg入门合集</a><time datetime="2025-12-17T16:00:00.000Z" title="发表于 2025-12-18 00:00:00">2025-12-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/12/%E7%BE%8A%E5%9F%8E%E6%9D%AF/" title="羊城杯"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./pic/40.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="羊城杯"/></a><div class="content"><a class="title" href="/2025/10/12/%E7%BE%8A%E5%9F%8E%E6%9D%AF/" title="羊城杯">羊城杯</a><time datetime="2025-10-11T16:00:00.000Z" title="发表于 2025-10-12 00:00:00">2025-10-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/20/%E5%8A%A0%E5%9B%BA/" title="加固"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/./pic/12.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="加固"/></a><div class="content"><a class="title" href="/2025/09/20/%E5%8A%A0%E5%9B%BA/" title="加固">加固</a><time datetime="2025-09-19T16:00:00.000Z" title="发表于 2025-09-20 00:00:00">2025-09-20</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2026 By <a class="footer-bar-link" href="/" title="grand" target="_blank">grand</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">31</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">0</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 grand 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>